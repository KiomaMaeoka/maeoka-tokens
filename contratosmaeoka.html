<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contratação - Maeoka Engenharia</title>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #1a3a52;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1a3a52 0%, #2c5282 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 6px;
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: #38b2ac;
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .page {
            display: none;
            padding: 30px;
            min-height: 400px;
        }
        
        .page.active {
            display: block;
        }
        
        .page-title {
            font-size: 24px;
            color: #1a3a52;
            margin-bottom: 20px;
            text-align: center;
        }

        .service-item {
            background: #f8f9fa;
            border-left: 4px solid #1a3a52;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .service-description {
            font-weight: 600;
            color: #2c5282;
            margin-bottom: 8px;
        }
        
        .service-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .area-info {
            color: #666;
            font-size: 14px;
            flex: 1;
            margin-right: 10px;
        }
        
        .price {
            font-size: 18px;
            font-weight: bold;
            color: #1a3a52;
            text-align: right;
            flex-shrink: 0;
            min-width: 120px;
        }

        .total-section {
            background: linear-gradient(135deg, #e8f4f8 0%, #d6eaf8 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: center;
        }
        
        .total-price {
            font-size: 32px;
            font-weight: bold;
            color: #1a3a52;
            margin: 10px 0;
        }

        .payment-choice {
            background: white;
            border: 2px solid #e8f4f8;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .payment-choice:hover {
            border-color: #1a3a52;
            box-shadow: 0 2px 5px rgba(26, 58, 82, 0.1);
        }
        
        .payment-choice h4 {
            color: #1a3a52;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .content-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #38b2ac;
        }
        
        .cash-conditions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .token-section {
            background: #e8f4f8;
            border: 2px solid #1a3a52;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .conectado {
            background: #e6fffa;
            color: #38b2ac;
            border: 2px solid #38b2ac;
        }
        
        .desconectado {
            background: #fef2e7;
            color: #f6ad55;
            border: 2px solid #f6ad55;
        }
        
        .processando {
            background: #e8f4f8;
            color: #1a3a52;
            border: 2px solid #1a3a52;
        }
        
        .erro {
            background: #fef2f2;
            color: #dc2626;
            border: 2px solid #dc2626;
        }

        .botao {
            background: linear-gradient(135deg, #1a3a52 0%, #2c5282 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .botao:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 58, 82, 0.3);
        }
        
        .botao:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .back-btn {
            background: #6c757d;
            width: auto;
            min-width: 120px;
        }

        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a3a52;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8f4f8;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a3a52;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                font-size: 14px;
            }
            
            .container {
                margin: 5px auto;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .logo {
                font-size: 18px;
            }
            
            .subtitle {
                font-size: 10px;
            }
            
            .page {
                padding: 15px 10px;
            }
            
            .page-title {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .service-item {
                padding: 10px;
                margin: 10px 0;
            }
            
            .service-description {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            .service-details {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .area-info {
                font-size: 12px;
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .price {
                font-size: 14px;
                text-align: left;
                min-width: auto;
                width: 100%;
            }
            
            .total-section {
                padding: 15px;
                margin: 15px 0;
            }
            
            .total-price {
                font-size: 22px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .back-btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">MAEOKA ENGENHARIA</div>
            <div class="subtitle">CNPJ: 19.924.627/0001-67 • Eng. Kioma Maeoka (CREA 159.328/D-PR)</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 20%"></div>
            </div>
        </div>

        <!-- PÁGINA 1: PROPOSTA -->
        <div class="page active" id="page1">
            <h2 class="page-title">📋 CONTRATO DE PRESTAÇÃO DE SERVIÇO</h2>
            
            <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>Cliente:</strong> Thiago<br>
                <strong>Endereço da Obra:</strong> R. Eponino Macuco, 185 - Curitiba/PR<br>
                <strong>Data:</strong> <span id="currentDate"></span>
            </div>

            <h3 style="color: #1a3a52; margin: 25px 0 15px 0;">SERVIÇOS CONTRATADOS:</h3>
            
            <div class="service-item">
                <div class="service-description">Demolição - Remover Revestimento e Contra-Piso existente.</div>
                <div class="service-details">
                    <div class="area-info">Área: 100,93 m² • Com retirada de entulho até caçamba</div>
                    <div class="price">R$ 6.333,33</div>
                </div>
            </div>
            
            <div class="service-item">
                <div class="service-description">Regularização/nivelamento</div>
                <div class="service-details">
                    <div class="area-info">Argamassa de regularização e caimento para ralos (min. 1%)</div>
                    <div class="price">R$ 7.125,00</div>
                </div>
            </div>
            
            <div class="service-item">
                <div class="service-description">Aplicação de Primer e Manta asfáltica</div>
                <div class="service-details">
                    <div class="area-info">Nas áreas de recreação 1 e 2</div>
                    <div class="price">R$ 5.541,67</div>
                </div>
            </div>
            
            <div class="service-item">
                <div class="service-description">Executar Contrapiso</div>
                <div class="service-details">
                    <div class="area-info">Proteção mecânica - Argamassa de proteção de 3-5cm sobre a manta</div>
                    <div class="price">R$ 11.875,00</div>
                </div>
            </div>
            
            <div class="service-item">
                <div class="service-description">Instalar Revestimento Cerâmico/Porcelanato</div>
                <div class="service-details">
                    <div class="area-info">Nas áreas de recreação 1 e 2 (porcelanato até 90x90)</div>
                    <div class="price">R$ 7.125,00</div>
                </div>
            </div>

            <div style="text-align: center; margin: 15px 0; padding: 10px; background: #e8f4f8; border-radius: 8px; font-weight: bold; color: #2c5282;">
                SUBTOTAL SERVIÇOS: R$ 38.000,00 
            </div>

            <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #38b2ac;">
                <h4 style="color: #1a3a52; margin-bottom: 15px;">✅ SERVIÇOS INCLUSOS NO PROCESSO:</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                    <div style="background: white; padding: 10px; border-radius: 5px;">
                        <strong>📋 ART (Anotação de Responsabilidade Técnica)</strong><br>
                        <span style="color: #666; font-size: 12px;">Registro junto ao CREA-PR</span>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 5px;">
                        <strong>🏗️ Gerenciamento de Obra</strong><br>
                        <span style="color: #666; font-size: 12px;">Acompanhamento técnico completo</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px; padding: 8px; background: rgba(56, 178, 172, 0.1); border-radius: 5px; font-size: 13px; color: #2c5282;">
                    <strong>Estes serviços já estão inclusos no valor da proposta</strong>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4 style="color: #1a3a52; margin-bottom: 15px;">📦 MATERIAIS INCLUSOS:</h4>
                
                <div class="service-item" style="margin: 8px 0; border-left: 3px solid #2c5282;">
                    <div class="service-description" style="font-size: 14px;">Areia, cimento e brita</div>
                    <div class="area-info" style="font-size: 12px;">Para contrapiso e regularização</div>
                </div>
                
                <div class="service-item" style="margin: 8px 0; border-left: 3px solid #2c5282;">
                    <div class="service-description" style="font-size: 14px;">Manta asfáltica e primer</div>
                    <div class="area-info" style="font-size: 12px;">Cola, pregos para impermeabilização</div>
                </div>
                
                <div class="service-item" style="margin: 8px 0; border-left: 3px solid #2c5282;">
                    <div class="service-description" style="font-size: 14px;">Argamassa e espaçadores</div>
                    <div class="area-info" style="font-size: 12px;">Para assentamento de revestimento</div>
                </div>
                
                <div style="text-align: center; margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 8px; font-weight: bold; color: #2c5282;">
                    SUBTOTAL MATERIAIS: R$ 28.031,00 
                </div>
            </div>

            <div style="background: #f8f9fa; border-left: 4px solid #2c5282; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0;">
                <h3 style="color: #1a3a52; margin-bottom: 15px;">📄 CONCORDÂNCIA DE NOTA FISCAL</h3>
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="radio" name="invoiceOption" value="condominio" id="invoiceOptionCondominio" onchange="updateCalculations()" checked style="margin-right: 10px; transform: scale(1.2);">
                    Não será necessário nota fiscal, o condomínio fica a cargo deste item
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="invoiceOption" value="emitir" id="invoiceOptionEmitir" onchange="updateCalculations()" style="margin-right: 10px; transform: scale(1.2);">
                    Será necessário emitir nota fiscal (acréscimo de 17% sobre o valor final)
                </label>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                <div style="color: #666; font-size: 16px; text-decoration: line-through; margin-bottom: 10px;" id="originalPriceDisplay">
                    Total orçado: R$ 66.031,00
                </div>
                <div style="font-size: 28px; font-weight: bold; color: #28a745; margin: 15px 0;" id="finalPriceDisplay">
                    R$ 62.331,00
                </div>
                <div style="font-size: 14px; color: #666; font-style: italic; margin-top: 10px;" id="discountExplanation">
                    Desconto aplicado para mantermos o preço acordado no nosso orçamento inicial.
                </div>
            </div>

            <div class="total-section">
                <h3 style="margin-bottom: 10px;">VALOR TOTAL DO INVESTIMENTO</h3>
                <div class="total-price" id="displayTotalPrice">R$ 62.331,00</div>
                <p style="color: #666; margin-top: 10px;">
                    Prazo de Execução: 18-22 dias úteis
                </p>
            </div>

            <div style="background: #fef2e7; border: 2px solid #f6ad55; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4 style="color: #c05621; margin-bottom: 10px;">⚠️ OBSERVAÇÕES IMPORTANTES</h4>
                <p>• <strong>Materiais INCLUSOS</strong> no valor da proposta</p>
                <p>• Não inclui taxas de condomínio para aprovação</p>
                <p>• Proposta válida por 30 dias</p>
                <p>• Garantia: 12 meses para vícios de execução</p>
                <p>• Caçamba não inclusa (custo aprox. R$ 450,00)</p>
                <p>• Local: 4º andar SEM elevador</p>
            </div>

            <button class="botao" onclick="nextPage()">✅ ACEITAR PROPOSTA E CONTINUAR</button>
        </div>

        <!-- PÁGINA 2: TERMOS -->
        <div class="page" id="page2">
            <h2 class="page-title">📋 TERMO DE CIÊNCIA E RESPONSABILIDADE</h2>
            
            <p style="text-align: center; font-style: italic; margin-bottom: 25px; background: #e8f4f8; padding: 15px; border-radius: 8px;">
                Para garantir transparência total no nosso trabalho, queremos esclarecer alguns pontos importantes sobre o processo de reforma:
            </p>

            <div style="background: #f8f9fa; border-left: 4px solid #1a3a52; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0;">
                <h3 style="color: #1a3a52; margin-bottom: 15px;">🛡️ PROTEÇÃO DE MÓVEIS E OBJETOS</h3>
                <p>• Nossa equipe fará a proteção dos móveis conforme padrão do mercado</p>
                <div style="background: #fdf2f8; border: 1px solid #f687b3; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>IMPORTANTE:</strong> Após a proteção ser instalada, o cliente deve verificar e APROVAR se está adequada
                </div>
                <p>• Uma vez aprovada a proteção pelo cliente, a responsabilidade por eventuais danos fica transferida</p>
                <p><strong>• Mesmo com toda proteção e cuidado, reformas envolvem movimentação constante de materiais, ferramentas e equipamentos, podendo ocorrer batidas acidentais, resbalos, respingos ou pequenos impactos nos móveis protegidos</strong></p>

                <h3 style="color: #1a3a52; margin: 20px 0 15px 0;">💎 OBJETOS DE VALOR</h3>
                <div style="background: #fef2e7; border: 1px solid #f6ad55; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>OBRIGATÓRIO:</strong> Itens de grande valor (financeiro ou sentimental) devem ser REMOVIDOS do ambiente
                </div>
                <p>• <strong>Apenas quando for impossível remover:</strong> guardar em cômodo que não será reformado ou solicitar isolamento especial</p>
                <p>• A empresa NÃO se responsabiliza por objetos de valor que permaneceram no local mesmo após orientação</p>

                <h3 style="color: #1a3a52; margin: 20px 0 15px 0;">🔨 DURANTE A EXECUÇÃO</h3>
                <p>• Reformar com móveis no ambiente sempre envolve riscos</p>
                <p>• Geração de pó é inevitável (mesmo com proteção)</p>
                <p>• <strong>4º andar sem elevador:</strong> Transporte de materiais será feito pela escada</p>
                <p>• A reorganização final dos móveis NÃO está incluída no serviço</p>

                <h3 style="color: #1a3a52; margin: 20px 0 15px 0;">🏗️ ESPECIFICIDADES DA OBRA</h3>
                <div style="background: #e6fffa; border: 1px solid #38b2ac; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <strong>IMPERMEABILIZAÇÃO:</strong> Problemas de infiltração serão solucionados com manta asfáltica
                </div>
                <p>• Contrapiso será refeito conforme necessário para correção de níveis</p>
                <p>• Porcelanato 70x70 será assentado conforme especificação técnica</p>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #ffc107;">
                <input type="checkbox" id="agreeTerms" onchange="checkTermsAgreement()" style="margin-right: 10px; transform: scale(1.2);">
                <label for="agreeTerms" style="cursor: pointer;">
                    Li e estou de acordo com os Termos de Ciência e Responsabilidade acima.
                </label>
            </div>
            
            <div class="btn-group">
                <button class="botao back-btn" onclick="prevPage()">⬅️ Voltar</button>
                <button class="botao" id="confirmTermsBtn" onclick="nextPage()" disabled>✅ CONFIRMAR E AVANÇAR</button>
            </div>
        </div>

        <!-- PÁGINA 3: PAGAMENTO -->
        <div class="page" id="page3">
            <h2 class="page-title">💳 CONDIÇÕES DE PAGAMENTO</h2>
            
            <div class="total-section">
                <h3>VALOR TOTAL DO INVESTIMENTO</h3>
                <div class="total-price" id="totalInvestmentValue">R$ 62.331,00</div>
                <p>Prazo de Execução: 18-22 dias úteis</p>
            </div>

            <div style="background: #f8f9fa; border-left: 4px solid #1a3a52; padding: 20px; border-radius: 0 8px 8px 0; margin: 20px 0;">
                <h3 style="color: #1a3a52; margin-bottom: 15px;">🔄 ESCOLHA SUA FORMA DE PAGAMENTO:</h3>
                
                <div class="payment-choice" onclick="showCashPayment()">
                    <h4>💰 Pagamento apenas em dinheiro</h4>
                    <p>Condições tradicionais de pagamento parcelado</p>
                </div>
                
                <div class="payment-choice" onclick="showTokenPayment()">
                    <h4>🪙 Pagamento com tokens MAEOKA + Dinheiro</h4>
                    <p>Use até 40% em tokens e ganhe 10% de desconto</p>
                </div>
            </div>

            <!-- Seção Dinheiro -->
            <div class="content-section" id="cashPaymentContent" style="display: none;">
                <div class="cash-conditions">
                    <h4>💰 CONDIÇÕES DE PAGAMENTO</h4>
                    <p>• Entrada: 20% na assinatura do contrato (R$ 12.466,20)</p> 
                    <p>• 1ª Medição - Demolição: 25% (R$ 15.582,75)</p> 
                    <p>• 2ª Medição - Impermeabilização e Contrapiso: 30% (R$ 18.699,30)</p> 
                    <p>• 3ª Medição - Instalação de revestimentos e rejunte: 20% (R$ 12.466,20)</p> 
                    <p>• Final - Conclusão: 5% (R$ 3.116,55)</p> 
                    <p>• <strong>Pagamentos via PIX</strong></p>
                </div>
                
                <div class="btn-group">
                    <button class="botao back-btn" onclick="hideAllPaymentSections()">⬅️ Voltar</button>
                    <button class="botao" onclick="nextPage()">✅ Continuar com Pagamento em Dinheiro</button>
                </div>
            </div>

            <!-- Seção Tokens -->
            <div class="content-section" id="tokenPaymentContent" style="display: none;">
                <div class="token-section">
                    <h4 style="color: #1a3a52; margin-bottom: 15px;">🪙 PAGAMENTO COM TOKENS MAEOKA</h4>
                    
                    <div class="status-box desconectado" id="statusCarteira">
                        🔗 Conecte sua carteira para pagar com tokens
                    </div>
                    
                    <div id="tonConnectButton"></div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; display: none;" id="walletInfo">
                        <h4>📱 Sua Carteira</h4>
                        <p><strong>Endereço:</strong></p>
                        <div style="font-family: monospace; background: white; padding: 8px; border-radius: 4px; word-break: break-all; font-size: 12px;" id="enderecoCarteira"></div>
                        <p><strong>Saldo:</strong> <span id="saldoTokens">0 MAEOKA</span></p>
                    </div>
                    
                    <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0; display: none;" id="calculadoraTokens">
                        <h3>⚖️ Calculadora de Pagamento</h3>
                        <p>Use até <strong>40%</strong> do valor total em tokens (com 10% de desconto)</p>
                        
                        <div style="margin: 20px 0;">
                            <label>Tokens a usar: <span id="tokensUsar">0</span> MAEOKA = R$ <span id="valorTokens">0,00</span></label>
                            <input type="range" min="0" max="24932" value="0" style="width: 100%; height: 8px; border-radius: 5px; background: #ddd; outline: none; -webkit-appearance: none;" id="sliderTokens">
                            <p style="font-size: 12px; color: #666;" id="infoSaldo">
                                Você tem: <strong>0 MAEOKA</strong> | 
                                Máximo para esta obra: <strong>${Math.floor(VALOR_OBRA * LIMITE_PERCENTUAL).toLocaleString('pt-BR')} MAEOKA</strong> (40% de R$ ${VALOR_OBRA.toLocaleString('pt-BR')})
                            </p>
                        </div>
                        
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h4>📋 Resumo do Pagamento</h4>
                            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0;">
                                <span>Valor original da obra:</span>
                                <span id="valorOriginalObra"></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0;">
                                <span>Tokens a usar:</span>
                                <span id="resumoTokens">0 MAEOKA (R$ 0,00)</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0;">
                                <span>Desconto de 10%:</span>
                                <span id="resumoDesconto">- R$ 0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0;">
                                <span>Valor em dinheiro:</span>
                                <span id="resumoDinheiro">R$ 62.331,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-top: 2px solid #1a3a52; font-weight: bold; font-size: 18px;">
                                <span>TOTAL A PAGAR:</span>
                                <span id="resumoTotal">R$ 62.331,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; color: #38b2ac; font-weight: bold;">
                                <span>ECONOMIA:</span>
                                <span id="resumoEconomia">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <button class="botao" id="btnEnviarTokens" onclick="enviarTokens()" disabled>
                            🚀 ENVIAR TOKENS PARA MAEOKA
                        </button>
                    </div>
                </div>
                
                <div class="cash-conditions" id="adjustedPaymentConditions" style="display: none;">
                    <h4>💰 CONDIÇÕES DE PAGAMENTO (VALOR RESTANTE EM DINHEIRO)</h4>
                    <p>• Entrada: 20% na assinatura do contrato (<span id="tokenEntry">R$ 12.466,20</span>)</p> 
                    <p>• 1ª Medição - Demolição: 25% (<span id="tokenMeasurement1">R$ 15.582,75</span>)</p> 
                    <p>• 2ª Medição - Impermeabilização e Contrapiso: 30% (<span id="tokenMeasurement2">R$ 18.699,30</span>)</p> 
                    <p>• 3ª Medição - Instalação de revestimentos e rejunte: 20% (<span id="tokenMeasurement3">R$ 12.466,20</span>)</p> 
                    <p>• Final - Conclusão: 5% (<span id="tokenFinal">R$ 3.116,55</span>)</p> 
                    <p>• <strong>Pagamentos via PIX</strong></p>
                    <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin: 15px 0; color: #38b2ac;">
                        <p style="margin: 0; font-size: 14px;">
                            🎁 <strong>Cashback:</strong> Você receberá <span id="cashbackInfo">0</span> MAEOKA de volta após a conclusão da obra (3% sobre o total)!
                        </p>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="botao back-btn" onclick="hideAllPaymentSections()">⬅️ Voltar</button>
                    <button class="botao" id="continueTokenBtn" disabled onclick="nextPage()">✅ Continuar</button>
                </div>
            </div>
        </div>

        <!-- PÁGINA 4: DADOS -->
        <div class="page" id="page4">
            <h2 class="page-title">👤 DADOS DO CONTRATANTE</h2>
            
            <form id="clientForm">
                <div class="form-group">
                    <label for="fullName">Nome Completo *</label>
                    <input type="text" id="fullName" name="fullName" required>
                </div>

                <div class="form-group">
                    <label for="cpf">CPF *</label>
                    <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00">
                </div>

                <div class="form-group">
                    <label for="email">E-mail *</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="phone">Telefone/WhatsApp *</label>
                    <input type="tel" id="phone" name="phone" required placeholder="(41) 99999-9999">
                </div>

                <div class="form-group">
                    <label for="address">Endereço de Domicílio *</label>
                    <textarea id="address" name="address" rows="3" required placeholder="Rua, número, bairro, cidade"></textarea>
                </div>

                <div class="form-group">
                    <label for="observations">Observações Adicionais</label>
                    <textarea id="observations" name="observations" rows="3" placeholder="Alguma informação adicional importante..."></textarea>
                </div>

                <div style="background: #e8f4f8; border: 2px solid #1a3a52; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #1a3a52; margin-bottom: 10px;">🔒 PROTEÇÃO DE DADOS PESSOAIS (LGPD)</h4>
                    <p style="font-size: 13px; line-height: 1.4;">
                        <strong>Como utilizamos seus dados:</strong><br>
                        • Seus dados serão utilizados exclusivamente para execução do contrato<br>
                        • Comunicação sobre o andamento da obra e serviços<br>
                        • Cumprimento de obrigações legais e fiscais<br>
                        • Não compartilhamos dados com terceiros sem autorização<br>
                        • Você pode solicitar exclusão dos dados a qualquer momento
                    </p>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #ffc107;">
                    <input type="checkbox" id="lgpdAccepted" required style="margin-right: 10px; transform: scale(1.2);">
                    <label for="lgpdAccepted" style="cursor: pointer;">
                        <strong>Autorizo o tratamento dos meus dados pessoais pela Maeoka Engenharia conforme descrito acima, de acordo com a Lei Geral de Proteção de Dados (LGPD - Lei 13.709/2018).</strong>
                    </label>
                </div>

                <div style="background: #fef2e7; border: 2px solid #f6ad55; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #c05621; margin-bottom: 10px;">📋 CONFIRMAÇÃO FINAL</h4>
                    <p>Ao finalizar, você estará formalizando a contratação dos serviços da Maeoka Engenharia conforme proposta apresentada e termos aceitos.</p>
                </div>

                <div class="btn-group">
                    <button type="button" class="botao back-btn" onclick="prevPage()">← VOLTAR</button>
                    <button type="submit" class="botao">🎉 FINALIZAR CONTRATAÇÃO</button>
                </div>
            </form>
        </div>

        <!-- PÁGINA 5: FINALIZAÇÃO -->
        <div class="page" id="page5">
            <div style="background: #e6fffa; border: 2px solid #38b2ac; padding: 20px; border-radius: 12px; text-align: center; color: #1a3a52;">
                <h2 style="color: #1a3a52; margin-bottom: 20px;">🎉 CONTRATAÇÃO REALIZADA COM SUCESSO!</h2>
                <p style="font-size: 18px; margin-bottom: 20px;">Obrigado por escolher a Maeoka Engenharia!</p>
                
                <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #38b2ac; margin: 20px 0;">
                    <h3 style="margin-bottom: 15px;">📧 PRÓXIMOS PASSOS:</h3>
                    <p>✅ Baixar documento no celular/computador/tablet</p>
                    <p>✅ Enviar para nossa equipe via whatsapp</p>
                    <p>✅ Agendaremos a vistoria técnica</p>
                    <p>✅ Definiremos o cronograma detalhado</p>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
                    <p><strong>Número do Protocolo:</strong> <span id="protocolNumber"></span></p>
                    <p><strong>Data/Hora:</strong> <span id="contractDateTime"></span></p>
                </div>

                <div id="systemStatus" style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #1a3a52;">
                    <h4 style="color: #1a3a52; margin-bottom: 10px;">🔄 STATUS DO SISTEMA</h4>
                    <p id="statusMessage">📤 Enviando contrato automaticamente para Maeoka Engenharia...</p>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 20px; border-radius: 12px; margin: 25px 0; text-align: center; box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);">
                <h3 style="margin-bottom: 15px;">📄 FINALIZAÇÃO DO PROCESSO</h3>
                <p style="margin-bottom: 15px;">
                    <strong>Para finalizar o processo, é necessário baixar o documento para assinatura e compartilhar com a Maeoka Engenharia.</strong>
                </p>
                <p style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">
                    O documento será baixado em formato HTML (pode ser convertido para PDF). Recomendamos envio via WhatsApp para maior agilidade.
                </p>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="botao" onclick="downloadContractHTML()" style="background: #e74c3c;">
                        📄 BAIXAR DOCUMENTO PARA ASSINATURA
                    </button>
                </div>
                
                <p style="font-size: 12px; opacity: 0.8; margin-top: 15px;">
                    * Após compartilhar o documento, nossa equipe confirmará o recebimento e dará início ao processo.
                </p>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="botao" onclick="restartProcess()" style="background: #6c757d;">
                    🔄 NOVA CONTRATAÇÃO
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configurações
        const TOKEN_MAEOKA = 'EQCUgsVus4fW5TY2bxBQWSyiwLETOr2iNlVied-szVuJ1t4W';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwovnJtN76EfqzykncamVAvszSve0JMzrw7gU7kAPIF6MJBmkf9-XSmP1z2KjBwsWBN8Q/exec';
        
        let VALOR_OBRA = 62331;
        const LIMITE_PERCENTUAL = 0.40;
        
        let currentPage = 1;
        let currentTotalWithTax = 62331;
        let totalPages = 5;
        let contracts = JSON.parse(localStorage.getItem('maeokaContracts')) || [];
        
        // Variáveis do sistema de tokens
        let saldoUsuario = 0;
        let enderecoUsuario = '';
        let tonweb = null;
        let tonConnectUI = null;
        let metodoPagamentoSelecionado = null;

        // Elementos da página
        const statusCarteira = document.getElementById('statusCarteira');
        const walletInfo = document.getElementById('walletInfo');
        const enderecoCarteira = document.getElementById('enderecoCarteira');
        const saldoTokens = document.getElementById('saldoTokens');
        const calculadoraTokens = document.getElementById('calculadoraTokens');
        const sliderTokens = document.getElementById('sliderTokens');
        const tokensUsar = document.getElementById('tokensUsar');
        const btnEnviarTokens = document.getElementById('btnEnviarTokens');
        const continueTokenBtn = document.getElementById('continueTokenBtn');
        
        // Elementos do resumo
        const resumoTokens = document.getElementById('resumoTokens');
        const resumoDesconto = document.getElementById('resumoDesconto');
        const resumoDinheiro = document.getElementById('resumoDinheiro');
        const resumoTotal = document.getElementById('resumoTotal');
        const resumoEconomia = document.getElementById('resumoEconomia');
        const valorTokens = document.getElementById('valorTokens');
        const infoSaldo = document.getElementById('infoSaldo');

        // Navegação
        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentPage / totalPages) * 100;
            progressBar.style.width = progress + '%';
        }

        function showPage(pageNumber) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(`page${pageNumber}`).classList.add('active');
            currentPage = pageNumber;
            updateProgressBar();
            window.scrollTo(0, 0);
            
            // Update payment page with current value
            if (pageNumber === 3) {
                document.getElementById('totalInvestmentValue').textContent = 
                    `R$ ${VALOR_OBRA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
        }

        function nextPage() {
            if (currentPage === 2) { 
                const termsAccepted = document.getElementById('agreeTerms').checked;
                if (!termsAccepted) {
                    alert('Por favor, aceite os Termos de Ciência e Responsabilidade para continuar.');
                    return;
                }
            } else if (currentPage === 4) { 
                const clientForm = document.getElementById('clientForm');
                if (!clientForm.checkValidity()) {
                    clientForm.reportValidity();
                    return;
                }
                if (!document.getElementById('lgpdAccepted').checked) {
                    alert('⚠️ É necessário autorizar o tratamento de dados pessoais (LGPD) para continuar.');
                    return;
                }
                finalizeContract();
            }

            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        }

        // Sistema de cálculo NF
        function updateCalculations() {
            let currentTotalBeforeTax = 66031.00;
            let finalPriceAfterDiscount = 62331.00;

            const invoiceOptionEmitir = document.getElementById('invoiceOptionEmitir');
            const originalPriceDisplay = document.getElementById('originalPriceDisplay');
            const finalPriceDisplay = document.getElementById('finalPriceDisplay');
            const discountExplanation = document.getElementById('discountExplanation');

            if (invoiceOptionEmitir && invoiceOptionEmitir.checked) {
                finalPriceAfterDiscount = 62331.00 * 1.17; // 17% de acréscimo
                currentTotalWithTax = finalPriceAfterDiscount;
                VALOR_OBRA = finalPriceAfterDiscount;
                
                originalPriceDisplay.textContent = `Total orçado: R$ ${currentTotalBeforeTax.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                finalPriceDisplay.textContent = `R$ ${finalPriceAfterDiscount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                discountExplanation.textContent = `Com desconto aplicado + acréscimo de 17% para emissão de NF.`;
            } else {
                originalPriceDisplay.textContent = `Total orçado: R$ ${currentTotalBeforeTax.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                finalPriceDisplay.textContent = `R$ ${finalPriceAfterDiscount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                discountExplanation.textContent = `Desconto aplicado para mantermos o preço acordado no nosso orçamento inicial.`;
            }

            document.getElementById('displayTotalPrice').textContent = `R$ ${finalPriceAfterDiscount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
        }

        // Funções de pagamento
        function showCashPayment() {
            hideAllPaymentSections();
            document.getElementById('cashPaymentContent').style.display = 'block';
            metodoPagamentoSelecionado = 'cash';
            document.getElementById('valorOriginalObra').textContent = `R$ ${VALOR_OBRA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function showTokenPayment() {
            hideAllPaymentSections();
            document.getElementById('tokenPaymentContent').style.display = 'block';
            metodoPagamentoSelecionado = 'tokens';
            
            if (!tonConnectUI) {
                setTimeout(() => {
                    inicializarTonConnect();
                }, 100);
            }
        }

        function hideAllPaymentSections() {
            document.getElementById('cashPaymentContent').style.display = 'none';
            document.getElementById('tokenPaymentContent').style.display = 'none';
            metodoPagamentoSelecionado = null;
        }

        // Sistema de tokens
        function inicializarTonWeb() {
            try {
                tonweb = new TonWeb(new TonWeb.HttpProvider('https://toncenter.com/api/v2/jsonRPC'));
                return true;
            } catch (error) {
                console.error('Erro ao inicializar TonWeb:', error);
                return false;
            }
        }

        function inicializarTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
                    buttonRootId: 'tonConnectButton'
                });

                tonConnectUI.onStatusChange(walletInfo => {
                    if (walletInfo) {
                        statusCarteira.textContent = '✅ Carteira Conectada - Consultando saldo...';
                        statusCarteira.className = 'status-box processando';
                        
                        const endereco = walletInfo.account.address;
                        try {
                            const address = new TonWeb.utils.Address(endereco);
                            enderecoUsuario = address.toString(true, true, false);
                        } catch (error) {
                            enderecoUsuario = endereco;
                        }
                        
                        enderecoCarteira.textContent = enderecoUsuario;
                        document.getElementById('walletInfo').style.display = 'block';
                        
                        buscarSaldoTokens();
                        
                    } else {
                        statusCarteira.textContent = '🔗 Conecte sua carteira para pagar com tokens';
                        statusCarteira.className = 'status-box desconectado';
                        
                        document.getElementById('walletInfo').style.display = 'none';
                        calculadoraTokens.style.display = 'none';
                        document.getElementById('adjustedPaymentConditions').style.display = 'none';
                    }
                });
                
                return true;
            } catch (error) {
                console.error('Erro ao inicializar TON Connect:', error);
                return false;
            }
        }

        async function buscarSaldoTokens() {
            try {
                console.log('🔍 Consultando saldo real na blockchain para:', enderecoUsuario);
                
                try {
                    const jettonMinter = new TonWeb.token.jetton.JettonMinter(tonweb.provider, {
                        address: TOKEN_MAEOKA
                    });
                    
                    const userJettonWalletAddress = await jettonMinter.getJettonWalletAddress(
                        new TonWeb.utils.Address(enderecoUsuario)
                    );
                    
                    const jettonWallet = new TonWeb.token.jetton.JettonWallet(tonweb.provider, {
                        address: userJettonWalletAddress
                    });
                    
                    const jettonData = await jettonWallet.getData();
                    const saldoNano = jettonData.balance;
                    saldoUsuario = parseFloat(TonWeb.utils.fromNano(saldoNano));
                    
                    console.log('✅ Saldo real obtido:', saldoUsuario, 'MAEOKA');
                    
                } catch (blockchainError) {
                    console.warn('⚠️ Erro na consulta blockchain:', blockchainError);
                    saldoUsuario = 0;
                }
                
                saldoTokens.textContent = `${saldoUsuario.toLocaleString('pt-BR')} MAEOKA (R$ ${saldoUsuario.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;
                
                const maxTokensPorLimite = VALOR_OBRA * LIMITE_PERCENTUAL;
                const maxTokens = Math.min(saldoUsuario, maxTokensPorLimite);
                
                sliderTokens.max = maxTokens;
                sliderTokens.value = 0;
                
                infoSaldo.innerHTML = `Você tem: <strong>${saldoUsuario.toLocaleString('pt-BR')} MAEOKA</strong> | Máximo para esta obra: <strong>${maxTokensPorLimite.toLocaleString('pt-BR')} MAEOKA</strong> (40% de R$ ${VALOR_OBRA.toLocaleString('pt-BR')})`;
                
                document.getElementById('valorOriginalObra').textContent = `R$ ${VALOR_OBRA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                        if (saldoUsuario === 0) {
                    statusCarteira.textContent = '⚠️ Carteira conectada - Sem tokens MAEOKA';
                    statusCarteira.className = 'status-box desconectado';
                    
                    calculadoraTokens.innerHTML = `
                        <div style="background: #fef2e7; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #f6ad55;">
                            <h3 style="color: #c05621; margin-bottom: 15px;">🪙 SEM TOKENS MAEOKA</h3>
                            <p style="color: #856404; margin-bottom: 10px;">Sua carteira não possui tokens MAEOKA.</p>
                            <p style="color: #666; font-size: 14px;">Para usar esta opção de pagamento, você precisa ter tokens MAEOKA em sua carteira.</p>
                        </div>
                    `;
                    updateAdjustedPaymentConditions(VALOR_OBRA, VALOR_OBRA);
                    document.getElementById('adjustedPaymentConditions').style.display = 'block';
                } else {
                    statusCarteira.textContent = '✅ Carteira Conectada - Pronto para pagamento';
                    statusCarteira.className = 'status-box conectado';
                    document.getElementById('valorOriginalObra').textContent = `R$ ${VALOR_OBRA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    atualizarCalculos(0);
                }
                
                calculadoraTokens.style.display = 'block';
                
            } catch (error) {
                console.error('❌ Erro geral na busca de saldo:', error);
                statusCarteira.textContent = '❌ Erro ao consultar saldo';
                statusCarteira.className = 'status-box erro';
            }
        }

        function atualizarCalculos(tokensValue) {
            tokensUsar.textContent = tokensValue.toLocaleString('pt-BR');
            valorTokens.textContent = tokensValue.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            resumoTokens.textContent = `${tokensValue.toLocaleString('pt-BR')} MAEOKA (R$ ${tokensValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;
            
            const desconto = tokensValue * 0.1;
            resumoDesconto.textContent = `- R$ ${desconto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            const valorDinheiro = VALOR_OBRA - tokensValue - desconto;
            resumoDinheiro.textContent = `R$ ${valorDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            const totalFinal = VALOR_OBRA - tokensValue - desconto;
            resumoTotal.textContent = `R$ ${totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            const economiaTotal = tokensValue + desconto;
            resumoEconomia.textContent = `R$ ${economiaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            if (tokensValue > 0) {
                btnEnviarTokens.disabled = false;
                btnEnviarTokens.textContent = `💳 PAGAR COM ${tokensValue.toLocaleString('pt-BR')} TOKENS + DINHEIRO`;
                continueTokenBtn.disabled = true;
            } else {
                btnEnviarTokens.disabled = true;
                btnEnviarTokens.textContent = '🚀 ENVIAR TOKENS PARA MAEOKA';
                continueTokenBtn.disabled = false;
                continueTokenBtn.textContent = '✅ Continuar sem Tokens';
            }
            updateAdjustedPaymentConditions(valorDinheiro, totalFinal);
            document.getElementById('adjustedPaymentConditions').style.display = 'block';
        }

        function updateAdjustedPaymentConditions(valorDinheiro, totalFinal) {
            const entryValue = valorDinheiro * 0.20;
            const measurement1Value = valorDinheiro * 0.25;
            const measurement2Value = valorDinheiro * 0.30;
            const measurement3Value = valorDinheiro * 0.20;
            const finalValue = valorDinheiro * 0.05;
            
            document.getElementById('tokenEntry').textContent = `R$ ${entryValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenMeasurement1').textContent = `R$ ${measurement1Value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenMeasurement2').textContent = `R$ ${measurement2Value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenMeasurement3').textContent = `R$ ${measurement3Value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenFinal').textContent = `R$ ${finalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            
            const cashback = Math.floor(totalFinal * 0.03);
            document.getElementById('cashbackInfo').textContent = `${cashback} MAEOKA`;
        }

        async function enviarTokens() {
            const tokensValue = parseInt(sliderTokens.value);
            
            if (tokensValue === 0) {
                alert('Selecione uma quantidade de tokens para enviar!');
                return;
            }
            
            if (tokensValue > saldoUsuario) {
                alert('Você não tem tokens suficientes!');
                return;
            }
            
            btnEnviarTokens.disabled = true;
            btnEnviarTokens.innerHTML = '<span style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1a3a52; border-radius: 50%; animation: spin 1s linear infinite;"></span> Enviando tokens...';
            
            try {
                const CARTEIRA_MAEOKA_OFICIAL = 'UQCI80_zNVLySHf1DZbxfVw52DMPQj8EAOMcDn9TlvsjC341';
                
                const jettonMinter = new TonWeb.token.jetton.JettonMinter(tonweb.provider, {
                    address: TOKEN_MAEOKA
                });
                
                const userJettonWalletAddress = await jettonMinter.getJettonWalletAddress(
                    new TonWeb.utils.Address(enderecoUsuario)
                );
                
                const jettonWallet = new TonWeb.token.jetton.JettonWallet(tonweb.provider, {
                    address: userJettonWalletAddress
                });
                
                const jettonAmount = TonWeb.utils.toNano(tokensValue.toString());
                const forwardAmount = TonWeb.utils.toNano('0.01');
                
                const transferBody = await jettonWallet.createTransferBody({
                    jettonAmount: jettonAmount,
                    toAddress: new TonWeb.utils.Address(CARTEIRA_MAEOKA_OFICIAL),
                    forwardAmount: forwardAmount,
                    forwardPayload: new TextEncoder().encode(`Pagamento obra Thiago - ${tokensValue} tokens`),
                    responseAddress: new TonWeb.utils.Address(enderecoUsuario)
                });
                
                const transaction = {
                    validUntil: Date.now() + 5 * 60 * 1000,
                    messages: [
                        {
                            address: userJettonWalletAddress.toString(),
                            amount: TonWeb.utils.toNano('0.05').toString(),
                            payload: TonWeb.utils.bytesToBase64(await transferBody.toBoc())
                        }
                    ]
                };
                
                const result = await tonConnectUI.sendTransaction(transaction);
                
                const desconto = tokensValue * 0.1;
                const valorFinalEmDinheiro = VALOR_OBRA - tokensValue - desconto;
                const totalFinal = VALOR_OBRA - tokensValue - desconto;
                const economiaTotal = tokensValue + desconto;
                
                alert(`✅ TOKENS ENVIADOS COM SUCESSO!\n\n` +
                      `💰 Tokens enviados: ${tokensValue.toLocaleString('pt-BR')} MAEOKA\n` +
                      `💸 Desconto obtido: R$ ${desconto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n` +
                      `💵 Valor restante em dinheiro: R$ ${valorFinalEmDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n` +
                      `🏗️ Total da obra: R$ ${totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n` +
                      `🎁 Economia total: R$ ${economiaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n\n` +
                      `Agora você pode continuar para a próxima etapa!`);
                
                btnEnviarTokens.textContent = '✅ Tokens Enviados com Sucesso!';
                btnEnviarTokens.style.background = '#38b2ac';
                continueTokenBtn.disabled = false;
                continueTokenBtn.textContent = '✅ Continuar para Próxima Etapa';
                
            } catch (error) {
                console.error('Erro no envio:', error);
                
                btnEnviarTokens.disabled = false;
                btnEnviarTokens.textContent = `💳 PAGAR COM ${tokensValue.toLocaleString('pt-BR')} TOKENS + DINHEIRO`;
                
                if (error.message.includes('User declined')) {
                    alert('Envio cancelado pelo usuário.');
                } else {
                    alert('Erro no envio: ' + error.message);
                }
            }
        }

        // Validação
        function checkTermsAgreement() {
            const agreeTermsCheckbox = document.getElementById('agreeTerms');
            const confirmTermsBtn = document.getElementById('confirmTermsBtn');
            confirmTermsBtn.disabled = !agreeTermsCheckbox.checked;
        }

        // Finalização
        function generateProtocol() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            return `MAE-${year}${month}${day}-${hour}${minute}${second}`;
        }

        async function finalizeContract() {
            const clientForm = document.getElementById('clientForm');
            const clientData = {
                fullName: clientForm.elements['fullName'].value,
                cpf: clientForm.elements['cpf'].value,
                email: clientForm.elements['email'].value,
                phone: clientForm.elements['phone'].value,
                address: clientForm.elements['address'].value,
                observations: clientForm.elements['observations'].value,
            };

            const tokensUsados = metodoPagamentoSelecionado === 'tokens' ? parseInt(sliderTokens.value) : 0;
            const descontoAplicado = metodoPagamentoSelecionado === 'tokens' ? parseInt(sliderTokens.value) * 0.1 : 0;
            const valorFinalDinheiro = metodoPagamentoSelecionado === 'tokens' ? VALOR_OBRA - parseInt(sliderTokens.value) - descontoAplicado : VALOR_OBRA;
            
            const contractData = {
                // Payment details
                tokensUsados,
                descontoAplicado,
                valorFinalDinheiro,
                
                // Dados específicos do Thiago
                nomeCliente: "Thiago",
                enderecoObra: "R. Eponino Macuco, 185 - Curitiba/PR",
                tituloContrato: "CONTRATO DE PRESTAÇÃO DE SERVIÇO",
                valorTotal: VALOR_OBRA,
                prazoExecucao: "18-22 dias úteis",
                servicos: [
                    { nome: "Demolição - Remover Revestimento e Contra-Piso existente.", area: "Área: 100,93 m² • Com retirada de entulho até caçamba", preco: 6333.33 },
                    { nome: "Regularização/nivelamento", area: "Argamassa de regularização e caimento para ralos (min. 1%)", preco: 7125.00 },
                    { nome: "Aplicação de Primer e Manta asfáltica", area: "Nas áreas de recreação 1 e 2", preco: 5541.67 },
                    { nome: "Executar Contrapiso", area: "Proteção mecânica - Argamassa de proteção de 3-5cm sobre a manta", preco: 11875.00 },
                    { nome: "Instalar Revestimento Cerâmico/Porcelanato", area: "Nas áreas de recreação 1 e 2 (porcelanato até 90x90)", preco: 7125.00 }
                ],
                materiaisInclusos: [
                    "Areia, cimento e brita para contrapiso e regularização",
                    "Manta asfáltica, primer, cola, pregos para impermeabilização",
                    "Argamassa e espaçadores para assentamento de revestimento"
                ],
                valorMateriais: 28031.00,
                observacoesImportantess: [
                    "Materiais INCLUSOS no valor da proposta",
                    "Não inclui taxas de condomínio para aprovação",
                    "Proposta válida por 30 dias",
                    "Garantia: 12 meses para vícios de execução",
                    "Caçamba não inclusa (custo aprox. R$ 450,00)",
                    "Local: 4º andar SEM elevador"
                ],
                
                // Dados do cliente
                ...clientData,
                contractDate: new Date().toLocaleString('pt-BR'),
                protocol: generateProtocol(),
                termsAccepted: document.getElementById('agreeTerms').checked,
                lgpdAccepted: document.getElementById('lgpdAccepted').checked,
                metodoPagamento: metodoPagamentoSelecionado
            };

            contracts.push(contractData);
            localStorage.setItem('maeokaContracts', JSON.stringify(contracts));
            localStorage.setItem('currentContractDisplay', JSON.stringify(contractData));

            document.getElementById('protocolNumber').textContent = contractData.protocol;
            document.getElementById('contractDateTime').textContent = contractData.contractDate;
            
            // Enviar para Apps Script automaticamente
            await sendContractToAppsScript(contractData);
        }

        async function sendContractToAppsScript(contractData) {
            const statusMessage = document.getElementById('statusMessage');
            
            try {
                statusMessage.innerHTML = '📤 Enviando contrato para Maeoka Engenharia...';
                statusMessage.style.color = '#1a3a52';
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contractData: contractData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusMessage.innerHTML = '✅ Contrato enviado com sucesso! Maeoka Engenharia foi notificada automaticamente.';
                    statusMessage.style.color = '#38b2ac';
                    
                    // Mudar cor da seção de status
                    document.getElementById('systemStatus').style.background = '#e6fffa';
                    document.getElementById('systemStatus').style.borderColor = '#38b2ac';
                } else {
                    throw new Error(result.error || 'Erro desconhecido');
                }
                
            } catch (error) {
                console.error('Erro ao enviar para Apps Script:', error);
                statusMessage.innerHTML = '⚠️ Contrato salvo localmente, mas não foi possível enviar automaticamente. Use o botão de download abaixo.';
                statusMessage.style.color = '#f6ad55';
                
                document.getElementById('systemStatus').style.background = '#fef2e7';
                document.getElementById('systemStatus').style.borderColor = '#f6ad55';
            }
        }

        function downloadContractHTML() {
            const contractData = JSON.parse(localStorage.getItem('currentContractDisplay'));
            
            if (!contractData) {
                alert('Não há dados de contrato para download.');
                return;
            }

            let servicesHTML = '';
            contractData.servicos.forEach(servico => {
                let preco = servico.preco;
                if (contractData.metodoPagamento === 'tokens') {
                    // Calculate the adjusted price based on token payment
                    const ratio = preco / 38000; // Original service total
                    preco = (contractData.valorFinalDinheiro * ratio);
                }
                
                servicesHTML += `
                    <div style="background: #f0f0f0; padding: 12px; margin: 8px 0; border-radius: 5px;">
                        <strong>${servico.nome}</strong><br>
                        <span style="color: #666;">${servico.area} = ${preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                    </div>
                `;
            });

            let materialsHTML = '';
            if (contractData.materiaisInclusos && contractData.materiaisInclusos.length > 0) {
                materialsHTML = `
                    <h4 style="color: #1a3a52; margin-bottom: 10px;">📦 MATERIAIS INCLUSOS:</h4>
                    <ul style="list-style-type: none; padding-left: 0;">
                        ${contractData.materiaisInclusos.map(item => `<li>• ${item}</li>`).join('')}
                    </ul>
                    <p style="text-align: center; font-weight: bold; color: #2c5282;">SUBTOTAL MATERIAIS: R$ ${contractData.valorMateriais.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                `;
            }

            const htmlContent = `
            <!DOCTYPE html>
            <html lang="pt-BR">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Contrato ${contractData.protocol} - Maeoka Engenharia</title>
                <style>
                    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; color: #333; line-height: 1.6; font-size: 14px; }
                    .header { background: #1a3a52; color: white; padding: 25px; text-align: center; margin-bottom: 30px; }
                    .logo { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
                    .subtitle { font-size: 14px; opacity: 0.9; }
                    .section { margin: 25px 0; padding: 20px; border-left: 4px solid #1a3a52; background: #f8f9fa; border-radius: 0 8px 8px 0; }
                    .total { background: #1a3a52; color: white; padding: 20px; text-align: center; font-size: 20px; font-weight: bold; border-radius: 8px; margin: 20px 0; }
                    .signature-area { border: 2px dashed #1a3a52; padding: 40px; margin-top: 50px; text-align: center; border-radius: 8px; }
                    .signature-line { border-bottom: 1px solid #333; width: 80%; margin: 30px auto 10px auto; height: 30px; }
                    h2 { color: #1a3a52; border-bottom: 2px solid #1a3a52; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
                    h3 { color: #2c5282; margin-top: 25px; margin-bottom: 15px; }
                    @media print {
                        body { margin: 0; }
                        .header { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        .total { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">MAEOKA ENGENHARIA</div>
                    <div class="subtitle">CNPJ: 19.924.627/0001-67 • Eng. Kioma Maeoka (CREA 159.328/D-PR)</div>
                </div>

                <h2>CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE ENGENHARIA</h2>
                
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                    <p><strong>Protocolo:</strong> ${contractData.protocol}</p>
                    <p><strong>Data de Aceite Digital:</strong> ${contractData.contractDate}</p>
                </div>

                <div class="section">
                    <h3>👤 DADOS DO CONTRATANTE</h3>
                    <p><strong>Nome Completo:</strong> ${contractData.fullName}</p>
                    <p><strong>CPF:</strong> ${contractData.cpf}</p>
                    <p><strong>E-mail:</strong> ${contractData.email}</p>
                    <p><strong>Telefone:</strong> ${contractData.phone}</p>
                    <p><strong>Endereço de Domicílio:</strong> ${contractData.address}</p>
                </div>

                <div class="section">
                    <h3>🔨 SERVIÇOS CONTRATADOS</h3>
                    <p><strong>Descrição Geral:</strong> ${contractData.tituloContrato}</p>
                    <p><strong>Cliente:</strong> ${contractData.nomeCliente}</p>
                    <p><strong>Endereço da Obra:</strong> ${contractData.enderecoObra}</p>
                    
                    <h4>Detalhamento dos Serviços:</h4>
                    ${servicesHTML}
                    
                    <div style="margin: 15px 0; text-align: center;">
                        <div style="margin-bottom: 10px;">
                            VALOR TOTAL: R$ ${contractData.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                        ${contractData.metodoPagamento === 'tokens' ? `
                        <div style="margin-bottom: 10px;">
                            <strong>Tokens Utilizados:</strong> ${contractData.tokensUsados.toLocaleString('pt-BR')} MAEOKA<br>
                            <strong>Desconto Aplicado:</strong> R$ ${contractData.descontoAplicado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                        ` : ''}
                        <div class="total" style="font-size: 24px;">
                            TOTAL A PAGAR: R$ ${contractData.metodoPagamento === 'tokens' ? contractData.valorFinalDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : contractData.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                    </div>
                </div>

                <div class="section">
                    ${materialsHTML}
                </div>

                <div class="section">
                    <h3>💰 CONDIÇÕES COMERCIAIS</h3>
                    <p><strong>Prazo de Execução:</strong> ${contractData.prazoExecucao}</p>
                    <p><strong>Método de Pagamento:</strong> ${contractData.metodoPagamento === 'tokens' ? 'Tokens MAEOKA + Dinheiro' : 'Apenas Dinheiro'}</p>
                    <p><strong>Forma de Pagamento:</strong> PIX</p>
                    <p><strong>Garantia:</strong> 12 meses para serviços executados</p>
                </div>

                <div class="section">
                    <h3>⚠️ OBSERVAÇÕES IMPORTANTES</h3>
                    <ul>
                        ${contractData.observacoesImportantess.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>

                ${contractData.observations && contractData.observations.trim() !== '' ? `
                <div class="section">
                    <h3>📝 OBSERVAÇÕES ADICIONAIS DO CLIENTE</h3>
                    <p>${contractData.observations}</p>
                </div>
                ` : ''}

                ${contractData.metodoPagamento === 'tokens' ? `
                <div class="section">
                    <h3>💰 CONDIÇÕES DE PAGAMENTO (VALOR RESTANTE EM DINHEIRO)</h3>
                    <p>• Entrada: 20% na assinatura do contrato (R$ ${(contractData.valorFinalDinheiro * 0.2).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• 1ª Medição - Demolição: 25% (R$ ${(contractData.valorFinalDinheiro * 0.25).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• 2ª Medição - Impermeabilização e Contrapiso: 30% (R$ ${(contractData.valorFinalDinheiro * 0.3).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• 3ª Medição - Instalação de revestimentos e rejunte: 20% (R$ ${(contractData.valorFinalDinheiro * 0.2).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• Final - Conclusão: 5% (R$ ${(contractData.valorFinalDinheiro * 0.05).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• Pagamentos via PIX</p>
                    <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin: 15px 0; color: #38b2ac;">
                        <p style="margin: 0; font-size: 14px;">
                            🎁 <strong>Cashback:</strong> Você receberá ${Math.floor(contractData.valorFinalDinheiro * 0.03)} MAEOKA de volta após a conclusão da obra (3% sobre o total)!
                        </p>
                    </div>
                </div>
                ` : ''}
                <div class="signature-area">
                    <h3>✍️ ASSINATURAS</h3>
                    <p>Curitiba/PR, ${new Date().toLocaleDateString('pt-BR', {day: 'numeric', month: 'long', year: 'numeric'})}</p>
                    
                    <div style="display: flex; justify-content: space-around; margin-top: 50px;">
                        <div style="text-align: center; width: 45%;">
                            <div class="signature-line"></div>
                            <p><strong>CONTRATANTE</strong></p>
                            <p>${contractData.fullName}</p>
                            <p>CPF: ${contractData.cpf}</p>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <div class="signature-line"></div>
                            <p><strong>CONTRATADA</strong></p>
                            <p>Kioma Maeoka</p>
                            <p>Engenheiro Civil - CREA 159.328/D-PR</p>
                            <p>Maeoka Engenharia</p>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 40px; font-size: 12px; color: #666; text-align: center; border-top: 1px solid #ddd; padding-top: 20px;">
                    <p><strong>Maeoka Engenharia</strong></p>
                    <p>Curitiba/PR • WhatsApp: (41) 98839-1153</p>
                    <p>E-mail: contato@maeokaengenharia.com.br</p>
                    <p style="margin-top: 15px; font-style: italic;">
                        Este documento foi gerado digitalmente em ${new Date().toLocaleString('pt-BR')}
                    </p>
                </div>
            </body>
            </html>
            `;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Contrato_Maeoka_Thiago_${contractData.protocol}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('📄 Contrato do Thiago baixado com sucesso!');
        }

        function restartProcess() {
            if (confirm('Deseja iniciar uma nova contratação? Os dados atuais serão perdidos.')) {
                localStorage.removeItem('currentContractDisplay');
                location.reload();
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            // Atualizar data atual
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric' 
            });
            
            // Inicializar TonWeb
            inicializarTonWeb();
            
            // Event listeners
            document.getElementById('agreeTerms').addEventListener('change', checkTermsAgreement);

            document.getElementById('sliderTokens').addEventListener('input', function() {
                const tokensValue = parseInt(this.value);
                atualizarCalculos(tokensValue);
            });

            document.getElementById('clientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                nextPage();
            });

            // Formatação de CPF
            document.getElementById('cpf').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d)/, '$1.$2');
                    value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                }
                e.target.value = value;
            });

            // Formatação de telefone
            document.getElementById('phone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                    value = value.replace(/(\d)(\d{4})$/, '$1-$2');
                }
                e.target.value = value;
            });
            
            console.log('🎯 Sistema Maeoka - Contrato Thiago carregado!');
        });

        // Adicionar animação de loading
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
