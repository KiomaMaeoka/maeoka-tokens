<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashback Autom√°tico - Maeoka Engenharia</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a3a52; color: #fff; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: #2c5282; padding: 20px; border-radius: 10px; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; }
        button { background: #fff; color: #1a3a52; border: none; cursor: pointer; }
        #resultado { margin-top: 10px; }
    </style>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üéÅ Cashback Autom√°tico</h2>
        <div>Dados da Indica√ß√£o</div>
        <input id="numeroObra" placeholder="N√∫mero da Obra">
        <input id="senhaRecompensa" type="password" placeholder="Senha da Recompensa">
        <div id="tonConnectButton"></div>
        <button onclick="solicitarCashback()">Solicitar (Gr√°tis)</button>
        <div id="resultado"></div>
    </div>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
            buttonRootId: 'tonConnectButton'
        });

        async function solicitarCashback() {
            const numeroObra = document.querySelector('#numeroObra').value;
            const senha = document.querySelector('#senhaRecompensa').value;

            const connectedWallet = tonConnectUI.wallet;
            if (!connectedWallet) {
                document.getElementById('resultado').innerText = "Conecte sua carteira TON primeiro!";
                return;
            }
            const clienteAddress = connectedWallet.account.address;

            const valorObra = await verificarGoogleSheets(numeroObra, senha);
            if (valorObra === 0) {
                document.getElementById('resultado').innerText = "N√∫mero da Obra ou Senha inv√°lidos!";
                return;
            }

            const cashback = valorObra * 0.03;
            const wallet5000Seed = process.env.WALLET5000_SEED;
            const provider = new TonWeb.HttpProvider('https://toncenter.com/api/v2/jsonRPC');
            const wallet5000 = TonWeb.WalletProvider.fromSeed(wallet5000Seed.split(''), provider);

            const saldoNano = await wallet5000.getBalance();
            const saldo = TonWeb.utils.fromNano(saldoNano);

            if (cashback > saldo) {
                document.getElementById('resultado').innerText = "O numero que voc√™ est√° solicitando √© maior do que temos na nossa wallet semente, um email foi enviado para o Engenheiro Kioma que j√° tem acesso ao saldo solicitado e ao numero da sua wallet e ele enviar√° em at√© 24h o saldo solicitado";
                enviarEmail("O cashback que o cliente est√° solicitando no modo manual √© maior que o que tem na wallet, reponha os tokens da wallet");
            } else {
                // Envio real de tokens MAEOKA
                const tokenAddress = 'EQCUgsVus4fW5TY2bxBQWSyiwLETOr2iNlVied-szVuJ1t4W';
                const jettonMinter = new TonWeb.token.jetton.JettonMinter(provider, { address: tokenAddress });
                const wallet5000JettonAddress = await jettonMinter.getJettonWalletAddress(wallet5000.address);
                const jettonWallet = new TonWeb.token.jetton.JettonWallet(provider, { address: wallet5000JettonAddress });

                const jettonAmount = TonWeb.utils.toNano(cashback.toString());
                const forwardAmount = TonWeb.utils.toNano('0.01');

                const transferBody = await jettonWallet.createTransferBody({
                    jettonAmount: jettonAmount,
                    toAddress: new TonWeb.utils.Address(clienteAddress),
                    forwardAmount: forwardAmount,
                    forwardPayload: new TextEncoder().encode(`Cashback obra ${numeroObra}`),
                    responseAddress: wallet5000.address
                });

                const transaction = {
                    validUntil: Date.now() + 5 * 60 * 1000,
                    messages: [{
                        address: wallet5000JettonAddress.toString(true, true, true),
                        amount: TonWeb.utils.toNano('0.05').toString(),
                        payload: TonWeb.utils.bytesToBase64(await transferBody.toBoc())
                    }]
