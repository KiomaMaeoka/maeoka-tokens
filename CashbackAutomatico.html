<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashback Autom√°tico - Maeoka Engenharia</title>
    <style>
        body { font-family: Arial, sans-serif; background: #1a3a52; color: #fff; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; background: #2c5282; padding: 20px; border-radius: 10px; }
        input, button { width: 100%; padding: 10px; margin: 10px 0; }
        button { background: #fff; color: #1a3a52; border: none; cursor: pointer; }
        #resultado { margin-top: 10px; }
    </style>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>üéÅ Cashback Autom√°tico</h2>
        <div>Dados da Indica√ß√£o</div>
        <input id="numeroObra" placeholder="N√∫mero da Obra">
        <input id="senhaRecompensa" type="password" placeholder="Senha da Recompensa">
        <div id="tonConnectButton"></div>
        <button onclick="solicitarCashback()">Solicitar (Gr√°tis)</button>
        <div id="resultado"></div>
    </div>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    <script>
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
            buttonRootId: 'tonConnectButton'
        });

        async function solicitarCashback() {
            const numeroObra = document.querySelector('#numeroObra').value;
            const senha = document.querySelector('#senhaRecompensa').value;

            const connectedWallet = tonConnectUI.wallet;
            if (!connectedWallet) {
                document.getElementById('resultado').innerText = "Conecte sua carteira TON primeiro!";
                return;
            }
            const clienteAddress = connectedWallet.account.address;

            const valorObra = await verificarGoogleSheets(numeroObra, senha);
            if (valorObra === 0) {
                document.getElementById('resultado').innerText = "N√∫mero da Obra ou Senha inv√°lidos!";
                return;
            }

            const cashback = valorObra * 0.03;
            const saldoSimulado = 5000; // Ainda simula√ß√£o

            if (cashback > saldoSimulado) {
                document.getElementById('resultado').innerText = "O numero que voc√™ est√° solicitando √© maior do que temos na nossa wallet semente, um email foi enviado para o Engenheiro Kioma que j√° tem acesso ao saldo solicitado e ao numero da sua wallet e ele enviar√° em at√© 24h o saldo solicitado";
                enviarEmail("O cashback que o cliente est√° solicitando no modo manual √© maior que o que tem na wallet, reponha os tokens da wallet");
            } else {
                document.getElementById('resultado').innerText = "Cashback de " + cashback + " MAEOKA enviado para " + clienteAddress + " (Simula√ß√£o)";
            }
        }

        async function verificarGoogleSheets(numero, senha) {
            const url = "https://script.google.com/macros/s/AKfycbwjWo5GQcanL20HnDuEkS3gqMedVIRNDaWPtSqP7AOZgkrZLdtEMuiEWALgWCcFa4D5wQ/exec?numero=" + encodeURIComponent(numero) + "&senha=" + encodeURIComponent(senha);
            const response = await fetch(url);
            const valor = await response.text();
            return parseFloat(valor) || 0;
        }

        function enviarEmail(mensagem) {
            console.log("Email enviado: " + mensagem);
        }
    </script>
</body>
</html>
