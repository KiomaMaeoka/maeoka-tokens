<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato Digital - Maeoka Engenharia</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- TON (The Open Network) Libraries for Crypto Payments -->
    <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CONFIGURAÇÃO DE FONTES E PALETA DE CORES --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5; /* Fundo cinza claro */
            color: #1f2937; /* Texto cinza escuro */
        }

        h1, h2, h3, h4, h5, h6, .font-display {
            font-family: 'Playfair Display', serif;
        }

        /* --- TRANSIÇÕES DE PÁGINA E ANIMAÇÕES --- */
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            transform: translateY(10px);
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* --- ESTILOS DO STEPPER MODERNO --- */
        .stepper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 2rem 0;
        }
        .stepper::before {
            content: '';
            position: absolute;
            top: 18px; /* Centraliza com o número */
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e5e7eb; /* gray-200 */
            z-index: 1;
        }
        .stepper-progress {
            position: absolute;
            top: 18px; /* Centraliza com o número */
            left: 0;
            height: 2px;
            background-color: #3b82f6; /* blue-500 */
            z-index: 2;
            transition: width 0.5s ease-in-out;
        }
        .step {
            position: relative;
            z-index: 3;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.3s;
            width: 80px; /* Largura fixa para evitar quebra de linha */
        }
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s, transform 0.3s;
            border: 2px solid #d1d5db; /* gray-300 */
            background-color: #ffffff;
            color: #6b7280; /* gray-500 */
        }
        .step-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            transition: color 0.3s, font-weight 0.3s;
        }
        .step.active .step-number {
            background-color: #3b82f6; /* blue-500 */
            border-color: #3b82f6;
            color: #ffffff;
            transform: scale(1.1);
        }
        .step.active .step-label {
            color: #1e3a8a; /* blue-900 */
            font-weight: 600;
        }
        .step.completed .step-number {
            background-color: #16a34a; /* green-600 */
            border-color: #16a34a;
            color: #ffffff;
        }
        .step.completed:hover .step-number {
            transform: scale(1.1);
        }
        .step.completed .step-label {
            color: #15803d; /* green-700 */
        }
        .step.future {
            cursor: default;
            opacity: 0.6;
        }

        /* --- ESTILOS DE FORMULÁRIO PERSONALIZADOS --- */
        .form-input {
            @apply w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 shadow-sm;
        }
        
        /* --- ESTILOS DE BOTÃO PERSONALIZADOS --- */
        .btn {
            @apply w-full text-lg font-semibold py-4 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 flex items-center justify-center gap-2;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white hover:bg-gray-700;
        }
        .btn-success {
            @apply bg-green-600 text-white hover:bg-green-700;
        }
        .btn-danger {
            @apply bg-red-600 text-white hover:bg-red-700;
        }
        .btn:disabled {
            @apply bg-gray-400 cursor-not-allowed transform-none shadow-none opacity-70;
        }

        /* --- ESTILOS DO MODAL --- */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(31, 41, 55, 0.6); /* gray-800 com opacidade */
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        
        /* --- SCROLLBAR PERSONALIZADA PARA OS TERMOS --- */
        #termsContainer::-webkit-scrollbar {
            width: 8px;
        }
        #termsContainer::-webkit-scrollbar-track {
            background: #e5e7eb; /* gray-200 */
        }
        #termsContainer::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden min-h-[80vh]">
            
            <header class="bg-gradient-to-br from-gray-900 to-gray-700 text-white text-center p-8 md:p-12">
                <h1 class="text-4xl md:text-6xl font-display tracking-tight mb-2">MAEOKA ENGENHARIA</h1>
                <p class="text-sm md:text-base opacity-80 tracking-wider">CNPJ: 19.924.627/0001-67 • Eng. Kioma Maeoka (CREA 159.328/D-PR)</p>
            </header>

            <div class="p-6 md:p-10 border-b border-gray-200">
                <div class="stepper" id="stepper">
                    <div class="stepper-progress" id="stepper-progress-bar"></div>
                    <div class="step" data-step="1" onclick="showPage(1)"><div class="step-number">1</div><span class="step-label">Proposta</span></div>
                    <div class="step" data-step="2" onclick="showPage(2)"><div class="step-number">2</div><span class="step-label">Termos</span></div>
                    <div class="step" data-step="3" onclick="showPage(3)"><div class="step-number">3</div><span class="step-label">Pagamento</span></div>
                    <div class="step" data-step="4" onclick="showPage(4)"><div class="step-number">4</div><span class="step-label">Dados</span></div>
                    <div class="step" data-step="5" onclick="showPage(5)"><div class="step-number">5</div><span class="step-label">Finalizar</span></div>
                </div>
            </div>

            <main class="p-6 md:p-10">
                
                <!-- PÁGINA 1: PROPOSTA -->
                <div class="page active" id="page1">
                    <h2 class="text-4xl md:text-5xl font-display text-gray-800 text-center mb-8">Proposta de Serviços</h2>
                    
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 mb-8 text-sm">
                        <p><strong class="font-semibold text-gray-700">Cliente:</strong> Thiago</p>
                        <p class="mt-1"><strong class="font-semibold text-gray-700">Endereço da Obra:</strong> R. Eponino Macuco, 185 - Curitiba/PR</p>
                        <p class="mt-1"><strong class="font-semibold text-gray-700">Data:</strong> <span id="currentDate"></span></p>
                    </div>

                    <h3 class="text-2xl font-display text-gray-700 mb-6 border-b pb-3">Serviços Contratados</h3>
                    <div class="space-y-4 mb-8">
                        <!-- Itens de serviço são inseridos aqui dinamicamente pelo JS -->
                    </div>
                    <div class="bg-slate-100 text-slate-800 font-bold text-center py-4 mt-6 rounded-lg text-xl" id="subtotalServicos"></div>

                    <div class="grid md:grid-cols-2 gap-8 mt-8">
                        <div class="bg-green-50 border-t-4 border-green-500 rounded-b-lg p-6 shadow-lg">
                            <h4 class="text-xl font-display text-gray-800 mb-4">Serviços Inclusos</h4>
                            <ul class="space-y-3 text-sm">
                                <li class="flex items-start gap-3"><i class="fa-solid fa-check-circle text-green-600 mt-1"></i><div><strong class="font-semibold">Anotação de Responsabilidade Técnica (ART)</strong><p class="text-gray-600">Registro junto ao CREA-PR</p></div></li>
                                <li class="flex items-start gap-3"><i class="fa-solid fa-check-circle text-green-600 mt-1"></i><div><strong class="font-semibold">Gerenciamento de Obra</strong><p class="text-gray-600">Acompanhamento técnico completo</p></div></li>
                            </ul>
                        </div>
                        <div class="bg-blue-50 border-t-4 border-blue-500 rounded-b-lg p-6 shadow-lg">
                            <h4 class="text-xl font-display text-gray-800 mb-4">Materiais Inclusos</h4>
                            <ul class="space-y-3 text-sm">
                                <li class="flex items-start gap-3"><i class="fa-solid fa-box text-blue-600 mt-1"></i><div><strong class="font-semibold">Agregados</strong><p class="text-gray-600">Areia, cimento e brita</p></div></li>
                                <li class="flex items-start gap-3"><i class="fa-solid fa-box text-blue-600 mt-1"></i><div><strong class="font-semibold">Impermeabilização</strong><p class="text-gray-600">Manta asfáltica e primer</p></div></li>
                                <li class="flex items-start gap-3"><i class="fa-solid fa-box text-blue-600 mt-1"></i><div><strong class="font-semibold">Assentamento</strong><p class="text-gray-600">Argamassa e espaçadores</p></div></li>
                            </ul>
                            <div class="bg-slate-200 text-slate-800 font-bold text-center py-3 mt-4 rounded-lg text-md" id="subtotalMateriais"></div>
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-200 rounded-xl p-6 mt-8">
                        <h4 class="text-xl font-display text-amber-800 mb-4">Observações Importantes</h4>
                        <ul id="importantObservations" class="list-disc list-inside text-sm text-gray-700 space-y-2">
                            <li>Materiais inclusos no valor da proposta</li>
                            <li>Não inclui taxas de condomínio para aprovação</li>
                            <li>Proposta válida por 30 dias</li>
                            <li>Garantia: 12 meses para vícios de execução</li>
                            <li>Caçamba não inclusa (custo aprox. R$ 450,00)</li>
                            <li>Local: 4º andar sem elevador</li>
                        </ul>
                    </div>
                    
                    <div class="bg-slate-100 rounded-xl p-6 mt-8">
                        <h3 class="text-xl font-display text-gray-800 mb-5">Emissão de Nota Fiscal</h3>
                        <div class="flex flex-col space-y-4 text-sm text-gray-700">
                            <label class="flex items-center cursor-pointer p-3 rounded-lg transition-all hover:bg-slate-200">
                                <input type="radio" name="invoiceOption" value="condominio" onchange="updateCalculations()" checked class="mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300">
                                Não será necessário nota fiscal, o condomínio fica a cargo deste item.
                            </label>
                            <label class="flex items-center cursor-pointer p-3 rounded-lg transition-all hover:bg-slate-200">
                                <input type="radio" name="invoiceOption" value="emitir" onchange="updateCalculations()" class="mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300">
                                Será necessário emitir nota fiscal (acréscimo de 17% sobre o valor final).
                            </label>
                        </div>
                    </div>

                    <div class="bg-gray-800 text-white rounded-xl p-8 text-center mt-8">
                        <h3 class="text-2xl font-display mb-2 opacity-80">Valor Total do Investimento</h3>
                        <p class="text-lg line-through opacity-60" id="originalPriceDisplay"></p>
                        <div class="text-6xl font-bold my-2 tracking-tighter" id="finalPriceDisplay"></div>
                        <p class="text-sm opacity-70 italic" id="discountExplanation"></p>
                        <p class="text-sm opacity-70 mt-4">Prazo de Execução: 18-22 dias úteis</p>
                    </div>

                    <div class="mt-10">
                        <button class="btn btn-primary" onclick="nextPage()">
                            Aceitar e Continuar <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- PÁGINA 2: TERMOS -->
                <div class="page" id="page2">
                    <h2 class="text-4xl md:text-5xl font-display text-gray-800 text-center mb-8">Termos e Condições</h2>
                    <p class="text-center text-gray-600 mb-8 bg-slate-50 p-6 rounded-lg border-l-4 border-blue-300">
                        Para garantir total transparência, detalhamos abaixo os pontos de ciência e responsabilidade sobre o processo de reforma.
                    </p>
                    
                    <div class="bg-white rounded-lg p-6 md:p-8 shadow-inner border border-gray-200 space-y-8 max-h-[500px] overflow-y-auto" id="termsContainer">
                        <div>
                            <h3 class="text-xl font-display text-gray-800 mb-3">Proteção de Móveis e Objetos</h3>
                            <ul class="space-y-3 text-sm text-gray-700 list-disc list-inside">
                                <li>Nossa equipe fará a proteção dos móveis conforme padrão do mercado.</li>
                                <li class="bg-red-50 text-red-800 p-3 rounded-md border border-red-200"><strong class="font-semibold">Importante:</strong> Após a proteção ser instalada, o cliente deve verificar e aprovar se está adequada.</li>
                                <li>Uma vez aprovada a proteção pelo cliente, a responsabilidade por eventuais danos fica transferida.</li>
                                <li>Mesmo com toda proteção, reformas envolvem riscos de batidas, respingos ou pequenos impactos.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-display text-gray-800 mb-3">Objetos de Valor</h3>
                            <ul class="space-y-3 text-sm text-gray-700 list-disc list-inside">
                                <li class="bg-amber-50 text-amber-800 p-3 rounded-md border border-amber-200"><strong class="font-semibold">Obrigatório:</strong> Itens de grande valor (financeiro ou sentimental) devem ser removidos do ambiente.</li>
                                <li><strong class="font-semibold">Apenas quando for impossível remover:</strong> guardar em cômodo que não será reformado ou solicitar isolamento especial.</li>
                                <li>A empresa não se responsabiliza por objetos de valor que permaneceram no local mesmo após orientação.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-display text-gray-800 mb-3">Durante a Execução</h3>
                            <ul class="space-y-3 text-sm text-gray-700 list-disc list-inside">
                                <li>Geração de pó é inevitável, mesmo com proteção.</li>
                                <li><strong class="font-semibold">4º andar sem elevador:</strong> Transporte de materiais será feito pela escada, o que pode gerar ruídos e movimentação nas áreas comuns.</li>
                                <li>A reorganização final dos móveis não está incluída no serviço.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-6 mt-8 flex items-start gap-4">
                        <input type="checkbox" id="agreeTerms" onchange="checkTermsAgreement()" class="mt-1 h-6 w-6 text-amber-600 focus:ring-amber-500 border-gray-300 rounded" disabled>
                        <label for="agreeTerms" class="text-sm cursor-pointer text-gray-700">
                            <strong class="font-semibold">Li e estou de acordo com os Termos de Ciência e Responsabilidade acima.</strong>
                        </label>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 mt-10">
                        <button class="btn btn-secondary" onclick="prevPage()">
                            <i class="fa-solid fa-arrow-left"></i> Voltar
                        </button>
                        <button class="btn btn-primary" id="confirmTermsBtn" onclick="nextPage()" disabled>
                            Confirmar e Avançar <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- PÁGINA 3: PAGAMENTO -->
                <div class="page" id="page3">
                    <h2 class="text-4xl md:text-5xl font-display text-gray-800 text-center mb-8">Opções de Pagamento</h2>
                    
                    <div class="bg-gray-800 text-white rounded-xl p-8 text-center mt-8 mb-10">
                        <h3 class="text-2xl font-display mb-2 opacity-80">Valor Total do Investimento</h3>
                        <p class="text-lg line-through opacity-60" id="originalPriceDisplayPage3"></p>
                        <div class="text-6xl font-bold my-2 tracking-tighter" id="finalPriceDisplayPage3"></div>
                        <p class="text-sm opacity-70 italic" id="discountExplanationPage3"></p>
                    </div>

                    <div id="mainPaymentChoices">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center">
                            <div class="bg-white border border-gray-200 hover:border-blue-500 hover:shadow-xl p-8 rounded-lg cursor-pointer transition-all duration-300 transform hover:-translate-y-2" onclick="showCashPayment()">
                                <i class="fa-solid fa-money-bill-wave text-4xl text-blue-500 mb-4"></i>
                                <h4 class="text-xl font-display text-gray-800 mb-2">Pagamento Padrão</h4>
                                <p class="text-sm text-gray-600">Condições tradicionais via PIX, parcelado por medição.</p>
                            </div>
                            <div class="bg-white border border-gray-200 hover:border-green-500 hover:shadow-xl p-8 rounded-lg cursor-pointer transition-all duration-300 transform hover:-translate-y-2" onclick="showTokenPayment()">
                                <i class="fa-brands fa-bitcoin text-4xl text-green-500 mb-4"></i>
                                <h4 class="text-xl font-display text-gray-800 mb-2">Pagamento com Tokens</h4>
                                <p class="text-sm text-gray-600">Use até 40% em tokens MAEOKA e ganhe 10% de desconto.</p>
                            </div>
                        </div>
                        <div id="mainBackBtnContainer" class="flex justify-start mt-10">
                            <button class="btn btn-secondary w-auto px-10" onclick="prevPage()">
                                <i class="fa-solid fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                    </div>

                    <!-- Seção Pagamento Padrão -->
                    <div class="hidden" id="cashPaymentContent">
                        <h3 class="text-2xl font-display text-gray-700 mb-6">Condições de Pagamento Padrão</h3>
                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-8">
                            <ul class="list-disc list-inside text-base text-gray-700 space-y-3" id="cashPaymentSchedule">
                                <!-- Cronograma de pagamento inserido pelo JS -->
                            </ul>
                        </div>
                        <div class="flex flex-col md:flex-row gap-4 mt-10">
                            <button class="btn btn-secondary" onclick="hideAllPaymentSections()"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
                            <button class="btn btn-primary" onclick="nextPage()">Continuar com Pagamento Padrão <i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                    </div>

                    <!-- Seção Pagamento com Tokens -->
                    <div class="hidden" id="tokenPaymentContent">
                        <h3 class="text-2xl font-display text-gray-700 mb-4">Pagamento com Tokens MAEOKA</h3>
                        <div class="text-center p-4 rounded-lg mb-6 transition-all" id="statusCarteira">
                            <i class="fa-solid fa-wallet mr-2"></i> Conecte sua carteira para pagar com tokens
                        </div>
                        <div id="tonConnectButton" class="flex justify-center my-6"></div>
                        
                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 mt-6 hidden" id="walletInfo">
                            <h5 class="text-lg font-display text-gray-800">Sua Carteira</h5>
                            <p class="text-sm mt-2"><strong>Endereço:</strong></p>
                            <div class="bg-gray-100 text-xs font-mono p-2 rounded break-all border mt-1" id="enderecoCarteira"></div>
                            <p class="text-sm mt-2"><strong>Saldo:</strong> <span id="saldoTokens" class="font-bold">0 MAEOKA</span></p>
                        </div>

                        <div class="bg-slate-50 p-6 rounded-lg border border-slate-200 mt-6 hidden" id="calculadoraTokens">
                            <h5 class="text-xl font-display text-gray-800 mb-1">Calculadora de Pagamento</h5>
                            <p class="text-sm text-gray-600 mb-4">Use até <strong class="text-blue-700">40%</strong> do valor em tokens e ganhe <strong class="text-green-600">10% de desconto</strong> sobre o valor usado.</p>
                            
                            <div class="mb-4">
                                <label for="tokenInput" class="block text-sm font-semibold text-gray-800 mb-2">Tokens a usar:</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" min="0" max="0" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="sliderTokens">
                                    <input type="number" id="tokenInput" min="0" max="0" value="0" class="w-32 p-2 border border-gray-300 rounded-lg text-sm text-center">
                                </div>
                            </div>

                            <div class="bg-white p-5 rounded-lg mt-6 border-l-4 border-blue-500 shadow-sm">
                                <h6 class="font-bold text-lg text-blue-800 mb-3">Resumo do Pagamento</h6>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between pb-1 border-b"><span class="text-gray-600">Valor original:</span><span id="valorOriginalObra"></span></div>
                                    <div class="flex justify-between pb-1 border-b"><span class="text-gray-600">Tokens a usar:</span><span class="font-semibold" id="resumoTokens">0 MAEOKA (R$ 0,00)</span></div>
                                    <div class="flex justify-between pb-1 border-b"><span class="text-gray-600">Desconto de 10%:</span><span class="text-green-600 font-semibold" id="resumoDesconto">- R$ 0,00</span></div>
                                    <div class="flex justify-between pb-1 border-b"><span class="text-gray-600">Valor em dinheiro:</span><span class="font-semibold" id="resumoDinheiro"></span></div>
                                    <div class="flex justify-between pt-3 border-t-2 border-blue-500 text-lg font-bold"><span class="font-display">Total a Pagar:</span><span id="resumoTotal"></span></div>
                                    <div class="flex justify-between pt-2 text-green-600 font-bold text-lg"><span class="font-display">Sua Economia:</span><span id="resumoEconomia">R$ 0,00</span></div>
                                </div>
                            </div>
                            
                            <button class="btn btn-success mt-6" id="btnEnviarTokens" onclick="enviarTokens()"></button>
                        </div>
                        
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-5 mt-6 shadow-sm hidden" id="adjustedPaymentConditions">
                            <h4 class="text-xl font-display text-amber-800 mb-4">Condições (Valor Restante em Dinheiro)</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2" id="tokenPaymentSchedule">
                                <!-- Cronograma de pagamento ajustado inserido pelo JS -->
                            </ul>
                            <div class="bg-green-100 text-green-800 p-3 rounded-lg mt-4 text-sm font-semibold border border-green-300">
                                <i class="fa-solid fa-gift mr-2"></i><strong>Cashback:</strong> Você receberá <span id="cashbackInfo">0</span> MAEOKA de volta!
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 mt-10">
                            <button class="btn btn-secondary" onclick="hideAllPaymentSections()"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
                            <button class="btn btn-primary" id="continueTokenBtn" disabled onclick="nextPage()">Continuar <i class="fa-solid fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>

                <!-- PÁGINA 4: DADOS -->
                <div class="page" id="page4">
                    <h2 class="text-4xl md:text-5xl font-display text-gray-800 text-center mb-8">Dados do Contratante</h2>
                    <form id="clientForm" class="space-y-6" novalidate>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo *</label>
                                <input type="text" id="fullName" name="fullName" autocomplete="name" required class="form-input">
                                <p class="text-red-500 text-xs mt-1 hidden" id="fullNameError">Campo obrigatório</p>
                            </div>
                            <div>
                                <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF *</label>
                                <input type="text" id="cpf" name="cpf" autocomplete="off" required placeholder="000.000.000-00" class="form-input">
                                <p class="text-red-500 text-xs mt-1 hidden" id="cpfError">CPF inválido</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail *</label>
                                <input type="email" id="email" name="email" autocomplete="email" required class="form-input">
                                <p class="text-red-500 text-xs mt-1 hidden" id="emailError">E-mail inválido</p>
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone/WhatsApp *</label>
                                <input type="tel" id="phone" name="phone" autocomplete="tel" required placeholder="(41) 99999-9999" class="form-input">
                                <p class="text-red-500 text-xs mt-1 hidden" id="phoneError">Telefone inválido</p>
                            </div>
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço de Domicílio *</label>
                            <textarea id="address" name="address" rows="3" autocomplete="street-address" required placeholder="Rua, número, bairro, cidade" class="form-input"></textarea>
                            <p class="text-red-500 text-xs mt-1 hidden" id="addressError">Campo obrigatório</p>
                        </div>
                        <div>
                            <label for="observations" class="block text-sm font-medium text-gray-700 mb-1">Observações Adicionais</label>
                            <textarea id="observations" name="observations" rows="3" placeholder="Alguma informação adicional importante..." class="form-input"></textarea>
                        </div>
                        
                        <div class="bg-slate-100 rounded-lg p-6 text-sm text-gray-700">
                            <h4 class="text-lg font-display text-gray-900 mb-3">Proteção de Dados (LGPD)</h4>
                            <p class="leading-relaxed">Seus dados serão utilizados exclusivamente para a execução do contrato, comunicação sobre a obra e cumprimento de obrigações legais, conforme a Lei Geral de Proteção de Dados (Lei 13.709/2018).</p>
                            <div class="mt-4 flex items-start gap-3">
                                <input type="checkbox" id="lgpdAccepted" required class="mt-1 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="lgpdAccepted" class="cursor-pointer"><strong class="font-semibold">Autorizo o tratamento dos meus dados pessoais pela Maeoka Engenharia.</strong></label>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-4 mt-10">
                            <button type="button" class="btn btn-secondary" onclick="prevPage()"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>Finalizar Contratação <i class="fa-solid fa-file-signature"></i></button>
                        </div>
                    </form>
                </div>

                <!-- PÁGINA 5: FINALIZAÇÃO -->
                <div class="page" id="page5">
                    <div class="text-center">
                        <div class="text-8xl text-green-500 mb-4"><i class="fa-solid fa-circle-check"></i></div>
                        <h2 class="text-4xl md:text-5xl font-display text-gray-800">Contratação Realizada!</h2>
                        <p class="text-lg text-gray-600 mt-2 mb-8">Obrigado por escolher a Maeoka Engenharia. Estamos ansiosos para começar.</p>
                    </div>

                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 mb-8">
                        <h3 class="text-xl font-display text-gray-800 mb-4">Resumo Final</h3>
                        <div id="finalSummary" class="text-sm space-y-2 text-gray-700"></div>
                        <div class="mt-4 pt-4 border-t border-slate-200">
                            <p><strong>Protocolo:</strong> <span id="protocolNumber" class="font-mono text-blue-700"></span></p>
                            <p><strong>Data/Hora:</strong> <span id="contractDateTime" class="font-mono"></span></p>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
                        <h3 class="text-xl font-display text-gray-800 mb-4">Próximos Passos</h3>
                        <ul class="space-y-3">
                            <li class="flex items-center gap-3"><span class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-500 text-white font-bold">1</span><span>Baixe o documento gerado para seus arquivos.</span></li>
                            <li class="flex items-center gap-3"><span class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-500 text-white font-bold">2</span><span>Nossa equipe entrará em contato via WhatsApp para agendar a vistoria técnica.</span></li>
                            <li class="flex items-center gap-3"><span class="flex items-center justify-center h-8 w-8 rounded-full bg-blue-500 text-white font-bold">3</span><span>Definiremos o cronograma detalhado e a data de início da obra.</span></li>
                        </ul>
                    </div>
                    
                    <div id="systemStatus" class="p-4 rounded-lg mt-6 text-sm text-center">
                        <p id="statusMessage"></p>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 mt-10">
                        <button class="btn btn-danger" onclick="downloadContractHTML()">
                            <i class="fa-solid fa-file-arrow-down"></i> Baixar Documento
                        </button>
                        <button class="btn btn-secondary" onclick="restartProcess()">
                            <i class="fa-solid fa-redo"></i> Nova Contratação
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL UNIVERSAL -->
    <div id="llmModal" class="modal hidden" tabindex="-1" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-11/12 max-w-lg relative m-4">
            <button class="absolute top-4 right-4 text-gray-400 text-2xl hover:text-gray-800 transition-colors" aria-label="Fechar modal" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
            <h3 id="modalTitle" class="text-2xl font-display text-gray-800 text-center mb-4"></h3>
            <div id="modalBody" class="text-sm text-gray-700 leading-relaxed max-h-96 overflow-y-auto"></div>
            <div id="modalButtons" class="mt-6 flex justify-end gap-4"></div>
        </div>
    </div>

<script>
// --- CONFIGURAÇÕES GLOBAIS E ESTADO DA APLICAÇÃO ---
const CONFIG = {
    TOKEN_MAEOKA_ADDRESS: 'EQCUgsVus4fW5TY2bxBQWSyiwLETOr2iNlVied-szVuJ1t4W',
    APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwovnJtN76EfqzykncamVAvszSve0JMzrw7gU7kAPIF6MJBmkf9-XSmP1z2KjBwsWBN8Q/exec',
    CARTEIRA_MAEOKA_OFICIAL: 'UQCI80_zNVLySHf1DZbxfVw52DMPQj8EAOMcDn9TlvsjC341',
    LIMITE_PERCENTUAL_TOKENS: 0.40,
    TAXA_NF: 0.17, // 17%
    CASHBACK_PERCENTUAL: 0.03, // 3%
    SERVICOS: [
        { nome: "Demolição - Remover Revestimento e Contra-Piso existente.", area: "Área: 100,93 m² • Com retirada de entulho até caçamba", preco: 6333.33 },
        { nome: "Regularização/nivelamento", area: "Argamassa de regularização e caimento para ralos (min. 1%)", preco: 7125.00 },
        { nome: "Aplicação de Primer e Manta asfáltica", area: "Nas áreas de recreação 1 e 2", preco: 5541.67 },
        { nome: "Executar Contrapiso", area: "Proteção mecânica - Argamassa de proteção de 3-5cm sobre a manta", preco: 11875.00 },
        { nome: "Instalar Revestimento Cerâmico/Porcelanato", area: "Nas áreas de recreação 1 e 2 (porcelanato até 90x90)", preco: 7125.00 }
    ],
    VALOR_MATERIAIS: 28031.00,
    TOTAL_PAGES: 5
};

let state = {
    currentPage: 1,
    highestStepCompleted: 1,
    valorBaseObra: 0,
    valorFinalObra: 0,
    metodoPagamento: null, // 'cash' ou 'tokens'
    ton: {
        sdk: null,
        connectUI: null,
        saldoUsuario: 0,
        enderecoUsuario: ''
    },
    form: {
        emiteNF: false,
        tokensAUsar: 0
    },
    contractData: {}
};

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', () => {
    // Inicializa o estado da aplicação
    state.valorBaseObra = CONFIG.SERVICOS.reduce((acc, s) => acc + s.preco, 0) + CONFIG.VALOR_MATERIAIS;
    
    // Inicializa bibliotecas e UI
    initializeTonWeb();
    renderServices();
    updateCalculations();
    applyMasks();
    loadDraft();
    showPage(1);

    // Adiciona event listeners
    document.getElementById('clientForm').addEventListener('submit', (e) => {
        e.preventDefault();
        nextPage();
    });
    document.getElementById('clientForm').addEventListener('input', debounce(validateForm, 300));
    sliderTokens.addEventListener('input', handleSliderInput);
    tokenInput.addEventListener('input', handleTokenInput);
});

// --- RENDERIZAÇÃO E UI ---
function renderServices() {
    const container = document.querySelector('#page1 .space-y-4');
    container.innerHTML = '';
    CONFIG.SERVICOS.forEach(servico => {
        const itemHTML = `
            <div class="bg-white border-l-4 border-blue-500 rounded-r-lg p-5 shadow-md transition-transform hover:scale-[1.02] service-item">
                <p class="font-semibold text-lg text-gray-800">${servico.nome}</p>
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-sm mt-2 text-gray-600 service-details">
                    <span>${servico.area}</span>
                    <span class="font-bold text-blue-700 text-lg price">${formatCurrency(servico.preco)}</span>
                </div>
            </div>`;
        container.innerHTML += itemHTML;
    });
    document.getElementById('subtotalServicos').textContent = `Subtotal Serviços: ${formatCurrency(CONFIG.SERVICOS.reduce((acc, s) => acc + s.preco, 0))}`;
    document.getElementById('subtotalMateriais').textContent = `Subtotal Materiais: ${formatCurrency(CONFIG.VALOR_MATERIAIS)}`;
}

function updateStepper() {
    const progressBar = document.getElementById('stepper-progress-bar');
    const progress = ((state.currentPage - 1) / (CONFIG.TOTAL_PAGES - 1)) * 100;
    progressBar.style.width = `${progress}%`;

    document.querySelectorAll('.step').forEach((step, index) => {
        const stepNumber = index + 1;
        step.classList.remove('active', 'completed', 'future');

        if (stepNumber < state.currentPage) {
            step.classList.add('completed');
        } else if (stepNumber === state.currentPage) {
            step.classList.add('active');
        } else {
            step.classList.add('future');
        }
        
        if (stepNumber > state.highestStepCompleted) {
            step.classList.add('future');
        } else {
            step.classList.remove('future');
        }
    });
}

function showPage(pageNumber) {
    if (pageNumber > state.highestStepCompleted) return;

    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page${pageNumber}`).classList.add('active');
    state.currentPage = pageNumber;
    updateStepper();
    window.scrollTo(0, 0);

    if (pageNumber === 2) setupTermsScroll();
    if (pageNumber === 3) updatePaymentPageDisplay();
}

// --- LÓGICA DE NAVEGAÇÃO ---
function nextPage() {
    // Validações específicas da página atual
    if (state.currentPage === 2 && !document.getElementById('agreeTerms').checked) {
        showModal('Aviso', 'Por favor, aceite os Termos de Ciência e Responsabilidade para continuar.');
        return;
    }
    if (state.currentPage === 4) {
        if (!validateForm(true)) return; // Pass true to show all errors
        finalizeContract();
    }

    // Avança para a próxima página
    if (state.currentPage < CONFIG.TOTAL_PAGES) {
        state.currentPage++;
        if (state.currentPage > state.highestStepCompleted) {
            state.highestStepCompleted = state.currentPage;
        }
        showPage(state.currentPage);
    }
}

function prevPage() {
    if (state.currentPage > 1) {
        state.currentPage--;
        showPage(state.currentPage);
    }
}

// --- CÁLCULOS E PAGAMENTOS ---
function updateCalculations() {
    state.form.emiteNF = document.querySelector('input[name="invoiceOption"]:checked').value === 'emitir';
    state.valorFinalObra = state.form.emiteNF ? state.valorBaseObra * (1 + CONFIG.TAXA_NF) : state.valorBaseObra;
    
    // Atualiza UI na Página 1
    document.getElementById('originalPriceDisplay').textContent = `Valor base: ${formatCurrency(state.valorBaseObra)}`;
    document.getElementById('finalPriceDisplay').textContent = formatCurrency(state.valorFinalObra);
    document.getElementById('discountExplanation').textContent = state.form.emiteNF 
        ? `Valor com acréscimo de ${CONFIG.TAXA_NF * 100}% para emissão de NF.`
        : `Valor final sem emissão de nota fiscal.`;
    
    updatePaymentPageDisplay();
    updateTokenCalculatorUI();
}

function updatePaymentPageDisplay() {
    // Atualiza UI na Página 3
    document.getElementById('originalPriceDisplayPage3').textContent = `Valor base: ${formatCurrency(state.valorBaseObra)}`;
    document.getElementById('finalPriceDisplayPage3').textContent = formatCurrency(state.valorFinalObra);
    document.getElementById('discountExplanationPage3').textContent = document.getElementById('discountExplanation').textContent;

    // Atualiza cronogramas de pagamento
    updatePaymentSchedule('cashPaymentSchedule', state.valorFinalObra);
    updatePaymentSchedule('tokenPaymentSchedule', state.valorFinalObra); // Inicializa com valor total
}

function updatePaymentSchedule(elementId, total) {
    const container = document.getElementById(elementId);
    const schedule = [
        { label: "Entrada", percent: 0.20 },
        { label: "1ª Medição - Demolição", percent: 0.25 },
        { label: "2ª Medição - Impermeabilização e Contrapiso", percent: 0.30 },
        { label: "3ª Medição - Instalação e rejunte", percent: 0.20 },
        { label: "Final - Conclusão", percent: 0.05 }
    ];
    container.innerHTML = schedule.map(item => 
        `<li><strong>${item.label}:</strong> ${item.percent * 100}% (${formatCurrency(total * item.percent)})</li>`
    ).join('') + `<li class="font-semibold text-blue-700 pt-2">Pagamentos via PIX</li>`;
}

// --- LÓGICA DE TOKENS ---
function initializeTonWeb() {
    try {
        state.ton.sdk = new TonWeb(new TonWeb.HttpProvider('https://toncenter.com/api/v2/jsonRPC'));
    } catch (error) {
        console.error('Erro ao inicializar TonWeb:', error);
    }
}

function initializeTonConnect() {
    if (state.ton.connectUI) return;
    try {
        state.ton.connectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
            buttonRootId: 'tonConnectButton'
        });
        state.ton.connectUI.onStatusChange(wallet => handleWalletStatusChange(wallet));
    } catch (error) {
        console.error('Erro ao inicializar TON Connect:', error);
    }
}

async function handleWalletStatusChange(wallet) {
    const statusEl = document.getElementById('statusCarteira');
    if (wallet) {
        statusEl.innerHTML = `<span class="spinner mr-2"></span> Carregando saldo...`;
        statusEl.className = 'bg-blue-100 text-blue-800 p-4 rounded-lg mb-6 transition-all';
        
        const address = new TonWeb.utils.Address(wallet.account.address);
        state.ton.enderecoUsuario = address.toString(true, true, false);
        document.getElementById('enderecoCarteira').textContent = state.ton.enderecoUsuario;
        document.getElementById('walletInfo').style.display = 'block';
        
        await fetchUserBalance();
    } else {
        state.ton.saldoUsuario = 0;
        state.ton.enderecoUsuario = '';
        statusEl.innerHTML = `<i class="fa-solid fa-wallet mr-2"></i>Conecte sua carteira para pagar com tokens`;
        statusEl.className = 'bg-amber-100 text-amber-800 p-4 rounded-lg mb-6 transition-all';
        document.getElementById('walletInfo').style.display = 'none';
        document.getElementById('calculadoraTokens').style.display = 'none';
    }
}

async function fetchUserBalance() {
    if (!state.ton.sdk || !state.ton.enderecoUsuario) return;
    const statusEl = document.getElementById('statusCarteira');
    try {
        const jettonMinter = new TonWeb.token.jetton.JettonMinter(state.ton.sdk.provider, { address: CONFIG.TOKEN_MAEOKA_ADDRESS });
        const userJettonWalletAddress = await jettonMinter.getJettonWalletAddress(new TonWeb.utils.Address(state.ton.enderecoUsuario));
        const jettonWallet = new TonWeb.token.jetton.JettonWallet(state.ton.sdk.provider, { address: userJettonWalletAddress });
        const jettonData = await jettonWallet.getData();
        state.ton.saldoUsuario = parseFloat(TonWeb.utils.fromNano(jettonData.balance));
        
        statusEl.innerHTML = `✅ Carteira Conectada - Saldo carregado!`;
        statusEl.className = 'bg-green-100 text-green-800 p-4 rounded-lg mb-6 transition-all';
    } catch (error) {
        console.warn('Carteira de Jetton provavelmente não existe, saldo é 0.', error);
        state.ton.saldoUsuario = 0;
        statusEl.innerHTML = `⚠️ Carteira conectada - Sem tokens MAEOKA`;
        statusEl.className = 'bg-amber-100 text-amber-800 p-4 rounded-lg mb-6 transition-all';
    }
    document.getElementById('saldoTokens').textContent = `${formatNumber(state.ton.saldoUsuario)} MAEOKA`;
    document.getElementById('calculadoraTokens').style.display = 'block';
    updateTokenCalculatorUI();
}

function updateTokenCalculatorUI() {
    const maxTokensPorLimite = state.valorFinalObra * CONFIG.LIMITE_PERCENTUAL_TOKENS;
    const maxTokens = Math.min(state.ton.saldoUsuario, maxTokensPorLimite);
    
    sliderTokens.max = Math.floor(maxTokens);
    tokenInput.max = Math.floor(maxTokens);

    if (state.ton.saldoUsuario === 0) {
        document.getElementById('calculadoraTokens').innerHTML = `
            <div class="bg-red-50 p-6 rounded-lg text-center border-2 border-red-300">
                <h3 class="text-xl font-bold text-red-800 mb-4"><i class="fa-solid fa-circle-exclamation mr-2"></i>SEM TOKENS MAEOKA</h3>
                <p class="text-gray-700">Sua carteira não possui tokens MAEOKA para usar nesta obra.</p>
            </div>`;
        document.getElementById('adjustedPaymentConditions').style.display = 'block';
        document.getElementById('continueTokenBtn').disabled = false;
        document.getElementById('continueTokenBtn').innerHTML = 'Continuar sem usar Tokens <i class="fa-solid fa-arrow-right"></i>';

    } else {
        document.getElementById('valorOriginalObra').textContent = formatCurrency(state.valorFinalObra);
        calculateTokenPayment();
    }
}

function calculateTokenPayment() {
    const tokensValue = state.form.tokensAUsar;
    const desconto = tokensValue * 0.10; // 10% de desconto sobre o valor dos tokens
    const valorDinheiro = state.valorFinalObra - tokensValue - desconto;
    const economiaTotal = tokensValue + desconto;

    document.getElementById('resumoTokens').textContent = `${formatNumber(tokensValue)} MAEOKA (${formatCurrency(tokensValue)})`;
    document.getElementById('resumoDesconto').textContent = `- ${formatCurrency(desconto)}`;
    document.getElementById('resumoDinheiro').textContent = formatCurrency(valorDinheiro);
    document.getElementById('resumoTotal').textContent = formatCurrency(valorDinheiro);
    document.getElementById('resumoEconomia').textContent = formatCurrency(economiaTotal);

    const btnEnviar = document.getElementById('btnEnviarTokens');
    if (tokensValue > 0) {
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i> Pagar com ${formatNumber(tokensValue)} Tokens`;
        document.getElementById('continueTokenBtn').disabled = true;
    } else {
        btnEnviar.disabled = true;
        btnEnviar.innerHTML = `Selecione a quantidade de tokens`;
        document.getElementById('continueTokenBtn').disabled = false;
        document.getElementById('continueTokenBtn').innerHTML = 'Continuar sem usar Tokens <i class="fa-solid fa-arrow-right"></i>';
    }
    
    document.getElementById('adjustedPaymentConditions').style.display = 'block';
    updatePaymentSchedule('tokenPaymentSchedule', valorDinheiro);
    document.getElementById('cashbackInfo').textContent = `${formatNumber(Math.floor(state.valorFinalObra * CONFIG.CASHBACK_PERCENTUAL))} MAEOKA`;
}

async function enviarTokens() {
    const tokensValue = state.form.tokensAUsar;
    if (tokensValue <= 0 || tokensValue > state.ton.saldoUsuario) {
        showModal('Erro', 'Quantidade de tokens inválida.');
        return;
    }

    const btn = document.getElementById('btnEnviarTokens');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner mr-2"></span> Processando...';

    try {
        const jettonMinter = new TonWeb.token.jetton.JettonMinter(state.ton.sdk.provider, { address: CONFIG.TOKEN_MAEOKA_ADDRESS });
        const userJettonWalletAddress = await jettonMinter.getJettonWalletAddress(new TonWeb.utils.Address(state.ton.enderecoUsuario));
        const jettonWallet = new TonWeb.token.jetton.JettonWallet(state.ton.sdk.provider, { address: userJettonWalletAddress });
        
        const transferBody = await jettonWallet.createTransferBody({
            jettonAmount: TonWeb.utils.toNano(tokensValue.toString()),
            toAddress: new TonWeb.utils.Address(CONFIG.CARTEIRA_MAEOKA_OFICIAL),
            forwardAmount: TonWeb.utils.toNano('0.01'),
            forwardPayload: new TextEncoder().encode(`Pagamento Obra - Protocolo Pendente`),
            responseAddress: new TonWeb.utils.Address(state.ton.enderecoUsuario)
        });

        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 300, // 5 minutes from now
            messages: [{
                address: userJettonWalletAddress.toString(),
                amount: TonWeb.utils.toNano('0.05').toString(),
                payload: TonWeb.utils.bytesToBase64(await transferBody.toBoc())
            }]
        };

        await state.ton.connectUI.sendTransaction(transaction);
        
        showModal('Sucesso', `✅ Pagamento com ${formatNumber(tokensValue)} tokens enviado! Agora você pode continuar.`);
        btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>Tokens Enviados!';
        btn.className = 'btn btn-success mt-6';
        document.getElementById('continueTokenBtn').disabled = false;
        document.getElementById('continueTokenBtn').innerHTML = 'Continuar para Próxima Etapa <i class="fa-solid fa-arrow-right"></i>';

    } catch (error) {
        console.error('Erro no envio de tokens:', error);
        btn.disabled = false;
        btn.innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i> Pagar com ${formatNumber(tokensValue)} Tokens`;
        showModal('Erro no Envio', error.message.includes('User declined') ? 'Transação cancelada pelo usuário.' : 'Ocorreu um erro durante a transação.');
    }
}

// --- LÓGICA DO FORMULÁRIO E FINALIZAÇÃO ---
function validateForm(showAllErrors = false) {
    const fields = {
        fullName: { value: document.getElementById('fullName').value.trim(), errorId: 'fullNameError', valid: (v) => v !== '' },
        cpf: { value: document.getElementById('cpf').value, errorId: 'cpfError', valid: (v) => validarCPF(v) },
        email: { value: document.getElementById('email').value.trim(), errorId: 'emailError', valid: (v) => /\S+@\S+\.\S+/.test(v) },
        phone: { value: document.getElementById('phone').value.replace(/\D/g, ''), errorId: 'phoneError', valid: (v) => v.length >= 10 },
        address: { value: document.getElementById('address').value.trim(), errorId: 'addressError', valid: (v) => v !== '' }
    };
    
    let isFormValid = true;
    for (const key in fields) {
        const field = fields[key];
        const isValid = field.valid(field.value);
        if (showAllErrors) {
            document.getElementById(field.errorId).classList.toggle('hidden', isValid);
        }
        if (!isValid) isFormValid = false;
    }

    const lgpdValid = document.getElementById('lgpdAccepted').checked;
    if (!lgpdValid) isFormValid = false;

    document.getElementById('submitBtn').disabled = !isFormValid;
    return isFormValid;
}

function finalizeContract() {
    const form = document.getElementById('clientForm');
    const desconto = state.form.tokensAUsar * 0.10;
    const valorFinalDinheiro = state.valorFinalObra - state.form.tokensAUsar - desconto;

    state.contractData = {
        protocol: `MAE-${new Date().toISOString().replace(/\D/g, '').slice(2, 14)}`,
        contractDate: new Date().toLocaleString('pt-BR'),
        fullName: form.elements['fullName'].value,
        cpf: form.elements['cpf'].value,
        email: form.elements['email'].value,
        phone: form.elements['phone'].value,
        address: form.elements['address'].value,
        observations: form.elements['observations'].value,
        metodoPagamento: state.metodoPagamento,
        valorTotalObra: state.valorFinalObra,
        tokensUsados: state.form.tokensAUsar,
        descontoAplicado: desconto,
        valorFinalDinheiro: valorFinalDinheiro,
        emiteNF: state.form.emiteNF
    };

    localStorage.setItem('currentContract', JSON.stringify(state.contractData));
    populateFinalPage();
    sendContractToAppsScript();
}

function populateFinalPage() {
    const { protocol, contractDate, fullName, cpf, metodoPagamento, valorTotalObra, tokensUsados, descontoAplicado, valorFinalDinheiro } = state.contractData;
    document.getElementById('protocolNumber').textContent = protocol;
    document.getElementById('contractDateTime').textContent = contractDate;
    
    let summaryHTML = `
        <p><strong>Nome:</strong> ${fullName}</p>
        <p><strong>CPF:</strong> ${cpf}</p>
        <p><strong>Método de Pagamento:</strong> ${metodoPagamento === 'tokens' ? 'Tokens + Dinheiro' : 'Padrão'}</p>
        <p><strong>Valor Total:</strong> ${formatCurrency(valorTotalObra)}</p>`;
    
    if (metodoPagamento === 'tokens') {
        summaryHTML += `
            <p><strong>Tokens Usados:</strong> ${formatNumber(tokensUsados)} MAEOKA</p>
            <p><strong>Valor Final em Dinheiro:</strong> ${formatCurrency(valorFinalDinheiro)}</p>
            <p class="text-green-600 font-semibold"><strong>Economia Total:</strong> ${formatCurrency(tokensUsados + descontoAplicado)}</p>`;
    }
    document.getElementById('finalSummary').innerHTML = summaryHTML;
}

async function sendContractToAppsScript() {
    const statusMessage = document.getElementById('statusMessage');
    const systemStatus = document.getElementById('systemStatus');
    statusMessage.innerHTML = '<span class="spinner mr-2" style="border-top-color: #3b82f6;"></span> Enviando contrato para Maeoka Engenharia...';
    systemStatus.className = 'bg-blue-100 text-blue-800 p-4 rounded-lg mt-6 text-sm text-center';
    
    try {
        // Usamos 'no-cors' pois o Apps Script geralmente não retorna headers CORS
        await fetch(CONFIG.APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contractData: state.contractData })
        });
        statusMessage.innerHTML = '✅ Contrato enviado com sucesso! Maeoka Engenharia foi notificada.';
        systemStatus.className = 'bg-green-100 text-green-800 p-4 rounded-lg mt-6 text-sm text-center';
    } catch (error) {
        console.error('Erro ao enviar para Apps Script:', error);
        statusMessage.innerHTML = '⚠️ Erro ao notificar a Maeoka. Por favor, baixe o documento e envie manualmente.';
        systemStatus.className = 'bg-red-100 text-red-800 p-4 rounded-lg mt-6 text-sm text-center';
    }
}

// --- FUNÇÕES AUXILIARES E MANIPULADORES DE EVENTOS ---
function handleSliderInput(e) {
    const value = e.target.valueAsNumber;
    tokenInput.value = value;
    state.form.tokensAUsar = value;
    calculateTokenPayment();
}

function handleTokenInput(e) {
    let value = e.target.valueAsNumber;
    const max = e.target.max;
    if (isNaN(value) || value < 0) value = 0;
    if (value > max) value = max;
    e.target.value = value;
    sliderTokens.value = value;
    state.form.tokensAUsar = value;
    calculateTokenPayment();
}

function showCashPayment() {
    document.getElementById('cashPaymentContent').style.display = 'block';
    document.getElementById('mainPaymentChoices').style.display = 'none';
    state.metodoPagamento = 'cash';
}
function showTokenPayment() {
    document.getElementById('tokenPaymentContent').style.display = 'block';
    document.getElementById('mainPaymentChoices').style.display = 'none';
    state.metodoPagamento = 'tokens';
    initializeTonConnect();
}
function hideAllPaymentSections() {
    document.getElementById('cashPaymentContent').style.display = 'none';
    document.getElementById('tokenPaymentContent').style.display = 'none';
    document.getElementById('mainPaymentChoices').style.display = 'block';
    state.metodoPagamento = null;
}

function setupTermsScroll() {
    const container = document.getElementById('termsContainer');
    const checkbox = document.getElementById('agreeTerms');
    checkbox.disabled = true;
    const checkScroll = () => {
        if (container.scrollHeight - container.scrollTop <= container.clientHeight + 5) {
            checkbox.disabled = false;
            container.removeEventListener('scroll', checkScroll);
        }
    };
    container.addEventListener('scroll', checkScroll);
    if (container.scrollHeight <= container.clientHeight) checkbox.disabled = false;
}

function checkTermsAgreement() {
    document.getElementById('confirmTermsBtn').disabled = !document.getElementById('agreeTerms').checked;
}

function saveDraft() {
    const draft = {
        fullName: document.getElementById('fullName').value,
        cpf: document.getElementById('cpf').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        address: document.getElementById('address').value,
        observations: document.getElementById('observations').value,
    };
    localStorage.setItem('contractDraft', JSON.stringify(draft));
}

function loadDraft() {
    const draft = JSON.parse(localStorage.getItem('contractDraft'));
    if (draft) {
        document.getElementById('fullName').value = draft.fullName || '';
        document.getElementById('cpf').value = draft.cpf || '';
        document.getElementById('email').value = draft.email || '';
        document.getElementById('phone').value = draft.phone || '';
        document.getElementById('address').value = draft.address || '';
        document.getElementById('observations').value = draft.observations || '';
    }
}

function restartProcess() {
    showModal('Reiniciar Contratação', 'Deseja iniciar uma nova contratação? Os dados atuais serão perdidos.', true, () => {
        localStorage.removeItem('currentContract');
        localStorage.removeItem('contractDraft');
        location.reload();
    });
}

// --- HELPERS ---
const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
const formatNumber = (value) => new Intl.NumberFormat('pt-BR', { maximumFractionDigits: 2 }).format(value);
const debounce = (func, wait) => {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
};

function applyMasks() {
    document.getElementById('cpf').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 11);
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = v;
    });
    document.getElementById('phone').addEventListener('input', (e) => {
        let v = e.target.value.replace(/\D/g, '').slice(0, 11);
        v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
        v = v.replace(/(\d{5})(\d)/, '$1-$2');
        e.target.value = v;
    });
}

function validarCPF(cpf) {
    cpf = String(cpf).replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    return true;
}

function showModal(title, message, isConfirm = false, callback = null) {
    document.getElementById('modalTitle').innerHTML = title;
    document.getElementById('modalBody').innerHTML = message;
    const modalButtons = document.getElementById('modalButtons');
    modalButtons.innerHTML = isConfirm 
        ? `<button class="btn btn-secondary px-6 py-2 text-base" onclick="closeModal()">Cancelar</button>
           <button class="btn btn-danger px-6 py-2 text-base" onclick="closeModal(); if(${callback}) ${callback}();">Confirmar</button>`
        : `<button class="btn btn-primary px-8 py-2 text-base" onclick="closeModal()">OK</button>`;
    document.getElementById('llmModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('llmModal').classList.add('hidden');
}

function downloadContractHTML() {
    const data = JSON.parse(localStorage.getItem('currentContract'));
    if (!data) {
        showModal('Erro', 'Não há dados de contrato para download.');
        return;
    }
    // Simplificado para brevidade, mas pode ser expandido para um template completo
    const htmlContent = `
    <!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><title>Contrato ${data.protocol}</title>
    <style>body{font-family:sans-serif;margin:20px;color:#333}.header{background:#1f2937;color:white;padding:20px;text-align:center}.section{margin:20px 0;padding:15px;border-left:4px solid #3b82f6}.sig{border-top:1px solid #333;width:80%;margin:40px auto 10px auto}</style>
    </head><body><div class="header"><h1>MAEOKA ENGENHARIA</h1></div><h2>CONTRATO DE PRESTAÇÃO DE SERVIÇOS</h2>
    <p><strong>Protocolo:</strong> ${data.protocol}</p><p><strong>Data:</strong> ${data.contractDate}</p>
    <div class="section"><h3>DADOS DO CONTRATANTE</h3><p><strong>Nome:</strong> ${data.fullName}</p><p><strong>CPF:</strong> ${data.cpf}</p></div>
    <div class="section"><h3>VALORES</h3><p><strong>Valor Total:</strong> ${formatCurrency(data.valorTotalObra)}</p>
    ${data.metodoPagamento === 'tokens'? `<p><strong>Valor em Dinheiro:</strong> ${formatCurrency(data.valorFinalDinheiro)}</p>` : ''}</div>
    <div style="margin-top:50px;text-align:center;"><div class="sig"></div><p>${data.fullName}</p><p>(Contratante)</p></div>
    <div style="margin-top:50px;text-align:center;"><div class="sig"></div><p>Maeoka Engenharia</p><p>(Contratada)</p></div>
    </body></html>`;
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Contrato_Maeoka_${data.protocol}.html`;
    a.click();
    URL.revokeObjectURL(url);
    showModal('Download Concluído', `Para gerar um PDF, abra o arquivo HTML e use a função "Imprimir" (Ctrl+P) do seu navegador para "Salvar como PDF".`);
}

// Preenche a data atual no início
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR');
</script>
</body>
</html>
