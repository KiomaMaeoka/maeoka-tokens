<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Contratação - Maeoka Engenharia</title>
    <!-- Adiciona a biblioteca de ícones Font Awesome para os botões -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@2.0.9/dist/tonconnect-ui.min.js"></script>
    <script src="https://unpkg.com/tonweb/dist/tonweb.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Tailwind: bg-slate-50 */
            color: #374151; /* Tailwind: text-gray-800 */
        }
        /* Estilos de navegação de página */
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .page.active {
            display: block;
            opacity: 1;
        }
        /* Estilos do modal */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Animação de loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        /* Ajustes para mobile */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .header {
                padding: 1.5rem 1rem;
            }
            .logo {
                font-size: 2rem;
            }
            .subtitle {
                font-size: 0.75rem;
            }
            .page-title {
                font-size: 1.5rem;
            }
            .llm-button {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
            .service-item .service-details {
                flex-direction: column;
                align-items: flex-start;
            }
            .service-item .price {
                margin-top: 0.5rem;
                text-align: left;
            }
            .total-section .text-6xl {
                font-size: 2.5rem; /* Reduzido para caber em mobile */
            }
            .total-section .text-5xl {
                font-size: 2rem; /* Reduzido para caber em mobile */
            }
            .total-section .text-lg {
                font-size: 1rem;
            }
            .form-group input, .form-group textarea {
                padding: 0.75rem;
            }
            .btn-group {
                flex-direction: column;
            }
            /* Adicionado word-break para textos longos */
            p, li {
                word-break: break-word;
            }
            button {
                height: auto; /* Altura automática para botões com 2 linhas */
                min-height: 48px; /* Maior para touch */
            }
            .stepper {
                display: flex !important;
                justify-content: space-between;
                font-size: 0.75rem;
                padding: 0 1rem;
            }
            .step {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 0 0.2rem;
                flex: 1;
            }
            .step-number {
                width: 25px;
                height: 25px;
                line-height: 25px;
                font-size: 0.75rem;
            }
            /* Valores monetários responsivos */
            .money-value {
                word-break: break-word;
                hyphens: auto;
            }
             /* Botões com espaçamento adequado */
            .btn-group {
                gap: 1rem;
            }
            .btn-group button {
                min-width: 120px;
            }
        }
        /* Stepper Styles */
        .stepper {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
        }
        .step {
            text-align: center;
            cursor: pointer;
        }
        .step-number {
            background: #ccc;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            line-height: 30px;
            display: inline-block;
        }
        .step.active .step-number {
            background: #3498db;
        }
        /* Tooltip Styles */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px;
            border-radius: 5px;
            white-space: nowrap;
            z-index: 10;
        }
        /* Sucesso Animação */
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .success-animate {
            animation: successPulse 1s ease-in-out;
        }
        
        /* Ajustes para desktop para a rolagem de termos */
        @media (min-width: 769px) {
            #termsContainer {
                max-height: 400px;
                overflow-y: auto;
                padding-right: 1.5rem; /* Adiciona padding para a barra de rolagem */
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8 lg:p-12">
        <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Header com gradiente -->
            <header class="bg-gradient-to-r from-blue-900 to-blue-500 text-white text-center p-8 md:p-12 shadow-lg">
                <div class="text-3xl md:text-5xl font-extrabold tracking-wide mb-2">MAEOKA ENGENHARIA</div>
                <div class="text-xs md:text-sm opacity-90">CNPJ: 19.924.627/0001-67 • Eng. Kioma Maeoka (CREA 159.328/D-PR)</div>
                <div class="w-full bg-white bg-opacity-20 rounded-full h-1 mt-6">
                    <div class="bg-green-400 h-full rounded-full transition-all duration-500 ease-in-out" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="20" style="width: 20%"></div>
                </div>
            </header>
            <!-- Stepper Adicionado -->
            <div class="stepper" id="stepper">
                <div class="step" data-step="1" onclick="showPage(1)"><span class="step-number">1</span><br>Proposta</div>
                <div class="step" data-step="2" onclick="showPage(2)"><span class="step-number">2</span><br>Termos</div>
                <div class="step" data-step="3" onclick="showPage(3)"><span class="step-number">3</span><br>Pagamento</div>
                <div class="step" data-step="4" onclick="showPage(4)"><span class="step-number">4</span><br>Dados</div>
                <div class="step" data-step="5" onclick="showPage(5)"><span class="step-number">5</span><br>Final</div>
            </div>
            <!-- Páginas de navegação -->
            <main class="p-6 md:p-10">
                <!-- PÁGINA 1: PROPOSTA -->
                <div class="page active" id="page1">
                    <h2 class="text-3xl md:text-4xl font-bold text-blue-900 text-center mb-8 pb-4 border-b-2">
                        Contrato de Prestação de Serviço
                    </h2>
                    <!-- Informações do Cliente -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8 text-sm">
                        <p class="font-bold">Cliente: Thiago</p>
                        <p class="mt-1">Endereço da Obra: R. Eponino Macuco, 185 - Curitiba/PR</p>
                        <p class="mt-1">Data: <span id="currentDate"></span></p>
                    </div>
                    <!-- Serviços Contratados -->
                    <h3 class="text-2xl font-semibold text-blue-800 mb-6 border-b pb-2">Serviços Contratados:</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm service-item">
                            <div class="font-semibold text-lg text-gray-900">Demolição - Remover Revestimento e Contra-Piso existente.</div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-sm mt-2 text-gray-600 service-details">
                                <div class="flex-1">Área: 100,93 m² • Com retirada de entulho até caçamba</div>
                                <div class="font-bold text-blue-700 text-base md:text-lg mt-2 md:mt-0 price">R$ 6.333,33</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm service-item">
                            <div class="font-semibold text-lg text-gray-900">Regularização/nivelamento</div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-sm mt-2 text-gray-600 service-details">
                                <div class="flex-1">Argamassa de regularização e caimento para ralos (min. 1%)</div>
                                <div class="font-bold text-blue-700 text-base md:text-lg mt-2 md:mt-0 price">R$ 7.125,00</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm service-item">
                            <div class="font-semibold text-lg text-gray-900">Aplicação de Primer e Manta asfáltica</div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-sm mt-2 text-gray-600 service-details">
                                <div class="flex-1">Nas áreas de recreação 1 e 2</div>
                                <div class="font-bold text-blue-700 text-base md:text-lg mt-2 md:mt-0 price">R$ 5.541,67</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm service-item">
                            <div class="font-semibold text-lg text-gray-900">Executar Contrapiso</div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-sm mt-2 text-gray-600 service-details">
                                <div class="flex-1">Proteção mecânica - Argamassa de proteção de 3-5cm sobre a manta</div>
                                <div class="font-bold text-blue-700 text-base md:text-lg mt-2 md:mt-0 price">R$ 11.875,00</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm service-item">
                            <div class="font-semibold text-lg text-gray-900">Instalar Revestimento Cerâmico/Porcelanato</div>
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center text-sm mt-2 text-gray-600 service-details">
                                <div class="flex-1">Nas áreas de recreação 1 e 2 (porcelanato até 90x90)</div>
                                <div class="font-bold text-blue-700 text-base md:text-lg mt-2 md:mt-0 price">R$ 7.125,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-100 text-blue-900 font-bold text-center py-4 mt-6 rounded-lg text-xl">
                        Subtotal Serviços: R$ 38.000,00
                    </div>
                    <!-- Serviços e Materiais Inclusos -->
                    <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-6 mt-8 shadow-sm">
                        <h4 class="text-xl font-semibold text-gray-900 mb-4">Serviços Inclusos no Processo:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <p class="font-bold">Anotação de Responsabilidade Técnica (ART)</p>
                                <p class="text-gray-600">Registro junto ao CREA-PR</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-md">
                                <p class="font-bold">Gerenciamento de Obra</p>
                                <p class="text-gray-600">Acompanhamento técnico completo</p>
                            </div>
                        </div>
                        <div class="text-center text-xs text-gray-600 mt-4 italic">
                            Estes serviços já estão inclusos no valor da proposta
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 rounded-lg p-6 mt-8 shadow-sm">
                        <h4 class="text-xl font-semibold text-gray-900 mb-4">Materiais Inclusos:</h4>
                        <div class="space-y-3">
                            <div class="bg-white border-l-4 border-blue-500 rounded-md p-3">
                                <p class="font-medium text-sm">Areia, cimento e brita</p>
                                <p class="text-xs text-gray-500">Para contrapiso e regularização</p>
                            </div>
                            <div class="bg-white border-l-4 border-blue-500 rounded-md p-3">
                                <p class="font-medium text-sm">Manta asfáltica e primer</p>
                                <p class="text-xs text-gray-500">Cola, pregos para impermeabilização</p>
                            </div>
                            <div class="bg-white border-l-4 border-blue-500 rounded-md p-3">
                                <p class="font-medium text-sm">Argamassa e espaçadores</p>
                                <p class="text-xs text-gray-500">Para assentamento de revestimento</p>
                            </div>
                        </div>
                        <div class="bg-blue-100 text-blue-900 font-bold text-center py-4 mt-6 rounded-lg text-xl">
                            Subtotal Materiais: R$ 28.031,00
                        </div>
                    </div>
                    
                    <!-- Observações e Nota Fiscal -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mt-8 shadow-sm">
                        <h4 class="text-xl font-semibold text-yellow-800 mb-4 flex justify-between items-center">
                            Observações Importantes
                        </h4>
                        <ul id="importantObservations" class="list-disc list-inside text-sm text-gray-600 space-y-1">
                            <li>Materiais inclusos no valor da proposta</li>
                            <li>Não inclui taxas de condomínio para aprovação</li>
                            <li>Proposta válida por 30 dias</li>
                            <li>Garantia: 12 meses para vícios de execução</li>
                            <li>Caçamba não inclusa (custo aprox. R$ 450,00)</li>
                            <li>Local: 4º andar sem elevador</li>
                        </ul>
                    </div>
                    <div class="bg-gray-100 border-l-4 border-blue-500 rounded-lg p-6 mt-8 shadow-sm">
                        <h3 class="text-xl font-semibold text-blue-900 mb-5">Concordância de Nota Fiscal</h3>
                        <div class="flex flex-col space-y-4 text-sm text-gray-700">
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-all">
                                <input type="radio" name="invoiceOption" value="condominio" id="invoiceOptionCondominio" onchange="updateCalculations()" checked class="mr-3 transform scale-125 text-blue-600 focus:ring-blue-500">
                                Não será necessário nota fiscal, o condomínio fica a cargo deste item
                            </label>
                            <label class="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-all">
                                <input type="radio" name="invoiceOption" value="emitir" id="invoiceOptionEmitir" onchange="updateCalculations()" class="mr-3 transform scale-125 text-blue-600 focus:ring-blue-500">
                                Será necessário emitir nota fiscal (acréscimo de 17% sobre o valor final)
                            </label>
                        </div>
                    </div>
                    <!-- Preço Final e Valor Total Unificados -->
                    <div class="bg-blue-900 text-white rounded-lg p-8 text-center shadow-2xl mt-8 total-section">
                        <h3 class="text-2xl font-bold mb-2">Valor Total do Investimento</h3>
                        <div class="bg-gray-100 bg-opacity-20 rounded-lg p-4 mb-4">
                            <p class="text-gray-200 text-lg line-through" id="originalPriceDisplay">
                                Total orçado: R$ 66.031,00
                            </p>
                            <div class="text-5xl font-extrabold my-2" id="finalPriceDisplay">
                                R$ 62.331,00
                            </div>
                            <p class="text-sm opacity-80 italic" id="discountExplanation">
                                Desconto aplicado para mantermos o preço acordado no nosso orçamento inicial.
                            </p>
                        </div>
                        <p class="text-sm opacity-80 mt-2">Prazo de Execução: 18-22 dias úteis</p>
                    </div>
                    <div class="mt-8">
                        <button class="w-full bg-blue-600 text-white text-lg font-semibold py-4 rounded-lg shadow-xl hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105" onclick="nextPage()">
                            Aceitar Proposta e Continuar
                        </button>
                    </div>
                </div>
                <!-- PÁGINA 2: TERMOS -->
                <div class="page" id="page2">
                    <h2 class="text-3xl md:text-4xl font-bold text-blue-900 text-center mb-8 pb-4 border-b-2 flex flex-col md:flex-row justify-center items-center">
                        Termo de Ciência e Responsabilidade
                    </h2>
                
                    <p id="termsText" class="text-center text-gray-600 italic mb-8 bg-blue-50 p-6 rounded-lg text-base border-l-4 border-blue-200">
                        Para garantir transparência total no nosso trabalho, queremos esclarecer alguns pontos importantes sobre o processo de reforma:
                    </p>
                    <!-- Conteúdo dos termos com altura fixa e rolagem no desktop, e rolagem nativa no mobile -->
                    <div class="bg-gray-100 rounded-lg p-6 md:p-8 shadow-sm border-l-4 border-blue-500 space-y-6" id="termsContainer">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">Proteção de Móveis e Objetos</h3>
                            <p class="text-sm text-gray-700 mb-2">• Nossa equipe fará a proteção dos móveis conforme padrão do mercado</p>
                            <div class="bg-red-100 border border-red-300 text-red-800 p-4 rounded-lg text-sm mb-2">
                                <strong class="font-semibold">Importante:</strong> Após a proteção ser instalada, o cliente deve verificar e aprovar se está adequada
                            </div>
                            <p class="text-sm text-gray-700 mb-2">• Uma vez aprovada a proteção pelo cliente, a responsabilidade por eventuais danos fica transferida</p>
                            <p class="text-sm text-gray-700 font-bold">• Mesmo com toda proteção e cuidado, reformas envolvem movimentação constante de materiais, ferramentas e equipamentos, podendo ocorrer batidas acidentais, resbalos, respingos ou pequenos impactos nos móveis protegidos</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">Objetos de Valor</h3>
                            <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 p-4 rounded-lg text-sm mb-2">
                                <strong class="font-semibold">Obrigatório:</strong> Itens de grande valor (financeiro ou sentimental) devem ser removidos do ambiente
                            </div>
                            <p class="text-sm text-gray-700 mb-2">• <strong class="font-semibold">Apenas quando for impossível remover:</strong> guardar em cômodo que não será reformado ou solicitar isolamento especial</p>
                            <p class="text-sm text-gray-700">• A empresa não se responsabiliza por objetos de valor que permaneceram no local mesmo após orientação</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">Durante a Execução</h3>
                            <p class="text-sm text-gray-700 mb-2">• Reformar com móveis no ambiente sempre envolve riscos</p>
                            <p class="text-sm text-gray-700 mb-2">• Geração de pó é inevitável (mesmo com proteção)</p>
                            <p class="text-sm text-gray-700 mb-2">• <strong class="font-semibold">4º andar sem elevador:</strong> Transporte de materiais será feito pela escada</p>
                            <p class="text-sm text-gray-700">• A reorganização final dos móveis não está incluída no serviço</p>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">Especificidades da Obra</h3>
                            <div class="bg-green-100 border border-green-300 text-green-800 p-4 rounded-lg text-sm mb-2">
                                <strong class="font-semibold">Impermeabilização:</strong> Problemas de infiltração serão solucionados com manta asfáltica
                            </div>
                            <p class="text-sm text-gray-700 mb-2">• Contrapiso será refeito conforme necessário para correção de níveis</p>
                            <p class="text-sm text-gray-700">• Porcelanato 70x70 será assentado conforme especificação técnica</p>
                        </div>
                    </div>
                    
                    <!-- Checkbox de aceite -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mt-8 shadow-sm flex items-start">
                        <input type="checkbox" id="agreeTerms" onchange="checkTermsAgreement()" class="mt-1 mr-3 transform scale-125 text-yellow-600 focus:ring-yellow-500" disabled>
                        <label for="agreeTerms" class="text-sm cursor-pointer text-gray-700">
                            <strong class="font-semibold">Li e estou de acordo com os Termos de Ciência e Responsabilidade acima.</strong>
                        </label>
                    </div>
                    <!-- Botões de navegação -->
                    <div class="flex flex-col md:flex-row gap-4 mt-8">
                        <button class="flex-1 bg-gray-500 text-white text-lg font-semibold py-4 rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300" aria-label="Voltar para página anterior" onclick="prevPage()">
                            <i class="fa-solid fa-arrow-left mr-2" aria-hidden="true"></i>Voltar
                        </button>
                        <button class="flex-1 bg-blue-600 text-white text-lg font-semibold py-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" id="confirmTermsBtn" aria-label="Confirmar termos e avançar" onclick="nextPage()" disabled>
                            Confirmar e Avançar<i class="fa-solid fa-arrow-right ml-2" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <!-- PÁGINA 3: PAGAMENTO -->
                <div class="page" id="page3">
                    <h2 class="text-3xl md:text-4xl font-bold text-blue-900 text-center mb-8 pb-4 border-b-2">
                        Condições de Pagamento
                    </h2>
                    <div class="bg-blue-900 text-white rounded-lg p-8 text-center shadow-2xl mt-8 total-section">
                        <h3 class="text-2xl font-bold mb-2">Valor Total do Investimento</h3>
                        <div class="bg-gray-100 bg-opacity-20 rounded-lg p-4 mb-4">
                            <p class="text-gray-200 text-lg line-through" id="originalPriceDisplayPage3">
                                Total orçado: R$ 66.031,00
                            </p>
                            <div class="text-5xl font-extrabold my-2" id="finalPriceDisplayPage3">
                                R$ 62.331,00
                            </div>
                            <p class="text-sm opacity-80 italic" id="discountExplanationPage3">
                                Desconto aplicado para mantermos o preço acordado no nosso orçamento inicial.
                            </p>
                        </div>
                    </div>
                    <div id="mainPaymentChoices" class="bg-gray-100 border-l-4 border-blue-500 rounded-lg p-6 mt-8 shadow-sm">
                        <h3 class="text-2xl font-semibold text-blue-900 mb-5">Escolha sua Forma de Pagamento:</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center">
                            <div class="bg-white border border-gray-300 hover:border-blue-500 p-6 rounded-lg shadow-sm cursor-pointer transition-all duration-300" onclick="showCashPayment()">
                                <h4 class="text-xl font-semibold text-blue-800 mb-2">Pagamento apenas em Dinheiro</h4>
                                <p class="text-sm text-gray-600">Condições tradicionais de pagamento parcelado</p>
                            </div>
                            <div class="bg-white border border-gray-300 hover:border-blue-500 p-6 rounded-lg shadow-sm cursor-pointer transition-all duration-300" onclick="showTokenPayment()">
                                <h4 class="text-xl font-semibold text-blue-800 mb-2">Pagamento com Tokens MAEOKA + Dinheiro</h4>
                                <p class="text-sm text-gray-600">Use até 40% em tokens e ganhe 10% de desconto</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botão "Voltar" principal para a página 2 (escondido após seleção) -->
                    <div id="mainBackBtnContainer" class="flex justify-end mt-8">
                        <button class="bg-gray-500 text-white text-lg font-semibold py-4 px-10 rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300" aria-label="Voltar para página anterior" onclick="prevPage()">
                            <i class="fa-solid fa-arrow-left mr-2" aria-hidden="true"></i>Voltar
                        </button>
                    </div>
                    <!-- Seção Dinheiro -->
                    <div class="bg-gray-50 border-l-4 border-green-500 rounded-lg p-6 mt-8 shadow-sm hidden" id="cashPaymentContent">
                        <h4 class="text-2xl font-semibold text-gray-900 mb-5">Condições de Pagamento</h4>
                        <ul class="list-disc list-inside text-base text-gray-700 space-y-2">
                            <li>Entrada: 20% na assinatura do contrato (R$ 12.466,20)</li>
                            <li>1ª Medição - Demolição: 25% (R$ 15.582,75)</li>
                            <li>2ª Medição - Impermeabilização e Contrapiso: 30% (R$ 18.699,30)</li>
                            <li>3ª Medição - Instalação de revestimentos e rejunte: 20% (R$ 12.466,20)</li>
                            <li>Final - Conclusão: 5% (R$ 3.116,55)</li>
                            <li class="font-bold">Pagamentos via PIX</li>
                        </ul>
                        <div class="flex flex-col md:flex-row gap-4 mt-8">
                            <button class="flex-1 bg-gray-500 text-white text-lg font-semibold py-4 rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300" aria-label="Voltar para escolhas de pagamento" onclick="hideAllPaymentSections()">
                                <i class="fa-solid fa-arrow-left mr-2" aria-hidden="true"></i>Voltar
                            </button>
                            <button class="flex-1 bg-blue-600 text-white text-lg font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 flex flex-col items-center justify-center" aria-label="Continuar com pagamento em dinheiro" onclick="nextPage()">
                                <span class="font-bold">Continuar com Pagamento</span>
                                <span class="text-xs font-normal opacity-90">em Dinheiro <i class="fa-solid fa-arrow-right ml-1" aria-hidden="true"></i></span>
                            </button>
                        </div>
                    </div>
                    <!-- Seção Tokens -->
                    <div class="bg-gray-50 border-l-4 border-green-500 rounded-lg p-6 mt-8 shadow-sm hidden" id="tokenPaymentContent">
                        <h4 class="text-2xl font-semibold text-gray-900 mb-5">Pagamento com Tokens MAEOKA</h4>
                        
                        <div class="bg-yellow-100 text-yellow-800 font-semibold text-center py-3 rounded-lg border border-yellow-300 mb-5" id="statusCarteira">
                            <i class="fa-solid fa-link mr-2" aria-hidden="true"></i>Conecte sua carteira para pagar com tokens
                        </div>
                        
                        <div id="tonConnectButton" class="flex justify-center my-4"></div>
                        
                        <div class="bg-white p-5 rounded-lg shadow-inner border border-gray-200 mt-6 hidden" id="walletInfo">
                            <h5 class="text-lg font-semibold text-gray-800">Sua Carteira</h5>
                            <p class="text-sm mt-2"><strong>Endereço:</strong></p>
                            <div class="bg-gray-100 text-xs font-mono p-2 rounded break-all border mt-1" id="enderecoCarteira"></div>
                            <p class="text-sm mt-2"><strong>Saldo:</strong> <span id="saldoTokens" class="font-bold">0 MAEOKA</span></p>
                        </div>
                        
                        <!-- Bloco da Calculadora Melhorado -->
                        <div class="bg-blue-50 p-4 md:p-6 rounded-lg border border-blue-200 mt-6 hidden" id="calculadoraTokens">
                            <h5 class="text-xl font-semibold text-blue-900 mb-1">Calculadora de Pagamento</h5>
                            <p class="text-sm text-gray-600 mb-4">Use até <strong class="text-blue-700">40%</strong> do valor em tokens e ganhe <strong class="text-green-600">10% de desconto</strong> sobre o valor usado.</p>

                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <label for="tokenInput" class="block text-sm font-semibold text-gray-800 mb-2">
                                    Tokens a usar:
                                </label>
                                
                                <div class="flex flex-col md:flex-row justify-between items-center text-right w-full md:w-auto mb-3">
                                    <div>
                                        <span id="tokensUsarDisplay" class="text-2xl font-bold text-blue-900">0</span>
                                        <span class="text-base font-semibold text-gray-600"> MAEOKA</span>
                                    </div>
                                    <p class="text-sm text-gray-500">(equivale a R$ <span id="valorTokens">0,00</span>)</p>
                                </div>

                                <div class="flex items-center gap-4 mt-2">
                                    <input type="range" min="0" max="24932" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="sliderTokens">
                                    <input type="number" id="tokenInput" min="0" max="24932" value="0" class="w-32 p-2 border border-gray-300 rounded-lg text-sm text-center">
                                </div>
                            </div>

                            <div class="text-xs text-gray-600 mt-4 space-y-1 bg-white p-3 rounded-lg border">
                                <div class="flex justify-between items-center">
                                    <span>Seu saldo atual:</span>
                                    <strong class="text-gray-900" id="infoSaldoUsuario">0,00 MAEOKA</strong>
                                </div>
                                <div class="flex justify-between items-center border-t pt-1 mt-1">
                                    <span>Limite de uso na obra:</span>
                                    <div>
                                        <strong class="text-gray-900" id="infoSaldoMaximoObra">0,00 MAEOKA</strong>
                                        <p class="text-right text-gray-500" id="infoSaldoPercentual">(40% de R$ 62.331,00)</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-lg mt-6 border-l-4 border-blue-500">
                                <h6 class="font-bold text-lg text-blue-800 mb-3">Resumo do Pagamento</h6>
                                <div class="space-y-2 text-sm">
                                    <div class="flex flex-col sm:flex-row justify-between pb-1 border-b border-gray-200">
                                        <span class="text-gray-600">Valor original da obra:</span>
                                        <span id="valorOriginalObra"></span>
                                    </div>
                                    <div class="flex flex-col sm:flex-row justify-between pb-1 border-b border-gray-200">
                                        <span class="text-gray-600">Tokens a usar:</span>
                                        <span class="font-semibold" id="resumoTokens">0 MAEOKA (R$ 0,00)</span>
                                    </div>
                                    <div class="flex flex-col sm:flex-row justify-between pb-1 border-b border-gray-200">
                                        <span class="text-gray-600">Desconto de 10%:</span>
                                        <span class="text-green-600 font-semibold" id="resumoDesconto">- R$ 0,00</span>
                                    </div>
                                    <div class="flex flex-col sm:flex-row justify-between pb-1 border-b border-gray-200">
                                        <span class="text-gray-600">Valor em dinheiro:</span>
                                        <span class="font-semibold" id="resumoDinheiro">R$ 62.331,00</span>
                                    </div>
                                    <div class="flex flex-col sm:flex-row justify-between pt-3 border-t-2 border-blue-500 text-lg font-bold">
                                        <span>Total a Pagar:</span>
                                        <span id="resumoTotal">R$ 62.331,00</span>
                                    </div>
                                    <div class="flex flex-col sm:flex-row justify-between pt-2 text-green-600 font-bold text-lg">
                                        <span>Economia:</span>
                                        <span id="resumoEconomia">R$ 0,00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="w-full bg-blue-600 text-white text-lg font-semibold py-3 rounded-lg shadow-xl hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed mt-6" id="btnEnviarTokens" aria-label="Pagar com tokens">
                                <!-- Conteúdo dinâmico via JS -->
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-5 mt-6 shadow-sm hidden" id="adjustedPaymentConditions">
                            <h4 class="text-xl font-semibold text-yellow-800 mb-4">Condições de Pagamento (Valor Restante em Dinheiro)</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                <li>Entrada: 20% na assinatura do contrato (<span class="font-bold" id="tokenEntry">R$ 12.466,20</span>)</li>
                                <li>1ª Medição - Demolição: 25% (<span class="font-bold" id="tokenMeasurement1">R$ 15.582,75</span>)</li>
                                <li>2ª Medição - Impermeabilização e Contrapiso: 30% (<span class="font-bold" id="tokenMeasurement2">R$ 18.699,30</span>)</li>
                                <li>3ª Medição - Instalação de revestimentos e rejunte: 20% (<span class="font-bold" id="tokenMeasurement3">R$ 12.466,20</span>)</li>
                                <li>Final - Conclusão: 5% (<span class="font-bold" id="tokenFinal">R$ 3.116,55</span>)</li>
                                <li class="font-bold">Pagamentos via PIX</li>
                            </ul>
                            <div class="bg-green-100 text-green-800 p-3 rounded-lg mt-4 text-sm font-semibold border border-green-300">
                                <i class="fa-solid fa-gift mr-2" aria-hidden="true"></i><strong>Cashback:</strong> Você receberá <span id="cashbackInfo">0</span> MAEOKA de volta após a conclusão da obra (3% sobre o total)!
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-4 mt-8">
                            <button class="flex-1 bg-gray-500 text-white text-lg font-semibold py-4 rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300" aria-label="Voltar para escolhas de pagamento" onclick="hideAllPaymentSections()">
                                <i class="fa-solid fa-arrow-left mr-2" aria-hidden="true"></i>Voltar
                            </button>
                            <button class="flex-1 bg-blue-600 text-white text-lg font-semibold py-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" id="continueTokenBtn" aria-label="Continuar com pagamento em tokens" disabled onclick="nextPage()">
                                Continuar<i class="fa-solid fa-arrow-right ml-2" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- PÁGINA 4: DADOS -->
                <div class="page" id="page4">
                    <h2 class="text-3xl md:text-4xl font-bold text-blue-900 text-center mb-8 pb-4 border-b-2">
                        Dados do Contratante
                    </h2>
                    <form id="clientForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo * <span data-tooltip="Seu nome completo para o contrato"></span></label>
                                <input type="text" id="fullName" name="fullName" autocomplete="name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" oninput="debouncedValidation()">
                                <p class="text-red-500 text-xs mt-1 hidden" id="fullNameError">Campo obrigatório</p>
                            </div>
                            <div class="form-group">
                                <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF * <span data-tooltip="Formato: 000.000.000-00"></span></label>
                                <input type="text" id="cpf" name="cpf" autocomplete="off" required placeholder="000.000.000-00" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" oninput="debouncedValidation()">
                                <p class="text-red-500 text-xs mt-1 hidden" id="cpfError">CPF inválido</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail * <span data-tooltip="Usado para confirmações"></span></label>
                                <input type="email" id="email" name="email" autocomplete="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" oninput="debouncedValidation()">
                                <p class="text-red-500 text-xs mt-1 hidden" id="emailError">E-mail inválido</p>
                            </div>
                            <div class="form-group">
                                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone/WhatsApp * <span data-tooltip="Para contato rápido"></span></label>
                                <input type="tel" id="phone" name="phone" autocomplete="tel" required placeholder="(41) 99999-9999" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" oninput="debouncedValidation()">
                                <p class="text-red-500 text-xs mt-1 hidden" id="phoneError">Telefone inválido</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço de Domicílio * <span data-tooltip="Endereço completo"></span></label>
                            <textarea id="address" name="address" rows="3" autocomplete="street-address" required placeholder="Rua, número, bairro, cidade" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors" oninput="debouncedValidation()"></textarea>
                            <p class="text-red-500 text-xs mt-1 hidden" id="addressError">Campo obrigatório</p>
                        </div>
                        <div class="form-group">
                            <label for="observations" class="block text-sm font-medium text-gray-700 mb-1">Observações Adicionais <span data-tooltip="Qualquer nota extra"></span></label>
                            <textarea id="observations" name="observations" rows="3" placeholder="Alguma informação adicional importante..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"></textarea>
                        </div>
                        
                        <!-- LGPD -->
                        <div class="bg-gray-100 border border-gray-200 rounded-lg p-6 text-sm text-gray-700">
                            <h4 class="text-lg font-semibold text-gray-900 mb-3">Proteção de Dados Pessoais (LGPD)</h4>
                            <p class="leading-relaxed">
                                <strong class="font-semibold">Como utilizamos seus dados:</strong><br>
                                • Seus dados serão utilizados exclusivamente para execução do contrato<br>
                                • Comunicação sobre o andamento da obra e serviços<br>
                                • Cumprimento de obrigações legais e fiscais<br>
                                • Não compartilhamos dados com terceiros sem autorização<br>
                                • Você pode solicitar exclusão dos dados a qualquer momento
                            </p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 flex items-start text-sm text-gray-700">
                            <input type="checkbox" id="lgpdAccepted" required class="mt-1 mr-3 transform scale-125 text-yellow-600 focus:ring-yellow-500" oninput="debouncedValidation()">
                            <label for="lgpdAccepted" class="cursor-pointer">
                                <strong class="font-semibold">Autorizo o tratamento dos meus dados pessoais pela Maeoka Engenharia conforme descrito acima, de acordo com a Lei Geral de Proteção de Dados (LGPD - Lei 13.709/2018).</strong>
                            </label>
                        </div>
                        
                        <!-- Confirmação Final -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-sm text-gray-700">
                            <h4 class="text-lg font-semibold text-yellow-800 mb-3">Confirmação Final</h4>
                            <p>Ao finalizar, você estará formalizando a contratação dos serviços da Maeoka Engenharia conforme proposta apresentada e termos aceitos.</p>
                        </div>
                        <!-- Botões de navegação -->
                        <div class="flex flex-col md:flex-row gap-4 mt-8">
                            <button type="button" class="flex-1 bg-gray-500 text-white text-lg font-semibold py-4 rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300" aria-label="Voltar para página anterior" onclick="prevPage()">
                                <i class="fa-solid fa-arrow-left mr-2" aria-hidden="true"></i>Voltar
                            </button>
                            <button type="submit" class="flex-1 bg-blue-600 text-white text-lg font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex flex-col items-center justify-center" id="submitBtn" aria-label="Finalizar contratação" disabled>
                                <span class="font-bold">Finalizar Contratação</span>
                                <span class="text-xs font-normal opacity-90">e Gerar Documento <i class="fa-solid fa-arrow-right ml-1" aria-hidden="true"></i></span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- PÁGINA 5: FINALIZAÇÃO -->
                <div class="page" id="page5">
                    <!-- Status do Sistema (movido para o topo) -->
                    <div id="systemStatus" class="bg-blue-50 border border-blue-200 p-5 rounded-lg mt-6 text-sm text-gray-700">
                        <h4 class="text-lg font-semibold text-gray-900 mb-2">Status do Sistema</h4>
                        <p id="statusMessage" class="font-medium text-blue-800">
                            <span class="spinner mr-2"></span> Enviando contrato automaticamente para Maeoka Engenharia...
                        </p>
                    </div>
                    <div class="bg-green-50 border border-green-300 rounded-lg p-8 text-center shadow-lg mt-8 success-animate">
                        <h2 class="text-4xl font-bold text-green-700 mb-4">Contratação Realizada com Sucesso!</h2>
                        <p class="text-lg text-gray-700 mb-6">Obrigado por escolher a Maeoka Engenharia!</p>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
                            <h3 class="text-2xl font-semibold text-gray-900 mb-2">Próximos Passos:</h3>
                            <ul class="list-none text-base text-gray-700 space-y-2">
                                <li class="flex items-center justify-center text-left"><i class="fa-solid fa-download mr-3 text-blue-500" aria-hidden="true"></i>Baixar documento no celular/computador/tablet</li>
                                <li class="flex items-center justify-center text-left"><i class="fa-brands fa-whatsapp mr-3 text-green-500" aria-hidden="true"></i>Enviar para nossa equipe via WhatsApp</li>
                                <li class="flex items-center justify-center text-left"><i class="fa-solid fa-calendar-check mr-3 text-purple-500" aria-hidden="true"></i>Agendaremos a vistoria técnica</li>
                                <li class="flex items-center justify-center text-left"><i class="fa-solid fa-chart-line mr-3 text-red-500" aria-hidden="true"></i>Definiremos o cronograma detalhado</li>
                            </ul>
                        </div>
                        
                        <div class="bg-gray-100 p-6 rounded-lg mt-6 text-sm text-gray-700 border border-gray-200">
                            <p class="font-bold">Número do Protocolo: <span id="protocolNumber" class="font-normal text-gray-900"></span></p>
                            <p class="font-bold">Data/Hora: <span id="contractDateTime" class="font-normal text-gray-900"></span></p>
                        </div>
                        <!-- Adicionado: Resumo Final -->
                        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mt-6">
                            <h3 class="text-2xl font-semibold text-gray-900 mb-2">Resumo Final da Contratação</h3>
                            <p id="finalSummary" class="text-base text-gray-700"></p>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-green-600 to-green-400 text-white p-8 rounded-lg text-center shadow-2xl mt-8">
                        <h3 class="text-2xl font-bold mb-4">Finalização do Processo</h3>
                        <p class="text-sm md:text-base mb-4">
                            <strong class="font-semibold">Para finalizar o processo, é necessário baixar o documento para assinatura e compartilhar com a Maeoka Engenharia.</strong>
                        </p>
                        <p class="text-xs md:text-sm opacity-90 mb-6">
                            O documento será baixado em formato HTML (pode ser convertido para PDF). Recomendamos envio via WhatsApp para maior agilidade.
                        </p>
                        
                        <!-- Botão de Download Melhorado -->
                        <button class="w-full md:w-auto bg-red-600 text-white py-3 px-8 rounded-lg shadow-lg hover:bg-red-700 transition-colors duration-300 transform hover:scale-105 flex flex-col items-center justify-center" aria-label="Baixar documento para assinatura" onclick="downloadContractHTML()">
                            <span class="text-lg font-bold">
                                <i class="fa-solid fa-file-arrow-down mr-1" aria-hidden="true"></i>
                                Baixar Documento
                            </span>
                            <span class="text-xs font-light -mt-1 tracking-wide">
                                para Assinatura
                            </span>
                        </button>
                        
                        <p class="text-xs opacity-80 mt-4">
                            * Após compartilhar o documento, nossa equipe confirmará o recebimento e dará início ao processo.
                        </p>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <button class="bg-gray-500 text-white text-lg font-semibold py-4 px-10 rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-300" aria-label="Iniciar nova contratação" onclick="restartProcess()">
                            <i class="fa-solid fa-redo mr-2" aria-hidden="true"></i>Nova Contratação
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <!-- Modal para exibir o resultado do LLM -->
    <div id="llmModal" class="modal hidden" tabindex="-1" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-11/12 max-w-2xl relative">
            <span class="absolute top-4 right-6 text-gray-400 text-3xl font-bold cursor-pointer hover:text-gray-800 transition-colors" aria-label="Fechar modal" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle" class="text-2xl font-bold text-blue-900 text-center mb-4"></h3>
            <div id="modalBody" class="text-sm text-gray-700 leading-relaxed max-h-96 overflow-y-auto"></div>
            <div id="modalButtons" class="mt-6 flex justify-end gap-4"></div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURAÇÕES GLOBAIS ---
        const TOKEN_MAEOKA = 'EQCUgsVus4fW5TY2bxBQWSyiwLETOr2iNlVied-szVuJ1t4W';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwovnJtN76EfqzykncamVAvszSve0JMzrw7gU7kAPIF6MJBmkf9-XSmP1z2KjBwsWBN8Q/exec'; // Use HTTPS em produção
        let VALOR_OBRA = 62331;
        const LIMITE_PERCENTUAL = 0.40;
        let currentPage = 1;
        let currentTotalWithTax = 62331;
        let totalPages = 5;
        let contracts = JSON.parse(localStorage.getItem('maeokaContracts')) || [];
        // Variáveis do sistema de tokens
        let saldoUsuario = 0;
        let enderecoUsuario = '';
        let tonweb = null;
        let tonConnectUI = null;
        let metodoPagamentoSelecionado = null;
        
        // --- ELEMENTOS DO DOM (CACHE) ---
        const statusCarteira = document.getElementById('statusCarteira');
        const walletInfo = document.getElementById('walletInfo');
        const enderecoCarteira = document.getElementById('enderecoCarteira');
        const saldoTokens = document.getElementById('saldoTokens');
        const calculadoraTokens = document.getElementById('calculadoraTokens');
        const sliderTokens = document.getElementById('sliderTokens');
        const tokenInput = document.getElementById('tokenInput');
        const btnEnviarTokens = document.getElementById('btnEnviarTokens');
        const continueTokenBtn = document.getElementById('continueTokenBtn');
        const modal = document.getElementById('llmModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalButtons = document.getElementById('modalButtons');
        // Elementos do resumo
        const resumoTokens = document.getElementById('resumoTokens');
        const resumoDesconto = document.getElementById('resumoDesconto');
        const resumoDinheiro = document.getElementById('resumoDinheiro');
        const resumoTotal = document.getElementById('resumoTotal');
        const resumoEconomia = document.getElementById('resumoEconomia');
        const valorTokens = document.getElementById('valorTokens');
        // Novos elementos
        const termsContainer = document.getElementById('termsContainer');
        const stepper = document.getElementById('stepper').querySelectorAll('.step');
        const submitBtn = document.getElementById('submitBtn');
        
        // --- FUNÇÕES DE NAVEGAÇÃO ---
        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentPage / totalPages) * 100;
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            // Update stepper
            stepper.forEach(step => step.classList.remove('active'));
            if (stepper[currentPage - 1]) {
                stepper[currentPage - 1].classList.add('active');
            }
        }
        function showPage(pageNumber) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            const pageToShow = document.getElementById(`page${pageNumber}`);
            if (pageToShow) {
                pageToShow.classList.add('active');
                currentPage = pageNumber;
                updateProgressBar();
                window.scrollTo(0, 0);
            }
        
            if (pageNumber === 3) {
                updatePaymentPageDisplay();
            }
        
            if (pageNumber === 2) {
                setupTermsScroll(); // Chama a função de rolagem ao entrar na página de termos
            }
        }
        function nextPage() {
            if (currentPage === 2) {
                const termsAccepted = document.getElementById('agreeTerms').checked;
                if (!termsAccepted) {
                    showModal('Aviso', 'Por favor, aceite os Termos de Ciência e Responsabilidade para continuar.');
                    return;
                }
            } else if (currentPage === 4) {
                const clientForm = document.getElementById('clientForm');
                if (!clientForm.checkValidity()) {
                    clientForm.reportValidity();
                    return;
                }
                if (!document.getElementById('lgpdAccepted').checked) {
                    showModal('Aviso', '⚠️ É necessário autorizar o tratamento de dados pessoais (LGPD) para continuar.');
                    return;
                }
                finalizeContract();
            }
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        }
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        }
        
        // --- FUNÇÕES DE CÁLCULO E ATUALIZAÇÃO DE UI ---
        function updateCalculations() {
            let currentTotalBeforeTax = 66031.00;
            let finalPriceAfterDiscount = 62331.00;
            const invoiceOptionEmitir = document.getElementById('invoiceOptionEmitir');
            const originalPriceDisplay = document.getElementById('originalPriceDisplay');
            const finalPriceDisplay = document.getElementById('finalPriceDisplay');
            const discountExplanation = document.getElementById('discountExplanation');
        
            if (invoiceOptionEmitir && invoiceOptionEmitir.checked) {
                finalPriceAfterDiscount = 62331.00 * 1.17; // 17% de acréscimo
                currentTotalWithTax = finalPriceAfterDiscount;
                VALOR_OBRA = finalPriceAfterDiscount;
                originalPriceDisplay.textContent = `Total orçado: R$ ${currentTotalBeforeTax.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                finalPriceDisplay.textContent = `R$ ${finalPriceAfterDiscount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                discountExplanation.textContent = `Com desconto aplicado + acréscimo de 17% para emissão de NF.`;
            } else {
                finalPriceAfterDiscount = 62331.00;
                currentTotalWithTax = finalPriceAfterDiscount;
                VALOR_OBRA = finalPriceAfterDiscount;
                originalPriceDisplay.textContent = `Total orçado: R$ ${currentTotalBeforeTax.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                finalPriceDisplay.textContent = `R$ ${finalPriceAfterDiscount.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                discountExplanation.textContent = `Desconto aplicado para mantermos o preço acordado no nosso orçamento inicial.`;
            }
            updatePaymentPageDisplay();
        }

        function updatePaymentPageDisplay() {
            const originalPriceDisplayPage3 = document.getElementById('originalPriceDisplayPage3');
            const finalPriceDisplayPage3 = document.getElementById('finalPriceDisplayPage3');
            const discountExplanationPage3 = document.getElementById('discountExplanationPage3');

            if(originalPriceDisplayPage3) {
                 originalPriceDisplayPage3.textContent = document.getElementById('originalPriceDisplay').textContent;
                 finalPriceDisplayPage3.textContent = document.getElementById('finalPriceDisplay').textContent;
                 discountExplanationPage3.textContent = document.getElementById('discountExplanation').textContent;
            }
        }
        
        // --- FUNÇÕES DE PAGAMENTO ---
        function showCashPayment() {
            hideAllPaymentSections();
            document.getElementById('cashPaymentContent').style.display = 'block';
            document.getElementById('mainPaymentChoices').classList.add('hidden');
            metodoPagamentoSelecionado = 'cash';
            document.getElementById('mainBackBtnContainer').classList.add('hidden');
        }
        function showTokenPayment() {
            hideAllPaymentSections();
            document.getElementById('tokenPaymentContent').style.display = 'block';
            document.getElementById('mainPaymentChoices').classList.add('hidden');
            metodoPagamentoSelecionado = 'tokens';
            document.getElementById('mainBackBtnContainer').classList.add('hidden');
        
            if (!tonConnectUI) {
                setTimeout(() => {
                    inicializarTonConnect();
                }, 100);
            }
        }
        function hideAllPaymentSections() {
            document.getElementById('cashPaymentContent').style.display = 'none';
            document.getElementById('tokenPaymentContent').style.display = 'none';
            document.getElementById('mainPaymentChoices').classList.remove('hidden');
            metodoPagamentoSelecionado = null;
            document.getElementById('mainBackBtnContainer').classList.remove('hidden');
        }
        
        // --- FUNÇÕES DO SISTEMA DE TOKENS ---
        function inicializarTonWeb() {
            try {
                tonweb = new TonWeb(new TonWeb.HttpProvider('https://toncenter.com/api/v2/jsonRPC'));
                return true;
            } catch (error) {
                console.error('Erro ao inicializar TonWeb:', error);
                return false;
            }
        }
        function inicializarTonConnect() {
            try {
                tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                    manifestUrl: 'https://ton-connect.github.io/demo-dapp-with-wallet/tonconnect-manifest.json',
                    buttonRootId: 'tonConnectButton'
                });
                tonConnectUI.onStatusChange(walletInfo => {
                    if (walletInfo) {
                        statusCarteira.innerHTML = `<span class="spinner mr-2"></span> Carregando saldo...`;
                        statusCarteira.className = 'bg-blue-100 text-blue-800 font-semibold text-center py-3 rounded-lg border border-blue-300 mb-5';
                    
                        const endereco = walletInfo.account.address;
                        try {
                            const address = new TonWeb.utils.Address(endereco);
                            enderecoUsuario = address.toString(true, true, false);
                        } catch (error) {
                            enderecoUsuario = endereco;
                        }
                    
                        enderecoCarteira.textContent = enderecoUsuario;
                        document.getElementById('walletInfo').style.display = 'block';
                    
                        buscarSaldoTokens();
                    
                    } else {
                        statusCarteira.innerHTML = `<i class="fa-solid fa-link mr-2" aria-hidden="true"></i>Conecte sua carteira para pagar com tokens`;
                        statusCarteira.className = 'bg-yellow-100 text-yellow-800 font-semibold text-center py-3 rounded-lg border border-yellow-300 mb-5';
                    
                        document.getElementById('walletInfo').style.display = 'none';
                        calculadoraTokens.style.display = 'none';
                        document.getElementById('adjustedPaymentConditions').style.display = 'none';
                    }
                });
            
                return true;
            } catch (error) {
                console.error('Erro ao inicializar TON Connect:', error);
                return false;
            }
        }
        async function buscarSaldoTokens() {
            try {
                console.log('🔍 Consultando saldo real na blockchain para:', enderecoUsuario);
            
                let retries = 0;
                const maxRetries = 5;
                let delay = 1000;
                while(retries < maxRetries) {
                    try {
                        const jettonMinter = new TonWeb.token.jetton.JettonMinter(tonweb.provider, {
                            address: TOKEN_MAEOKA
                        });
                    
                        const userJettonWalletAddress = await jettonMinter.getJettonWalletAddress(
                            new TonWeb.utils.Address(enderecoUsuario)
                        );
                    
                        const jettonWallet = new TonWeb.token.jetton.JettonWallet(tonweb.provider, {
                            address: userJettonWalletAddress
                        });
                    
                        const jettonData = await jettonWallet.getData();
                        const saldoNano = jettonData.balance;
                        saldoUsuario = parseFloat(TonWeb.utils.fromNano(saldoNano));
                    
                        console.log('✅ Saldo real obtido:', saldoUsuario, 'MAEOKA');
                        break; // Exit loop on success
                    } catch (blockchainError) {
                        console.warn('⚠️ Erro na consulta blockchain:', blockchainError);
                        retries++;
                        if (retries < maxRetries) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // exponential backoff
                        } else {
                             console.error('❌ Erro final após múltiplas tentativas:', blockchainError);
                             saldoUsuario = 0;
                             throw blockchainError; // Rethrow to be caught by the main try/catch block
                        }
                    }
                }
            
                statusCarteira.innerHTML = `✅ Carteira Conectada - Saldo carregado!`;
                statusCarteira.className = 'bg-green-100 text-green-800 font-semibold text-center py-3 rounded-lg border border-green-300 mb-5';
                
                saldoTokens.innerHTML = `<span class="font-bold">${saldoUsuario.toLocaleString('pt-BR', {minimumFractionDigits: 2})} MAEOKA</span>`;
            
                const maxTokensPorLimite = VALOR_OBRA * LIMITE_PERCENTUAL;
                const maxTokens = Math.min(saldoUsuario, maxTokensPorLimite);
            
                sliderTokens.max = Math.floor(maxTokens); // Slider accepts integer values
                tokenInput.max = Math.floor(maxTokens);
                sliderTokens.value = 0;
                tokenInput.value = 0;
            
                document.getElementById('infoSaldoUsuario').textContent = `${saldoUsuario.toLocaleString('pt-BR', {minimumFractionDigits: 2})} MAEOKA`;
                document.getElementById('infoSaldoMaximoObra').textContent = `${maxTokensPorLimite.toLocaleString('pt-BR', {minimumFractionDigits: 2})} MAEOKA`;
                document.getElementById('infoSaldoPercentual').textContent = `(40% de R$ ${VALOR_OBRA.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;

                const valorOriginalObra = document.getElementById('valorOriginalObra');
                if (valorOriginalObra) {
                    valorOriginalObra.textContent = `R$ ${VALOR_OBRA.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                }
            
                if (saldoUsuario === 0) {
                    statusCarteira.innerHTML = `⚠️ Carteira conectada - Sem tokens MAEOKA`;
                    statusCarteira.className = 'bg-yellow-100 text-yellow-800 font-semibold text-center py-3 rounded-lg border border-yellow-300 mb-5';
                    
                    calculadoraTokens.innerHTML = `
                        <div class="bg-red-50 p-6 rounded-lg text-center border-2 border-red-300">
                            <h3 class="text-xl font-bold text-red-800 mb-4"><i class="fa-solid fa-circle-exclamation mr-2" aria-hidden="true"></i>SEM TOKENS MAEOKA</h3>
                            <p class="text-gray-700">Sua carteira não possui tokens MAEOKA.</p>
                            <p class="text-sm text-gray-500 mt-2">Para usar esta opção de pagamento, você precisa ter tokens MAEOKA em sua carteira.</p>
                            <a href="https://example.com/adquirir-tokens" target="_blank" class="text-blue-600 hover:underline">Como adquirir tokens?</a>
                        </div>
                    `;
                    updateAdjustedPaymentConditions(VALOR_OBRA, VALOR_OBRA);
                    document.getElementById('adjustedPaymentConditions').style.display = 'block';
                } else {
                    atualizarCalculos(0);
                }
            
                calculadoraTokens.style.display = 'block';
            
            } catch (error) {
                console.error('❌ Erro geral na busca de saldo:', error);
                statusCarteira.innerHTML = `❌ Erro ao consultar saldo`;
                statusCarteira.className = 'bg-red-100 text-red-800 font-semibold text-center py-3 rounded-lg border border-red-300 mb-5';
            }
        }
        function atualizarCalculos(tokensValue) {
            document.getElementById('tokensUsarDisplay').textContent = tokensValue.toLocaleString('pt-BR');
            valorTokens.textContent = (tokensValue).toLocaleString('pt-BR', {minimumFractionDigits: 2});
            resumoTokens.textContent = `${tokensValue.toLocaleString('pt-BR')} MAEOKA (R$ ${tokensValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`;
        
            const desconto = tokensValue * 0.1;
            resumoDesconto.textContent = `- R$ ${desconto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
            const valorDinheiro = VALOR_OBRA - tokensValue - desconto;
            resumoDinheiro.textContent = `R$ ${valorDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
            const totalFinal = VALOR_OBRA - tokensValue - desconto;
            resumoTotal.textContent = `R$ ${totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
            const economiaTotal = tokensValue + desconto;
            resumoEconomia.textContent = `R$ ${economiaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
            if (tokensValue > 0) {
                btnEnviarTokens.disabled = false;
                btnEnviarTokens.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <span class="font-bold text-base md:text-lg">
                            <i class="fa-solid fa-credit-card mr-2" aria-hidden="true"></i>
                            PAGAR COM ${tokensValue.toLocaleString('pt-BR')} TOKENS
                        </span>
                        <span class="text-xs font-normal opacity-90 -mt-1">
                            + restante em dinheiro
                        </span>
                    </div>`;
                continueTokenBtn.disabled = true;
            } else {
                btnEnviarTokens.disabled = true;
                btnEnviarTokens.innerHTML = `
                    <div class="flex flex-col items-center justify-center">
                        <span class="font-bold text-base md:text-lg">
                            <i class="fa-solid fa-credit-card mr-2" aria-hidden="true"></i>
                            PAGAR COM TOKENS
                        </span>
                        <span class="text-xs font-normal opacity-90 -mt-1">
                            Selecione a quantidade acima
                        </span>
                    </div>`;
                continueTokenBtn.disabled = false;
                continueTokenBtn.textContent = '✅ Continuar sem Tokens';
            }
            updateAdjustedPaymentConditions(valorDinheiro, totalFinal);
            document.getElementById('adjustedPaymentConditions').style.display = 'block';
        }
        function updateAdjustedPaymentConditions(valorDinheiro, totalFinal) {
            const entryValue = valorDinheiro * 0.20;
            const measurement1Value = valorDinheiro * 0.25;
            const measurement2Value = valorDinheiro * 0.30;
            const measurement3Value = valorDinheiro * 0.20;
            const finalValue = valorDinheiro * 0.05;
        
            document.getElementById('tokenEntry').textContent = `R$ ${entryValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenMeasurement1').textContent = `R$ ${measurement1Value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenMeasurement2').textContent = `R$ ${measurement2Value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenMeasurement3').textContent = `R$ ${measurement3Value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('tokenFinal').textContent = `R$ ${finalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        
            const cashback = Math.floor(totalFinal * 0.03);
            document.getElementById('cashbackInfo').textContent = `${cashback.toLocaleString('pt-BR')} MAEOKA`;
        }
        async function enviarTokens() {
            const tokensValue = Math.floor(parseFloat(sliderTokens.value));
        
            if (tokensValue === 0) {
                showModal('Aviso', 'Selecione uma quantidade de tokens para enviar!');
                return;
            }
        
            if (tokensValue > saldoUsuario) {
                showModal('Aviso', 'Você não tem tokens suficientes!');
                return;
            }
        
            btnEnviarTokens.disabled = true;
            btnEnviarTokens.innerHTML = '<span class="spinner mr-2"></span> Enviando tokens...';
        
            try {
                const CARTEIRA_MAEOKA_OFICIAL = 'UQCI80_zNVLySHf1DZbxfVw52DMPQj8EAOMcDn9TlvsjC341';
            
                const jettonMinter = new TonWeb.token.jetton.JettonMinter(tonweb.provider, {
                    address: TOKEN_MAEOKA
                });
            
                const userJettonWalletAddress = await jettonMinter.getJettonWalletAddress(
                    new TonWeb.utils.Address(enderecoUsuario)
                );
            
                const jettonWallet = new TonWeb.token.jetton.JettonWallet(tonweb.provider, {
                    address: userJettonWalletAddress
                });
            
                const jettonAmount = TonWeb.utils.toNano(tokensValue.toString());
                const forwardAmount = TonWeb.utils.toNano('0.01');
            
                const transferBody = await jettonWallet.createTransferBody({
                    jettonAmount: jettonAmount,
                    toAddress: new TonWeb.utils.Address(CARTEIRA_MAEOKA_OFICIAL),
                    forwardAmount: forwardAmount,
                    forwardPayload: new TextEncoder().encode(`Pagamento obra Thiago - ${tokensValue} tokens`),
                    responseAddress: new TonWeb.utils.Address(enderecoUsuario)
                });
            
                const transaction = {
                    validUntil: Date.now() + 5 * 60 * 1000,
                    messages: [
                        {
                            address: userJettonWalletAddress.toString(),
                            amount: TonWeb.utils.toNano('0.05').toString(),
                            payload: TonWeb.utils.bytesToBase64(await transferBody.toBoc())
                        }
                    ]
                };
            
                const result = await tonConnectUI.sendTransaction(transaction);
            
                const desconto = tokensValue * 0.1;
                const valorFinalEmDinheiro = VALOR_OBRA - tokensValue - desconto;
                const totalFinal = VALOR_OBRA - tokensValue - desconto;
                const economiaTotal = tokensValue + desconto;
            
                showModal('SUCESSO', `✅ TOKENS ENVIADOS COM SUCESSO!<br><br>` +
                    `💰 Tokens enviados: ${tokensValue.toLocaleString('pt-BR')} MAEOKA<br>` +
                    `💸 Desconto obtido: R$ ${desconto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>` +
                    `💵 Valor restante em dinheiro: R$ ${valorFinalEmDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>` +
                    `🏗️ Total da obra: R$ ${totalFinal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>` +
                    `🎁 Economia total: R$ ${economiaTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br><br>` +
                    `Agora você pode continuar para a próxima etapa!`);
            
                btnEnviarTokens.innerHTML = '<i class="fa-solid fa-check mr-2" aria-hidden="true"></i>Tokens Enviados com Sucesso!';
                btnEnviarTokens.className = 'w-full bg-green-600 text-white text-lg font-semibold py-4 rounded-lg shadow-xl';
                continueTokenBtn.disabled = false;
                continueTokenBtn.textContent = '✅ Continuar para Próxima Etapa';
            
            } catch (error) {
                console.error('Erro no envio:', error);
            
                btnEnviarTokens.disabled = false;
                atualizarCalculos(tokensValue); // Reset button text
            
                if (error.message.includes('User declined')) {
                    showModal('Envio Cancelado', 'Envio cancelado pelo usuário.');
                } else {
                    showModal('Erro no Envio', 'Erro no envio: ' + error.message);
                }
            }
        }
        
        // --- FUNÇÕES DE VALIDAÇÃO E MODAL ---
        function checkTermsAgreement() {
            const agreeTermsCheckbox = document.getElementById('agreeTerms');
            const confirmTermsBtn = document.getElementById('confirmTermsBtn');
            confirmTermsBtn.disabled = !agreeTermsCheckbox.checked;
        }
        function showModal(title, message, isConfirm = false, callback = null) {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = message;
            modalButtons.innerHTML = '';
            modal.classList.remove('hidden');
            modal.focus(); // Foco trap inicial
            
            if (isConfirm) {
                modalButtons.innerHTML = `
                    <button class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition" aria-label="Cancelar" onclick="closeModal()">Cancelar</button>
                    <button class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition ml-4" aria-label="Confirmar" onclick="closeModal(); ${callback ? callback.toString() : ''}">Confirmar</button>
                `;
            }
            
            // Foco trap: Mantém foco dentro do modal
            modal.addEventListener('keydown', trapFocus);
        }
        function closeModal() {
            modal.classList.add('hidden');
            modal.removeEventListener('keydown', trapFocus);
        }
        function trapFocus(e) {
            if (e.key === 'Tab') {
                const focusable = modal.querySelectorAll('button, input, textarea, [tabindex]:not([tabindex="-1"])');
                const first = focusable[0];
                const last = focusable[focusable.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                    last.focus();
                    e.preventDefault();
                } else if (!e.shiftKey && document.activeElement === last) {
                    first.focus();
                    e.preventDefault();
                }
            }
        }
        // Sobrescrita de alert/confirm para modals
        window.alert = function(message) {
            showModal('Aviso', message);
        };
        window.confirm = function(message, callback) {
            showModal('Confirmação', message, true, callback);
        };
        
        // --- FUNÇÕES DE FINALIZAÇÃO ---
        function generateProtocol() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            return `MAE-${year}${month}${day}-${hour}${minute}${second}`;
        }
        async function finalizeContract() {
            const clientForm = document.getElementById('clientForm');
            const clientData = {
                fullName: clientForm.elements['fullName'].value,
                cpf: clientForm.elements['cpf'].value,
                email: clientForm.elements['email'].value,
                phone: clientForm.elements['phone'].value,
                address: clientForm.elements['address'].value,
                observations: clientForm.elements['observations'].value,
            };
            const tokensUsados = metodoPagamentoSelecionado === 'tokens' ? Math.floor(parseFloat(sliderTokens.value)) : 0;
            const descontoAplicado = metodoPagamentoSelecionado === 'tokens' ? tokensUsados * 0.1 : 0;
            const valorFinalDinheiro = metodoPagamentoSelecionado === 'tokens' ? VALOR_OBRA - tokensUsados - descontoAplicado : VALOR_OBRA;
        
            const contractData = {
                // Payment details
                tokensUsados,
                descontoAplicado,
                valorFinalDinheiro,
            
                // Dados específicos do Thiago
                nomeCliente: "Thiago",
                enderecoObra: "R. Eponino Macuco, 185 - Curitiba/PR",
                tituloContrato: "CONTRATO DE PRESTAÇÃO DE SERVIÇO",
                valorTotal: VALOR_OBRA,
                prazoExecucao: "18-22 dias úteis",
                servicos: [
                    { nome: "Demolição - Remover Revestimento e Contra-Piso existente.", area: "Área: 100,93 m² • Com retirada de entulho até caçamba", preco: 6333.33 },
                    { nome: "Regularização/nivelamento", area: "Argamassa de regularização e caimento para ralos (min. 1%)", preco: 7125.00 },
                    { nome: "Aplicação de Primer e Manta asfáltica", area: "Nas áreas de recreação 1 e 2", preco: 5541.67 },
                    { nome: "Executar Contrapiso", area: "Proteção mecânica - Argamassa de proteção de 3-5cm sobre a manta", preco: 11875.00 },
                    { nome: "Instalar Revestimento Cerâmico/Porcelanato", area: "Nas áreas de recreação 1 e 2 (porcelanato até 90x90)", preco: 7125.00 }
                ],
                materiaisInclusos: [
                    "Areia, cimento e brita para contrapiso e regularização",
                    "Manta asfáltica, primer, cola, pregos para impermeabilização",
                    "Argamassa e espaçadores para assentamento de revestimento"
                ],
                valorMateriais: 28031.00,
                observacoesImportantess: [
                    "Materiais inclusos no valor da proposta",
                    "Não inclui taxas de condomínio para aprovação",
                    "Proposta válida por 30 dias",
                    "Garantia: 12 meses para vícios de execução",
                    "Caçamba não inclusa (custo aprox. R$ 450,00)",
                    "Local: 4º andar sem elevador"
                ],
            
                // Dados do cliente
                ...clientData,
                contractDate: new Date().toLocaleString('pt-BR'),
                protocol: generateProtocol(),
                termsAccepted: document.getElementById('agreeTerms').checked,
                lgpdAccepted: document.getElementById('lgpdAccepted').checked,
                metodoPagamento: metodoPagamentoSelecionado
            };
            contracts.push(contractData);
            localStorage.setItem('maeokaContracts', JSON.stringify(contracts));
            localStorage.setItem('currentContractDisplay', JSON.stringify(contractData));
            document.getElementById('protocolNumber').textContent = contractData.protocol;
            document.getElementById('contractDateTime').textContent = contractData.contractDate;
            
            // Atualiza resumo final na página 5
            document.getElementById('finalSummary').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Nome do Cliente:</strong> ${contractData.fullName}</p>
                    <p><strong>CPF:</strong> ${contractData.cpf}</p>
                    <p><strong>E-mail:</strong> ${contractData.email}</p>
                    <p><strong>Endereço de Domicílio:</strong> ${contractData.address}</p>
                    <p><strong>Método de Pagamento:</strong> ${contractData.metodoPagamento === 'tokens' ? 'Tokens MAEOKA + Dinheiro' : 'Apenas Dinheiro'}</p>
                    <p><strong>Valor Total da Obra:</strong> R$ ${contractData.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    ${contractData.metodoPagamento === 'tokens' ? `
                    <p><strong>Tokens Usados:</strong> ${contractData.tokensUsados.toLocaleString('pt-BR')} MAEOKA</p>
                    <p><strong>Desconto com Tokens:</strong> R$ ${contractData.descontoAplicado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    <p><strong>Valor Final em Dinheiro:</strong> R$ ${contractData.valorFinalDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    <p class="text-green-600 font-semibold"><strong>Economia Total:</strong> R$ ${(contractData.tokensUsados + contractData.descontoAplicado).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                    ` : ''}
                </div>
            `;
        
            // Enviar para Apps Script automaticamente
            // await sendContractToAppsScript(contractData);
        
        }
        function downloadContractHTML() {
            const contractData = JSON.parse(localStorage.getItem('currentContractDisplay'));
        
            if (!contractData) {
                showModal('Erro', 'Não há dados de contrato para download.');
                return;
            }
            let servicesHTML = '';
            contractData.servicos.forEach(servico => {
                let preco = servico.preco;
                if (contractData.metodoPagamento === 'tokens') {
                    // Calculate the adjusted price based on token payment
                    const ratio = preco / 38000; // Original service total
                    preco = (contractData.valorFinalDinheiro * ratio);
                }
            
                servicesHTML += `
                    <div style="background: #f0f0f0; padding: 12px; margin: 8px 0; border-radius: 5px;">
                        <strong>${servico.nome}</strong><br>
                        <span style="color: #666;">${servico.area} = ${preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                    </div>
                `;
            });
            let materialsHTML = '';
            if (contractData.materiaisInclusos && contractData.materiaisInclusos.length > 0) {
                materialsHTML = `
                    <h4 style="color: #1a3a52; margin-bottom: 10px;">📦 MATERIAIS INCLUSOS:</h4>
                    <ul style="list-style-type: none; padding-left: 0;">
                        ${contractData.materiaisInclusos.map(item => `<li>• ${item}</li>`).join('')}
                    </ul>
                    <p style="text-align: center; font-weight: bold; color: #2c5282;">SUBTOTAL MATERIAIS: R$ ${contractData.valorMateriais.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                `;
            }
            const htmlContent = `
            <!DOCTYPE html>
            <html lang="pt-BR">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Contrato ${contractData.protocol} - Maeoka Engenharia</title>
                <style>
                    body { font-family: 'Inter', Arial, sans-serif; margin: 20px; color: #333; line-height: 1.6; font-size: 12px; } /* Reduzido para compacto */
                    .header { background: #1a3a52; color: white; padding: 25px; text-align: center; margin-bottom: 30px; }
                    .logo { font-size: 24px; font-weight: bold; margin-bottom: 8px; } /* Reduzido */
                    .subtitle { font-size: 12px; opacity: 0.9; } /* Ajustado */
                    .section { margin: 25px 0; padding: 20px; border-left: 4px solid #1a3a52; background: #f8f9fa; border-radius: 0 8px 8px 0; }
                    .total { background: #1a3a52; color: white; padding: 20px; text-align: center; font-size: 18px; font-weight: bold; border-radius: 8px; margin: 20px 0; } /* Reduzido */
                    .signature-area { border: 2px dashed #1a3a52; padding: 40px; margin-top: 50px; text-align: center; border-radius: 8px; }
                    .signature-line { border-bottom: 1px solid #333; width: 80%; margin: 30px auto 10px auto; height: 30px; }
                    h2 { color: #1a3a52; border-bottom: 2px solid #1a3a52; padding-bottom: 10px; margin-bottom: 20px; text-align: center; font-size: 22px; } /* Explicitado */
                    h3 { color: #2c5282; margin-top: 25px; margin-bottom: 15px; font-size: 18px; } /* Reduzido */
                    @media print {
                        body { margin: 0; }
                        .header { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                        .total { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="logo">MAEOKA ENGENHARIA</div>
                    <div class="subtitle">CNPJ: 19.924.627/0001-67 • Eng. Kioma Maeoka (CREA 159.328/D-PR)</div>
                </div>
                <h2>CONTRATO DE PRESTAÇÃO DE SERVIÇOS DE ENGENHARIA</h2>
            
                <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                    <p><strong>Protocolo:</strong> ${contractData.protocol}</p>
                    <p><strong>Data de Aceite Digital:</strong> ${contractData.contractDate}</p>
                </div>
                <div class="section">
                    <h3>👤 DADOS DO CONTRATANTE</h3>
                    <p><strong>Nome Completo:</strong> ${contractData.fullName}</p>
                    <p><strong>CPF:</strong> ${contractData.cpf}</p>
                    <p><strong>E-mail:</strong> ${contractData.email}</p>
                    <p><strong>Telefone:</strong> ${contractData.phone}</p>
                    <p><strong>Endereço de Domicílio:</strong> ${contractData.address}</p>
                </div>
                <div class="section">
                    <h3>🔨 SERVIÇOS CONTRATADOS</h3>
                    <p><strong>Descrição Geral:</strong> ${contractData.tituloContrato}</p>
                    <p><strong>Cliente:</strong> ${contractData.nomeCliente}</p>
                    <p><strong>Endereço da Obra:</strong> ${contractData.enderecoObra}</p>
                
                    <h4>Detalhamento dos Serviços:</h4>
                    ${servicesHTML}
                
                    <div style="margin: 15px 0; text-align: center;">
                        <div style="margin-bottom: 10px;">
                            VALOR TOTAL: R$ ${contractData.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                        ${contractData.metodoPagamento === 'tokens' ? `
                        <div style="margin-bottom: 10px;">
                            <strong>Tokens Utilizados:</strong> ${contractData.tokensUsados.toLocaleString('pt-BR')} MAEOKA<br>
                            <strong>Desconto Aplicado:</strong> R$ ${contractData.descontoAplicado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                        ` : ''}
                        <div class="total">
                            TOTAL A PAGAR: R$ ${contractData.metodoPagamento === 'tokens' ? contractData.valorFinalDinheiro.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : contractData.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                        </div>
                    </div>
                </div>
                <div class="section">
                    ${materialsHTML}
                </div>
                <div class="section">
                    <h3>💰 CONDIÇÕES COMERCIAIS</h3>
                    <p><strong>Prazo de Execução:</strong> ${contractData.prazoExecucao}</p>
                    <p><strong>Método de Pagamento:</strong> ${contractData.metodoPagamento === 'tokens' ? 'Tokens MAEOKA + Dinheiro' : 'Apenas Dinheiro'}</p>
                    <p><strong>Forma de Pagamento:</strong> PIX</p>
                    <p><strong>Garantia:</strong> 12 meses para serviços executados</p>
                </div>
                <div class="section">
                    <h3>⚠️ OBSERVAÇÕES IMPORTANTES</h3>
                    <ul>
                        ${contractData.observacoesImportantess.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
                ${contractData.observations && contractData.observations.trim() !== '' ? `
                <div class="section">
                    <h3>📝 OBSERVAÇÕES ADICIONAIS DO CLIENTE</h3>
                    <p>${contractData.observations}</p>
                </div>
                ` : ''}
                ${contractData.metodoPagamento === 'tokens' ? `
                <div class="section">
                    <h3>💰 CONDIÇÕES DE PAGAMENTO (VALOR RESTANTE EM DINHEIRO)</h3>
                    <p>• Entrada: 20% na assinatura do contrato (R$ ${(contractData.valorFinalDinheiro * 0.2).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• 1ª Medição - Demolição: 25% (R$ ${(contractData.valorFinalDinheiro * 0.25).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• 2ª Medição - Impermeabilização e Contrapiso: 30% (R$ ${(contractData.valorFinalDinheiro * 0.3).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• 3ª Medição - Instalação de revestimentos e rejunte: 20% (R$ ${(contractData.valorFinalDinheiro * 0.2).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• Final - Conclusão: 5% (R$ ${(contractData.valorFinalDinheiro * 0.05).toLocaleString('pt-BR', {minimumFractionDigits: 2})})</p>
                    <p>• Pagamentos via PIX</p>
                    <div style="background: #e6fffa; padding: 15px; border-radius: 8px; margin: 15px 0; color: #38b2ac;">
                        <p style="margin: 0; font-size: 12px;">
                            🎁 <strong>Cashback:</strong> Você receberá ${Math.floor(contractData.valorFinalDinheiro * 0.03)} MAEOKA de volta após a conclusão da obra (3% sobre o total)!
                        </p>
                    </div>
                </div>
                ` : ''}
                <div class="signature-area">
                    <h3>✍️ ASSINATURAS</h3>
                    <p>Curitiba/PR, ${new Date().toLocaleDateString('pt-BR', {day: 'numeric', month: 'long', year: 'numeric'})}</p>
                
                    <div style="display: flex; justify-content: space-around; margin-top: 50px;">
                        <div style="text-align: center; width: 45%;">
                            <div class="signature-line"></div>
                            <p><strong>CONTRATANTE</strong></p>
                            <p>${contractData.fullName}</p>
                            <p>CPF: ${contractData.cpf}</p>
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <div class="signature-line"></div>
                            <p><strong>CONTRATADA</strong></p>
                            <p>Kioma Maeoka</p>
                            <p>Engenheiro Civil - CREA 159.328/D-PR</p>
                            <p>Maeoka Engenharia</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 40px; font-size: 10px; color: #666; text-align: center; border-top: 1px solid #ddd; padding-top: 20px;">
                    <p><strong>Maeoka Engenharia</strong></p>
                    <p>Curitiba/PR • WhatsApp: (41) 98839-1153</p>
                    <p>E-mail: contato@maeokaengenharia.com.br</p>
                    <p style="margin-top: 15px; font-style: italic;">
                        Este documento foi gerado digitalmente em ${new Date().toLocaleString('pt-BR')}
                    </p>
                </div>
            </body>
            </html>
            `;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Contrato_Maeoka_Thiago_${contractData.protocol}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        
            showModal('Download Concluído', `📄 Contrato do Thiago baixado com sucesso! Para PDF, use Ctrl+P > Salvar como PDF no browser.`);
        }
        function restartProcess() {
            showModal('Reiniciar Contratação', 'Deseja iniciar uma nova contratação? Os dados atuais serão perdidos.', true, () => {
                localStorage.removeItem('currentContractDisplay');
                location.reload();
            });
        }
        
        // --- FUNÇÕES AUXILIARES (MÁSCARAS PARA INPUTS) ---
        function applyMasks() {
            const cpfInput = document.getElementById('cpf');
            cpfInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = value;
            });
            
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                value = value.replace(/(\d{5})(\d)/, '$1-$2');
                e.target.value = value;
            });
        }
        
        // --- VALIDAÇÃO COMPLETA DE CPF (Nova função) ---
        function validarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            if (cpf.length !== 11) return false;
            
            if (/^(\d)\1{10}$/.test(cpf)) return false;
            
            let soma = 0;
            for (let i = 0; i < 9; i++) {
                soma += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            
            soma = 0;
            for (let i = 0; i < 10; i++) {
                soma += parseInt(cpf.charAt(i)) * (11 - i);
            }
            resto = 11 - (soma % 11);
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(10))) return false;
            
            return true;
        }

        // --- VALIDAÇÕES EM TEMPO REAL NO FORM ---
        function validateForm() {
            const fullName = document.getElementById('fullName').value.trim();
            const cpfInput = document.getElementById('cpf');
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.replace(/\D/g, '');
            const address = document.getElementById('address').value.trim();
            const lgpd = document.getElementById('lgpdAccepted').checked;
        
            const isCpfValid = validarCPF(cpfInput.value);
            
            document.getElementById('fullNameError').classList.toggle('hidden', fullName !== '');
            document.getElementById('cpfError').classList.toggle('hidden', isCpfValid);
            document.getElementById('emailError').classList.toggle('hidden', /\S+@\S+\.\S+/.test(email));
            document.getElementById('phoneError').classList.toggle('hidden', phone.length >= 10);
            document.getElementById('addressError').classList.toggle('hidden', address !== '');
        
            submitBtn.disabled = !(fullName && isCpfValid && /\S+@\S+\.\S+/.test(email) && phone.length >= 10 && address && lgpd);
        }

        // --- DEBOUNCE PARA EVITAR VÁRIAS CHAMADAS ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        const debouncedValidation = debounce(validateForm, 300);
        
        // --- FORÇAR ROLAGEM EM TERMOS ---
        function setupTermsScroll() {
            const termsContainer = document.getElementById('termsContainer');
            const agreeTermsCheckbox = document.getElementById('agreeTerms');
            if (termsContainer && agreeTermsCheckbox) {
                agreeTermsCheckbox.disabled = true;
                const checkScroll = () => {
                    // Verifica se a rolagem chegou ao fim do container ou se não tem rolagem
                    const isAtBottom = termsContainer.scrollHeight - termsContainer.scrollTop <= termsContainer.clientHeight + 1;
                    if (isAtBottom) {
                        agreeTermsCheckbox.disabled = false;
                        termsContainer.removeEventListener('scroll', checkScroll);
                    }
                };
                
                // Adiciona o listener de scroll para o container
                termsContainer.addEventListener('scroll', checkScroll);

                // Verifica na inicialização se o conteúdo já cabe na tela (desktop)
                if (termsContainer.scrollHeight <= termsContainer.clientHeight) {
                    agreeTermsCheckbox.disabled = false;
                }
            }
        }
        
        // --- SALVAR RASCUNHO NO FORM ---
        function saveDraft() {
            const formData = {
                fullName: document.getElementById('fullName').value,
                cpf: document.getElementById('cpf').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                observations: document.getElementById('observations').value,
            };
            localStorage.setItem('contractDraft', JSON.stringify(formData));
        }
        function loadDraft() {
            const draft = JSON.parse(localStorage.getItem('contractDraft'));
            if (draft) {
                document.getElementById('fullName').value = draft.fullName;
                document.getElementById('cpf').value = draft.cpf;
                document.getElementById('email').value = draft.email;
                document.getElementById('phone').value = draft.phone;
                document.getElementById('address').value = draft.address;
                document.getElementById('observations').value = draft.observations;
                debouncedValidation();
            }
        }
        
        // --- LISTENER PARA FECHAR MODAL COM ESC ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });
        
        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const currentDateElement = document.getElementById('currentDate');
            if (currentDateElement) {
                currentDateElement.textContent = new Date().toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }
        
            inicializarTonWeb();
        
            const agreeTermsCheckbox = document.getElementById('agreeTerms');
            if (agreeTermsCheckbox) {
                agreeTermsCheckbox.addEventListener('change', checkTermsAgreement);
            }
            
            if (sliderTokens) {
                sliderTokens.addEventListener('input', function() {
                    const tokensValue = Math.floor(parseFloat(this.value));
                    tokenInput.value = tokensValue;
                    atualizarCalculos(tokensValue);
                });
            }
            if (tokenInput) {
                tokenInput.addEventListener('input', function() {
                    let tokensValue = Math.floor(parseFloat(this.value));
                    if (isNaN(tokensValue) || tokensValue < 0) tokensValue = 0;
                    if (tokensValue > Math.floor(parseFloat(this.max))) tokensValue = Math.floor(parseFloat(this.max));
                    if (sliderTokens) {
                        sliderTokens.value = tokensValue;
                    }
                    atualizarCalculos(tokensValue);
                });
            }
            const clientForm = document.getElementById('clientForm');
            if (clientForm) {
                clientForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    nextPage();
                });
                clientForm.addEventListener('input', saveDraft); 
            }
        
            applyMasks();
            loadDraft();
        
            console.log('🎯 Sistema Maeoka - Contrato Thiago carregado com melhorias!');
            showPage(1);
        });
    </script>
</body>
</html>
