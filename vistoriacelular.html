<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vistoria Digital Online - Maeoka Engenharia</title>
    
    <!-- √çcones e Fontes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Biblioteca jsPDF para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Estilos gerais e de layout */
        :root {
            --primary-color: #3b82f6;
            --primary-gradient: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            --danger-color: #ef4444;
            --secondary-gradient: linear-gradient(135deg, #1a3a52 0%, #2c5282 100%);
            --success-gradient: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            --info-gradient: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --border-color: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            overflow: hidden; /* Previne scroll no body */
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 0;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dark);
            transition: opacity 0.3s;
        }
        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: var(--secondary-gradient);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #mobileHeaderBackBtn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo i { font-size: 28px; color: #60a5fa; }
        .logo-text h1 { font-size: 18px; font-weight: 700; }
        .logo-text p { font-size: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .inspection-id-wrapper { text-align: right; }
        .inspection-id-wrapper label { font-size: 10px; font-weight: 500; opacity: 0.8; }
        .inspection-id-display { font-size: 14px; font-weight: 700; background-color: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 8px; }
        
        /* Painel de Detalhes da Vistoria */
        .inspection-details {
            background: var(--bg-light);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .detail-item { flex: 1; min-width: 180px; }
        .detail-item label { font-size: 11px; font-weight: 600; color: var(--text-light); display: block; margin-bottom: 4px; }
        .detail-item-value { font-size: 13px; font-weight: 500; }
        .detail-item-value input { width: 100%; padding: 6px 8px; border-radius: 6px; border: 1px solid var(--border-color); }
        .btn-edit-details { padding: 8px 12px; font-size: 13px; }

        /* Main Content Layout */
        .main-content {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative;
        }

        /* Painel de Ambientes (Esquerda) */
        .locations-panel {
            width: 280px;
            background: var(--bg-light);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .locations-header {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        .add-location-form { display: flex; gap: 8px; margin-bottom: 15px; }
        .add-location-form input { flex-grow: 1; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; }
        .add-location-form button { padding: 8px 12px; border: none; background: var(--primary-color); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        .location-list { list-style: none; flex-grow: 1; }
        .location-item {
            background: white;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .location-item-main {
            padding: 12px 15px;
            flex-grow: 1;
            cursor: pointer;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .location-item:hover { transform: translateX(5px); border-color: #93c5fd; }
        .location-item.active {
            background: var(--primary-gradient);
            color: white;
            transform: translateX(10px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        .location-item-name { font-weight: 600; }
        .location-item-count { font-size: 12px; background-color: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; }
        .location-item.active .location-item-count { background-color: rgba(255,255,255,0.2); }
        .location-actions { display: flex; align-items: center; }
        .location-action-btn {
            background: none; border: none; color: #d1d5db; cursor: pointer;
            font-size: 14px; padding: 12px; opacity: 0;
            transition: all 0.2s ease; flex-shrink: 0;
        }
        .location-item:hover .location-action-btn { opacity: 1; color: var(--text-light); }
        .location-item.active .location-action-btn { opacity: 1; color: white; }
        .location-action-btn.delete-btn:hover { color: var(--danger-color) !important; }
        .location-action-btn.duplicate-btn:hover { color: var(--primary-color) !important; }

        /* Painel de Trabalho (Centro) */
        .workspace-panel {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .workspace-placeholder { text-align: center; margin: auto; color: var(--text-light); }
        .workspace-placeholder i { font-size: 48px; margin-bottom: 15px; }
        .workspace-placeholder h2 { font-size: 22px; }
        .workspace-header { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        .search-bar-wrapper { position: relative; }
        .search-bar-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        #serviceSearchInput { width: 100%; padding: 10px 15px 10px 40px; border-radius: 8px; border: 1px solid var(--border-color); }
        
        /* Se√ß√£o de Servi√ßos Salvos */
        .saved-services-list .service-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .service-card-details { flex-grow: 1; }
        .service-card-title { font-weight: 600; margin-bottom: 8px; }
        .service-card-title .category-badge { font-size: 11px; font-weight: 500; padding: 2px 8px; border-radius: 8px; background: #eef2ff; color: #4f46e5; margin-left: 8px; }
        .service-card-meta { font-size: 13px; color: var(--text-light); }
        .service-card-meta span { margin-right: 15px; }
        .service-card-actions button { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 16px; padding: 5px; }
        .service-card-actions button:hover { color: var(--primary-color); }
        .service-card-actions .delete-btn:hover { color: var(--danger-color); }

        /* Accordion para adicionar servi√ßos */
        .service-category-accordion, .add-category-form { border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 10px; overflow: hidden; background-color: #fff; }
        .accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; transition: background-color 0.2s ease; }
        .accordion-header:hover { background-color: var(--bg-light); }
        .accordion-header .header-left { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 16px; }
        .accordion-header .header-left i { color: var(--primary-color); }
        .accordion-header .fa-chevron-down { transition: transform 0.3s ease; }
        .accordion-header.active .fa-chevron-down { transform: rotate(180deg); }
        .accordion-content { display: none; padding: 15px; border-top: 1px solid var(--border-color); }
        .accordion-content.active { display: block; }
        .service-to-add { display: block; width: 100%; text-align: left; padding: 10px; border-radius: 8px; background: #f9fafb; border: 1px solid #f9fafb; margin-bottom: 8px; cursor: pointer; font-weight: 500; }
        .service-to-add:hover { background: #f3f4f6; border-color: #e5e7eb; }
        .add-custom-form {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
        }
        .add-custom-form input {
            flex-grow: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }
        .add-custom-form button {
            flex-shrink: 0;
            padding: 8px 12px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .add-category-form { padding: 20px; background-color: var(--bg-light); }
        .add-category-form h4 { font-weight: 600; margin-bottom: 10px; }

        /* Painel de Resumo (Direita) */
        .summary-panel {
            width: 320px;
            background: var(--bg-light);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        .summary-header { font-size: 18px; font-weight: 700; color: var(--text-dark); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .summary-location-item { background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 10px; font-size: 14px; }
        .summary-location-header { font-weight: 600; color: var(--text-dark); margin-bottom: 6px; }
        .summary-service-item { color: var(--text-light); font-size: 13px; margin-left: 15px; margin-top: 4px; padding-left: 10px; border-left: 2px solid var(--border-color); }

        /* Bot√£o de A√ß√£o Final */
        .action-footer {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
            position: relative;
        }
        .btn { padding: 10px 18px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-success { background: var(--success-gradient); color: white; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(16, 185, 129, 0.25); }
        .btn-info { background: var(--info-gradient); color: white; }
        .btn-info:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.25); }
        .btn-secondary { background: #f3f4f6; color: #6b7280; }
        .btn-secondary:hover { background: #e5e7eb; }
        
        #moreOptionsToggle { display: none; }
        #moreOptionsMenu {
            position: absolute;
            bottom: 100%;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: none;
            flex-direction: column;
            width: 200px;
        }
        #moreOptionsMenu.active { display: flex; }
        #moreOptionsMenu .btn {
            width: 100%;
            justify-content: flex-start;
            border-radius: 0;
            background: white;
            color: var(--text-dark);
        }
        #moreOptionsMenu .btn:hover { background: var(--bg-light); }


        /* Modal Gen√©rico */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: all 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: 700; color: var(--text-dark); }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); }
        .modal-form .form-group { margin-bottom: 15px; }
        .modal-form label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
        .modal-form input { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .btn-danger { background: var(--danger-color); color: white; }

        /* Modal de Galeria de Fotos */
        #photoGalleryModal .modal-content { max-width: 800px; }
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
            max-height: 40vh;
            overflow-y: auto;
            padding: 5px;
        }
        .photo-thumbnail {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* Aspect ratio 1:1 */
            border-radius: 8px;
            overflow: hidden;
        }
        .photo-thumbnail img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Grade de Sele√ß√£o para Modal */
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .selection-card {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .selection-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-color);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .selection-card .card-icon {
            font-size: 32px;
            color: var(--text-light);
        }
        .selection-card .card-title {
            font-weight: 600;
            font-size: 14px;
        }

        /* Responsive */
        @media (min-width: 769px) {
            body {
                padding: 20px;
            }
            .container {
                border-radius: 24px;
                height: calc(100vh - 40px);
            }
        }
        @media (max-width: 768px) {
            .summary-panel { display: none; }
            .main-content {
                flex-direction: row; 
                width: 200%;
            }
            .locations-panel, .workspace-panel {
                width: 50%;
                height: 100%;
                border-right: none;
                transition: transform 0.3s ease-in-out;
            }
            .main-content.workspace-active {
                transform: translateX(-50%); 
            }
            .workspace-panel {
                padding: 20px;
            }
            .inspection-details { flex-direction: column; align-items: stretch; }
            .action-footer {
                justify-content: center;
            }
            .btn {
                font-size: 13px;
                padding: 10px 14px;
            }
            .action-footer .btn.desktop-only {
                display: none;
            }
            #moreOptionsToggle {
                display: inline-flex;
            }
            #mobileHeaderBackBtn.visible {
                display: block;
            }
            .header-content.hiding {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <button id="mobileHeaderBackBtn"><i class="fas fa-arrow-left"></i></button>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hard-hat"></i>
                    <div class="logo-text">
                        <h1>MAEOKA ENGENHARIA</h1>
                        <p>Vistoria Digital Din√¢mica</p>
                    </div>
                </div>
                <div class="inspection-id-wrapper">
                    <label>ID DA VISTORIA</label>
                    <div class="inspection-id-display" id="inspectionIdDisplay">NOVA</div>
                </div>
            </div>
        </div>

        <!-- Painel de Detalhes da Vistoria -->
        <div class="inspection-details" id="inspectionDetailsPanel">
            <!-- Conte√∫do gerado por JS -->
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div id="loadingOverlay">
                <div class="spinner"></div>
                <p>Carregando dados da planilha...</p>
            </div>

            <!-- Painel de Ambientes (Esquerda) -->
            <div class="locations-panel">
                <h3 class="locations-header">üìç Ambientes</h3>
                <div class="add-location-form">
                    <input type="text" id="newLocationInput" placeholder="Nome ou atalhos...">
                    <button id="addLocationBtn"><i class="fas fa-plus"></i></button>
                </div>
                <ul class="location-list" id="locationList"></ul>
            </div>

            <!-- Painel de Trabalho (Centro) -->
            <div class="workspace-panel" id="workspacePanel"></div>

            <!-- Painel de Resumo (Direita) -->
            <div class="summary-panel">
                <h3 class="summary-header">üìã Resumo Geral</h3>
                <div id="summaryContent"></div>
            </div>
        </div>

        <!-- Action Footer -->
        <div class="action-footer">
            <div id="moreOptionsMenu">
                 <button class="btn btn-secondary" onclick="startFromTemplate()">
                    <i class="fas fa-copy"></i> Criar a Partir de Modelo
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('loadFileInput').click()">
                    <i class="fas fa-upload"></i> Carregar do PC
                </button>
                <input type="file" id="loadFileInput" style="display: none;" accept=".json">
                <button class="btn btn-secondary" onclick="saveInspectionToFile()">
                    <i class="fas fa-save"></i> Salvar no PC
                </button>
            </div>
            <button class="btn btn-info desktop-only" onclick="openLoadOnlineModal()">
                <i class="fas fa-cloud-download-alt"></i> Carregar Online
            </button>
            <button class="btn btn-info" onclick="saveInspectionOnline()">
                <i class="fas fa-cloud-upload-alt"></i> Salvar Online
            </button>
            <button class="btn btn-success" onclick="generatePDF()">
                <i class="fas fa-file-pdf"></i> Gerar PDF
            </button>
            <button class="btn btn-secondary" id="moreOptionsToggle">
                <i class="fas fa-ellipsis-v"></i> Mais Op√ß√µes
            </button>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Servi√ßo -->
    <div class="modal-overlay" id="serviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Adicionar Servi√ßo</h3>
                <button class="modal-close-btn" onclick="closeServiceModal()">&times;</button>
            </div>
            <div class="modal-form">
                <input type="hidden" id="editingIndex">
                <div class="form-group">
                    <label for="serviceArea">√Årea (m¬≤) ou Quantidade (un)</label>
                    <input type="number" id="serviceArea" step="0.01" placeholder="Ex: 15.5 ou 3">
                </div>
                <div class="form-group">
                    <label for="serviceObs">Observa√ß√µes</label>
                    <input type="text" id="serviceObs" placeholder="Ex: Parede da pia, remover cer√¢mica antiga">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeServiceModal()">Cancelar</button>
                    <button class="btn btn-primary" onclick="saveService()">Salvar Servi√ßo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Galeria de Fotos -->
    <div class="modal-overlay" id="photoGalleryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="photoGalleryTitle">Galeria de Fotos</h3>
                <button class="modal-close-btn" onclick="closePhotoGalleryModal()">&times;</button>
            </div>
            <div class="photo-grid" id="photoGrid"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="document.getElementById('addPhotoInput').click()">
                    <i class="fas fa-camera"></i> Adicionar Foto
                </button>
                <input type="file" id="addPhotoInput" style="display: none;" accept="image/*" multiple>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Ambiente Comum -->
    <div class="modal-overlay" id="locationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Ambiente Comum</h3>
                <button class="modal-close-btn" onclick="closeLocationModal()">&times;</button>
            </div>
            <div id="commonLocationsGrid" class="selection-grid">
                <!-- Bot√µes de ambiente comum ser√£o gerados aqui -->
            </div>
        </div>
    </div>

    <!-- Modal para Carregar Vistoria Online -->
    <div class="modal-overlay" id="loadOnlineModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Carregar Vistoria Online</h3>
                <button class="modal-close-btn" onclick="closeLoadOnlineModal()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="form-group">
                    <label for="inspectionIdInput">ID da Vistoria</label>
                    <input type="text" id="inspectionIdInput" placeholder="Digite o ID...">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeLoadOnlineModal()">Cancelar</button>
                    <button class="btn btn-primary" id="confirmLoadOnlineBtn">Carregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmModalTitle">Confirmar A√ß√£o</h3>
            </div>
            <p id="confirmModalText" style="margin: 20px 0; color: var(--text-light);"></p>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="confirmCancelBtn">Cancelar</button>
                <button class="btn btn-danger" id="confirmOkBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
    // --- CONFIGURA√á√ÉO DA API ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbydwN3L1nOCs2hn9TZqUoEo6aeBzqOlD5eL3w0H6nY3ehB_mvfAs4h4Jtr46nNNkCWyfw/exec";

    // --- CONFIGURA√á√ÉO LOCAL ---
    const config = {
        commonLocations: ["Cozinha", "Sala de Estar", "Sala de Jantar", "Banheiro Social", "Banheiro Su√≠te", "Quarto Principal", "Quarto 2", "√Årea de Servi√ßo", "Varanda/Sacada", "Garagem", "√Årea Externa", "Laje"],
    };

    // --- ESTADO DA APLICA√á√ÉO ---
    let state = {
        inspectionId: null,
        activeLocation: null,
        isEditingDetails: false,
        inspectionData: { 
            clientInfo: {
                name: '',
                address: '',
                date: new Date().toLocaleDateString('pt-BR')
            },
            locations: {},
            serviceCategories: {} // Ser√° preenchido pela API
        },
        modalContext: {},
        onConfirmCallback: null
    };

    // --- ELEMENTOS DO DOM (DECLARA√á√ÉO) ---
    let mainContent, loadingOverlay, inspectionIdDisplay, inspectionDetailsPanel, locationList, newLocationInput, addLocationBtn, workspacePanel, summaryContent, serviceModal, modalTitle, serviceAreaInput, serviceObsInput, editingIndexInput, confirmModal, confirmModalText, confirmCancelBtn, confirmOkBtn, locationModal, loadFileInput, loadOnlineModal, confirmLoadOnlineBtn, inspectionIdInput, photoGalleryModal, photoGalleryTitle, photoGrid, addPhotoInput, mobileHeaderBackBtn, headerContent, moreOptionsToggle, moreOptionsMenu;

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        // INICIALIZA√á√ÉO DOS ELEMENTOS DO DOM
        mainContent = document.getElementById('mainContent');
        loadingOverlay = document.getElementById('loadingOverlay');
        inspectionIdDisplay = document.getElementById('inspectionIdDisplay');
        inspectionDetailsPanel = document.getElementById('inspectionDetailsPanel');
        locationList = document.getElementById('locationList');
        newLocationInput = document.getElementById('newLocationInput');
        addLocationBtn = document.getElementById('addLocationBtn');
        workspacePanel = document.getElementById('workspacePanel');
        summaryContent = document.getElementById('summaryContent');
        serviceModal = document.getElementById('serviceModal');
        modalTitle = document.getElementById('modalTitle');
        serviceAreaInput = document.getElementById('serviceArea');
        serviceObsInput = document.getElementById('serviceObs');
        editingIndexInput = document.getElementById('editingIndex');
        confirmModal = document.getElementById('confirmModal');
        confirmModalText = document.getElementById('confirmModalText');
        confirmCancelBtn = document.getElementById('confirmCancelBtn');
        confirmOkBtn = document.getElementById('confirmOkBtn');
        locationModal = document.getElementById('locationModal');
        loadFileInput = document.getElementById('loadFileInput');
        loadOnlineModal = document.getElementById('loadOnlineModal');
        confirmLoadOnlineBtn = document.getElementById('confirmLoadOnlineBtn');
        inspectionIdInput = document.getElementById('inspectionIdInput');
        photoGalleryModal = document.getElementById('photoGalleryModal');
        photoGalleryTitle = document.getElementById('photoGalleryTitle');
        photoGrid = document.getElementById('photoGrid');
        addPhotoInput = document.getElementById('addPhotoInput');
        mobileHeaderBackBtn = document.getElementById('mobileHeaderBackBtn');
        headerContent = document.querySelector('.header-content');
        moreOptionsToggle = document.getElementById('moreOptionsToggle');
        moreOptionsMenu = document.getElementById('moreOptionsMenu');

        // ADI√á√ÉO DOS EVENT LISTENERS
        addLocationBtn.addEventListener('click', handleAddLocation);
        newLocationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAddLocation();
        });
        
        confirmCancelBtn.addEventListener('click', closeConfirmationModal);
        confirmOkBtn.addEventListener('click', () => {
            if (state.onConfirmCallback) {
                state.onConfirmCallback();
            }
            closeConfirmationModal();
        });
        
        loadFileInput.addEventListener('change', loadInspectionFromFile);
        confirmLoadOnlineBtn.addEventListener('click', handleConfirmLoadOnline);
        addPhotoInput.addEventListener('change', handleAddPhoto);
        mobileHeaderBackBtn.addEventListener('click', () => showLocationsPanel());
        moreOptionsToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            moreOptionsMenu.classList.toggle('active');
        });
        document.addEventListener('click', () => {
             if(moreOptionsMenu.classList.contains('active')) {
                moreOptionsMenu.classList.remove('active');
             }
        });
        
        // CARREGAMENTO INICIAL DOS DADOS
        fetchServiceData();
    });
    
    // --- COMUNICA√á√ÉO COM A API (GOOGLE SHEETS) ---
    async function fetchServiceData() {
        showLoading(true, 'Carregando dados mestre...');
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.status === 'success') {
                state.inspectionData.serviceCategories = result.data;
                renderAll();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            alert('Falha ao carregar os dados da planilha. Verifique a URL do script e as permiss√µes da planilha.');
            console.error('Erro ao buscar dados:', error);
        } finally {
            showLoading(false);
        }
    }

    async function postDataToSheet(action, payload) {
        showLoading(true, 'Salvando na planilha...');
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                body: JSON.stringify({ action, payload })
            });
            setTimeout(fetchServiceData, 2000);
        } catch (error) {
            alert('Falha ao salvar os dados na planilha.');
            console.error('Erro ao postar dados:', error);
            showLoading(false);
        }
    }

    // --- RENDERIZA√á√ÉO PRINCIPAL ---
    function renderAll() {
        inspectionIdDisplay.textContent = state.inspectionId || 'NOVA';
        renderInspectionDetails();
        renderLocationsPanel();
        renderWorkspace();
        renderSummary();
    }

    function renderInspectionDetails() {
        const panel = inspectionDetailsPanel;
        const info = state.inspectionData.clientInfo;
        const isEditing = state.isEditingDetails;
        panel.innerHTML = `
            <div class="detail-item">
                <label>CLIENTE</label>
                <div class="detail-item-value" id="detailName">${isEditing ? `<input type="text" value="${info.name}">` : (info.name || 'N√£o definido')}</div>
            </div>
            <div class="detail-item">
                <label>ENDERE√áO DA OBRA</label>
                <div class="detail-item-value" id="detailAddress">${isEditing ? `<input type="text" value="${info.address}">` : (info.address || 'N√£o definido')}</div>
            </div>
            <div class="detail-item">
                <label>DATA DA VISTORIA</label>
                <div class="detail-item-value" id="detailDate">${isEditing ? `<input type="text" value="${info.date}">` : (info.date || 'N√£o definido')}</div>
            </div>
            <button class="btn btn-secondary btn-edit-details" id="toggleEditDetailsBtn">
                ${isEditing ? '<i class="fas fa-save"></i> Salvar' : '<i class="fas fa-pen"></i> Editar Detalhes'}
            </button>
        `;
        document.getElementById('toggleEditDetailsBtn').addEventListener('click', toggleEditDetails);
    }

    function renderLocationsPanel() {
        locationList.innerHTML = '';
        Object.keys(state.inspectionData.locations).forEach(locationName => {
            const itemCount = state.inspectionData.locations[locationName].length;
            const li = document.createElement('li');
            li.className = `location-item ${state.activeLocation === locationName ? 'active' : ''}`;
            li.dataset.location = locationName;
            
            li.innerHTML = `
                <div class="location-item-main">
                    <span class="location-item-name">${locationName}</span>
                    <span class="location-item-count">${itemCount}</span>
                </div>
                <div class="location-actions">
                    <button class="location-action-btn duplicate-btn" title="Duplicar Ambiente"><i class="fas fa-copy"></i></button>
                    <button class="location-action-btn delete-btn" title="Excluir Ambiente"><i class="fas fa-times-circle"></i></button>
                </div>
            `;

            li.querySelector('.location-item-main').addEventListener('click', () => {
                showWorkspacePanel(locationName);
            });

            li.querySelector('.duplicate-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                duplicateLocation(locationName);
            });

            li.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteLocation(locationName);
            });

            locationList.appendChild(li);
        });
    }

    function renderWorkspace(searchTerm = '') {
        workspacePanel.innerHTML = '';
        if (!state.activeLocation) {
            workspacePanel.innerHTML = `
                <div class="workspace-placeholder">
                    <i class="fas fa-map-marker-alt"></i>
                    <h2>Nenhum ambiente selecionado</h2>
                    <p>Adicione um ambiente √† esquerda ou selecione um existente para come√ßar.</p>
                </div>`;
            return;
        }

        const locationData = state.inspectionData.locations[state.activeLocation];
        
        workspacePanel.innerHTML = `
            <h2 class="workspace-header">Servi√ßos para: ${state.activeLocation}</h2>
            <div class="saved-services-list">
                <h3>Servi√ßos Adicionados</h3>
                <div id="savedServicesContainer"></div>
            </div>
            <div class="add-services-section">
                <h3 style="margin-bottom: 15px;">Adicionar Novo Servi√ßo</h3>
                <div class="search-bar-wrapper">
                    <i class="fas fa-search"></i>
                    <input type="text" id="serviceSearchInput" placeholder="Buscar servi√ßo..." value="${searchTerm}">
                </div>
                <div id="addServicesContainer" style="margin-top: 15px;"></div>
            </div>
        `;

        document.getElementById('serviceSearchInput').addEventListener('input', (e) => renderWorkspace(e.target.value));

        const savedServicesContainer = document.getElementById('savedServicesContainer');
        if (locationData.length === 0) {
            savedServicesContainer.innerHTML = '<p style="color: var(--text-light); margin-top: 10px;">Nenhum servi√ßo adicionado a este ambiente ainda.</p>';
        } else {
            locationData.forEach((service, index) => {
                const categoryLabel = state.inspectionData.serviceCategories[service.category]?.label || service.category;
                const card = document.createElement('div');
                card.className = 'service-card';
                card.innerHTML = `
                    <div class="service-card-details">
                        <div class="service-card-title">
                            ${service.service}
                            <span class="category-badge">${categoryLabel}</span>
                        </div>
                        <div class="service-card-meta">
                            <span><i class="fas fa-ruler-combined"></i> ${service.area || 'N/A'}</span>
                            <span><i class="fas fa-comment"></i> ${service.obs || 'Nenhuma'}</span>
                        </div>
                    </div>
                    <div class="service-card-actions">
                        <button onclick="openPhotoGalleryModal('${state.activeLocation}', ${index})"><i class="fas fa-camera"></i></button>
                        <button onclick="editService(${index})"><i class="fas fa-pen"></i></button>
                        <button class="delete-btn" onclick="deleteService(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                savedServicesContainer.appendChild(card);
            });
        }
        
        const addServicesContainer = document.getElementById('addServicesContainer');
        const lowerSearchTerm = searchTerm.toLowerCase();

        Object.entries(state.inspectionData.serviceCategories).forEach(([catKey, category]) => {
            const filteredItems = category.items.filter(item => item.toLowerCase().includes(lowerSearchTerm));
            const categoryMatch = category.label.toLowerCase().includes(lowerSearchTerm);

            if (categoryMatch || filteredItems.length > 0) {
                addServicesContainer.appendChild(createCategoryAccordion(catKey, category, filteredItems, categoryMatch));
            }
        });

        const addCategoryForm = document.createElement('div');
        addCategoryForm.className = 'add-category-form';
        addCategoryForm.innerHTML = `
            <h4>Criar Nova Categoria de Servi√ßo</h4>
            <div class="add-custom-form">
                <input type="text" id="newCategoryInput" placeholder="Ex: Documenta√ß√£o, Taxas...">
                <button id="addCategoryBtn"><i class="fas fa-plus"></i> Adicionar</button>
            </div>
        `;
        addServicesContainer.appendChild(addCategoryForm);
        document.getElementById('addCategoryBtn').addEventListener('click', addCustomCategory);
        document.getElementById('newCategoryInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') addCustomCategory();
        });
    }

    function createCategoryAccordion(catKey, category, filteredItems, categoryMatch) {
        const accordion = document.createElement('div');
        accordion.className = 'service-category-accordion';
        
        const accordionHeader = document.createElement('div');
        accordionHeader.className = 'accordion-header';
        accordionHeader.innerHTML = `<div class="header-left"><i class="fas ${category.icon}"></i><h4>${category.label}</h4></div><i class="fas fa-chevron-down"></i>`;
        accordionHeader.addEventListener('click', (e) => {
            e.currentTarget.classList.toggle('active');
            e.currentTarget.nextElementSibling.classList.toggle('active');
        });

        const accordionContent = document.createElement('div');
        accordionContent.className = 'accordion-content';

        const itemsToShow = categoryMatch ? category.items : filteredItems;
        itemsToShow.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'service-to-add';
            btn.textContent = item;
            btn.onclick = () => openServiceModal(catKey, item);
            accordionContent.appendChild(btn);
        });

        const customAddForm = document.createElement('div');
        customAddForm.className = 'add-custom-form';
        customAddForm.innerHTML = `
            <input type="text" class="custom-service-input" placeholder="Outro servi√ßo...">
            <button type="button" class="add-custom-btn"><i class="fas fa-plus"></i></button>
        `;
        
        const customInput = customAddForm.querySelector('.custom-service-input');
        const customBtn = customAddForm.querySelector('.add-custom-btn');

        customBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const customServiceName = customInput.value.trim();
            if (customServiceName) {
                postDataToSheet('addService', { categoryKey: catKey, serviceName: customServiceName });
                customInput.value = '';
            }
        });

        customInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                customBtn.click();
            }
        });

        accordionContent.appendChild(customAddForm);
        accordion.appendChild(accordionHeader);
        accordion.appendChild(accordionContent);
        return accordion;
    }

    function renderSummary() {
        if (!summaryContent) return; 
        summaryContent.innerHTML = '';
        const locations = state.inspectionData.locations;
        if (Object.keys(locations).length === 0) {
            summaryContent.innerHTML = '<p>Nenhum ambiente adicionado.</p>';
            return;
        }
        Object.entries(locations).forEach(([locationName, services]) => {
            if (services.length > 0) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-location-item';
                let servicesHtml = services.map(s => {
                    const categoryLabel = state.inspectionData.serviceCategories[s.category]?.label || s.category;
                    const photoCount = s.photos ? s.photos.length : 0;
                    const photoIcon = photoCount > 0 ? ` <i class="fas fa-camera" style="color: var(--text-light);"></i> ${photoCount}` : '';
                    return `<div class="summary-service-item">‚Ä¢ ${s.service} <small>(${categoryLabel})${photoIcon}</small></div>`;
                }).join('');
                itemDiv.innerHTML = `
                    <div class="summary-location-header">${locationName} (${services.length})</div>
                    ${servicesHtml}
                `;
                summaryContent.appendChild(itemDiv);
            }
        });
    }

    // --- DETAILS HANDLING ---
    function toggleEditDetails() {
        if (state.isEditingDetails) {
            // Save
            state.inspectionData.clientInfo.name = document.querySelector('#detailName input').value;
            state.inspectionData.clientInfo.address = document.querySelector('#detailAddress input').value;
            state.inspectionData.clientInfo.date = document.querySelector('#detailDate input').value;
        }
        state.isEditingDetails = !state.isEditingDetails;
        renderInspectionDetails();
    }

    // --- LOCATION & MOBILE NAVIGATION HANDLING ---
    function showWorkspacePanel(locationName) {
        state.activeLocation = locationName;
        mainContent.classList.add('workspace-active');
        mobileHeaderBackBtn.classList.add('visible');
        headerContent.classList.add('hiding');
        renderAll();
    }

    function showLocationsPanel() {
        mainContent.classList.remove('workspace-active');
        mobileHeaderBackBtn.classList.remove('visible');
        headerContent.classList.remove('hiding');
    }

    function handleAddLocation() {
        const locationName = newLocationInput.value.trim();
        if (locationName) {
            addLocation(locationName);
            newLocationInput.value = '';
        } else {
            openLocationModal();
        }
    }

    function addLocation(name) {
        if (name && !state.inspectionData.locations[name]) {
            state.inspectionData.locations[name] = [];
            state.activeLocation = name;
            renderAll();
        }
    }

    function deleteLocation(locationName) {
        showConfirmationModal(`Tem certeza que deseja excluir o ambiente "${locationName}" e todos os seus servi√ßos?`, () => {
            delete state.inspectionData.locations[locationName];
            if (state.activeLocation === locationName) {
                state.activeLocation = null;
                showLocationsPanel();
            }
            renderAll();
        });
    }
    
    function duplicateLocation(locationName) {
        const newName = `${locationName} (c√≥pia)`;
        if (state.inspectionData.locations[newName]) {
            alert(`J√° existe um ambiente chamado "${newName}". Renomeie antes de duplicar novamente.`);
            return;
        }
        const servicesCopy = JSON.parse(JSON.stringify(state.inspectionData.locations[locationName]));
        state.inspectionData.locations[newName] = servicesCopy;
        state.activeLocation = newName;
        renderAll();
    }

    function openLocationModal() {
        const grid = document.getElementById('commonLocationsGrid');
        grid.innerHTML = config.commonLocations.map(loc => `
            <button class="selection-card" data-location="${loc}">
                <i class="fas fa-door-open card-icon"></i>
                <div class="card-title">${loc}</div>
            </button>
        `).join('');

        grid.onclick = function(e) {
            const card = e.target.closest('.selection-card');
            if (card) {
                const locationName = card.dataset.location;
                addLocation(locationName);
                closeLocationModal();
            }
        };
        locationModal.classList.add('visible');
    }

    function closeLocationModal() {
        locationModal.classList.remove('visible');
    }

    // --- SERVICE & CATEGORY HANDLING ---
    function addCustomCategory() {
        const input = document.getElementById('newCategoryInput');
        const categoryName = input.value.trim();
        const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_');

        if (categoryName && !state.inspectionData.serviceCategories[categoryKey]) {
            const payload = {
                key: categoryKey,
                label: categoryName,
                icon: 'fa-star' 
            };
            postDataToSheet('addCategory', payload);
            input.value = '';
        }
    }

    function openServiceModal(category, service, index = null) {
        state.modalContext = { category, service };
        editingIndexInput.value = index !== null ? index : '';
        
        if (index !== null) { // Editing
            const serviceData = state.inspectionData.locations[state.activeLocation][index];
            modalTitle.textContent = `Editar: ${serviceData.service}`;
            serviceAreaInput.value = serviceData.area;
            serviceObsInput.value = serviceData.obs;
        } else { // Adding new
            modalTitle.textContent = `Adicionar: ${service}`;
            serviceAreaInput.value = '';
            serviceObsInput.value = '';
        }
        
        serviceModal.classList.add('visible');
    }

    function closeServiceModal() {
        serviceModal.classList.remove('visible');
    }

    function saveService() {
        const area = serviceAreaInput.value;
        const obs = serviceObsInput.value;
        const index = editingIndexInput.value;
        const { category, service } = state.modalContext;

        if (index !== '') { // Update existing service
            const existingService = state.inspectionData.locations[state.activeLocation][parseInt(index, 10)];
            existingService.area = area;
            existingService.obs = obs;
        } else { // Add new service
            const serviceData = { category, service, area, obs, photos: [], id: Date.now() };
            state.inspectionData.locations[state.activeLocation].push(serviceData);
        }

        closeServiceModal();
        renderAll();
    }
    
    function editService(index) {
        const serviceData = state.inspectionData.locations[state.activeLocation][index];
        openServiceModal(serviceData.category, serviceData.service, index);
    }

    function deleteService(index) {
        showConfirmationModal('Tem certeza que deseja excluir este servi√ßo?', () => {
            state.inspectionData.locations[state.activeLocation].splice(index, 1);
            renderAll();
        });
    }
    
    // --- PHOTO HANDLING ---
    function openPhotoGalleryModal(locationName, serviceIndex) {
        state.modalContext = { locationName, serviceIndex };
        const service = state.inspectionData.locations[locationName][serviceIndex];
        photoGalleryTitle.textContent = `Fotos para: ${service.service}`;
        renderPhotoGrid();
        photoGalleryModal.classList.add('visible');
    }

    function closePhotoGalleryModal() {
        photoGalleryModal.classList.remove('visible');
    }

    function renderPhotoGrid() {
        const { locationName, serviceIndex } = state.modalContext;
        const service = state.inspectionData.locations[locationName][serviceIndex];
        photoGrid.innerHTML = '';
        if (service.photos && service.photos.length > 0) {
            service.photos.forEach((photoData, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'photo-thumbnail';
                thumb.innerHTML = `
                    <img src="${photoData}" alt="Foto ${index + 1}">
                    <button class="photo-delete-btn" onclick="deletePhoto(${index})"><i class="fas fa-times"></i></button>
                `;
                photoGrid.appendChild(thumb);
            });
        } else {
            photoGrid.innerHTML = '<p>Nenhuma foto adicionada.</p>';
        }
    }

    function handleAddPhoto(event) {
        const files = event.target.files;
        if (!files) return;

        showLoading(true, 'Processando fotos...');
        const { locationName, serviceIndex } = state.modalContext;
        const service = state.inspectionData.locations[locationName][serviceIndex];
        if (!service.photos) service.photos = [];

        let filesProcessed = 0;
        Array.from(files).forEach(file => {
            resizeImage(file, 1024, 1024, 0.7).then(dataUrl => {
                service.photos.push(dataUrl);
                filesProcessed++;
                if (filesProcessed === files.length) {
                    showLoading(false);
                    renderPhotoGrid();
                    renderSummary();
                }
            });
        });
        addPhotoInput.value = ''; // Reset input
    }

    function resizeImage(file, maxWidth, maxHeight, quality) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
    
    function deletePhoto(photoIndex) {
        const { locationName, serviceIndex } = state.modalContext;
        state.inspectionData.locations[locationName][serviceIndex].photos.splice(photoIndex, 1);
        renderPhotoGrid();
        renderSummary();
    }


    // --- GENERIC MODAL & UI HANDLING ---
    function showConfirmationModal(text, callback) {
        confirmModalText.textContent = text;
        state.onConfirmCallback = callback;
        confirmModal.classList.add('visible');
    }

    function closeConfirmationModal() {
        confirmModal.classList.remove('visible');
        state.onConfirmCallback = null;
    }
    
    function showLoading(show, message = 'Carregando...') {
        loadingOverlay.querySelector('p').textContent = message;
        loadingOverlay.classList.toggle('hidden', !show);
    }
    
    function openLoadOnlineModal() {
        inspectionIdInput.value = '';
        loadOnlineModal.classList.add('visible');
    }
    
    function closeLoadOnlineModal() {
        loadOnlineModal.classList.remove('visible');
    }

    // --- ONLINE/OFFLINE SAVE/LOAD & TEMPLATE ACTIONS ---
    async function saveInspectionOnline() {
        showLoading(true, 'Salvando vistoria na nuvem...');
        try {
            const payload = { id: state.inspectionId, data: state.inspectionData };
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8', },
                body: JSON.stringify({ action: 'saveInspection', payload })
            });
            const result = await response.json();
            if (result.status === 'success') {
                state.inspectionId = result.newId;
                alert(`Vistoria salva com sucesso! ID: ${state.inspectionId}`);
                renderAll();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            alert('Falha ao salvar a vistoria online.');
            console.error('Erro ao salvar vistoria:', error);
        } finally {
            showLoading(false);
        }
    }

    async function handleConfirmLoadOnline() {
        const idToLoad = inspectionIdInput.value.trim();
        if (!idToLoad) return;
        
        closeLoadOnlineModal();
        showLoading(true, `Carregando vistoria ${idToLoad}...`);
        try {
            const loadUrl = `${SCRIPT_URL}?action=load&id=${idToLoad}`;
            const response = await fetch(loadUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();

            if (result.status === 'success') {
                state.inspectionData = result.data;
                state.inspectionId = idToLoad.toUpperCase();
                state.activeLocation = Object.keys(result.data.locations)[0] || null;
                renderAll();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            alert(`Falha ao carregar a vistoria: ${error.message}`);
            console.error('Erro ao carregar vistoria:', error);
        } finally {
            showLoading(false);
        }
    }

    function saveInspectionToFile() {
        const dataStr = JSON.stringify({inspectionId: state.inspectionId, inspectionData: state.inspectionData}, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `vistoria-${state.inspectionId || 'backup'}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function loadInspectionFromFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loaded = JSON.parse(e.target.result);
                if (loaded.inspectionData && loaded.inspectionData.clientInfo) {
                    state.inspectionData = loaded.inspectionData;
                    state.inspectionId = loaded.inspectionId;
                    state.activeLocation = Object.keys(loaded.inspectionData.locations)[0] || null;
                    renderAll();
                } else {
                    alert('Arquivo de vistoria inv√°lido ou corrompido.');
                }
            } catch (error) {
                alert('Erro ao carregar o arquivo. Verifique se √© um arquivo JSON v√°lido.');
                console.error("Erro ao parsear JSON:", error);
            }
        };
        reader.readAsText(file);
    }
    
    function startFromTemplate() {
        if (!state.inspectionId) {
            alert("Por favor, primeiro carregue uma vistoria para usar como modelo.");
            return;
        }
        
        showConfirmationModal("Isso criar√° uma nova vistoria usando a estrutura da atual. Os dados do cliente, ID e detalhes dos servi√ßos ser√£o limpos. Deseja continuar?", () => {
            state.inspectionId = null;
            state.inspectionData.clientInfo = { name: '', address: '', date: new Date().toLocaleDateString('pt-BR') };
            
            Object.keys(state.inspectionData.locations).forEach(loc => {
                state.inspectionData.locations[loc].forEach(service => {
                    service.area = '';
                    service.obs = '';
                    service.photos = [];
                });
            });
            
            state.activeLocation = Object.keys(state.inspectionData.locations)[0] || null;
            renderAll();
        });
    }

    // --- PDF REPORT ACTION ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const data = state.inspectionData;
        let y = 15; // Posi√ß√£o vertical inicial

        // T√≠tulo
        doc.setFontSize(18);
        doc.text("Relat√≥rio de Vistoria - Maeoka Engenharia", 105, y, { align: 'center' });
        y += 10;
        
        doc.setFontSize(10);
        doc.text(`ID da Vistoria: ${state.inspectionId || 'N/A'}`, 195, y, { align: 'right' });
        y += 5;


        // Detalhes do Cliente
        doc.setFontSize(12);
        doc.text(`Cliente: ${data.clientInfo.name || 'N√£o definido'}`, 15, y);
        y += 7;
        doc.text(`Endere√ßo: ${data.clientInfo.address || 'N√£o definido'}`, 15, y);
        y += 7;
        doc.text(`Data: ${data.clientInfo.date || 'N√£o definido'}`, 15, y);
        y += 15;

        // Linha separadora
        doc.line(15, y - 5, 195, y - 5);

        // Ambientes e Servi√ßos
        Object.entries(data.locations).forEach(([locationName, services]) => {
            if (services.length > 0) {
                if (y > 270) {
                    doc.addPage();
                    y = 15;
                }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Ambiente: ${locationName}`, 15, y);
                y += 8;
                doc.setFont(undefined, 'normal');

                services.forEach(service => {
                    if (y > 280) {
                        doc.addPage();
                        y = 15;
                    }
                    doc.setFontSize(11);
                    const categoryLabel = data.serviceCategories[service.category]?.label || service.category;
                    let serviceText = `- ${service.service} (${categoryLabel})`;
                    
                    let details = [];
                    if(service.area) details.push(`√Årea/Qtd: ${service.area}`);
                    if(service.obs) details.push(`Obs: ${service.obs}`);
                    
                    doc.text(serviceText, 20, y);
                    if(details.length > 0) {
                        y += 5;
                        doc.setFontSize(9);
                        doc.setTextColor(100);
                        doc.text(details.join(' | '), 25, y);
                        doc.setTextColor(0);
                    }
                    y += 7;
                });
                y += 5;
            }
        });

        // Adicionar fotos em p√°ginas separadas
        Object.entries(data.locations).forEach(([locationName, services]) => {
            services.forEach(service => {
                if (service.photos && service.photos.length > 0) {
                    doc.addPage();
                    y = 15;
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Fotos para: ${service.service} (${locationName})`, 15, y);
                    y += 10;
                    
                    let x = 15;
                    service.photos.forEach((photoData, index) => {
                        if (y > 240) { // Verifica se cabe na p√°gina
                            doc.addPage();
                            y = 15;
                            x = 15;
                        }
                        try {
                            doc.addImage(photoData, 'JPEG', x, y, 80, 80);
                            x += 90; // Move para a direita para a pr√≥xima foto
                            if (x > 105) { // Se n√£o couber mais na linha, quebra
                                x = 15;
                                y += 90;
                            }
                        } catch (e) {
                            console.error("Erro ao adicionar imagem ao PDF:", e);
                            doc.text("Erro ao carregar imagem.", x, y);
                        }
                    });
                }
            });
        });


        doc.save(`Vistoria - ${data.clientInfo.name || 'Relatorio'}.pdf`);
    }

    </script>
</body>
</html>
